<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Verificador de Deployment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .status-box {
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    .success {
      background-color: #d4edda;
      border-color: #28a745;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }
    .warning {
      background-color: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }
    .info {
      background-color: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }
    h1 { color: #333; }
    h2 { color: #555; margin-top: 30px; }
    code {
      background-color: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    pre {
      background-color: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .step {
      margin: 15px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-left: 4px solid #17a2b8;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h1>üîç Verificador de Deployment - Bit√°cora v3.0</h1>
  
  <div class="info status-box">
    <h3>üìã Prop√≥sito</h3>
    <p>Esta herramienta verifica que tu deployment Web App est√© usando la versi√≥n m√°s reciente del c√≥digo.</p>
  </div>

  <button onclick="verificarCodigoLocal()">1Ô∏è‚É£ Verificar C√≥digo Local</button>
  <button onclick="verificarDeployment()">2Ô∏è‚É£ Verificar Deployment Web App</button>
  
  <div id="loading">
    <p>‚è≥ Verificando...</p>
  </div>

  <div id="resultadoLocal"></div>
  <div id="resultadoDeployment"></div>
  <div id="instrucciones"></div>

  <script>
    function verificarCodigoLocal() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultadoLocal').innerHTML = '';
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('loading').style.display = 'none';
          
          let html = '<div class="success status-box">';
          html += '<h3>‚úÖ C√ìDIGO LOCAL - OK</h3>';
          html += '<p><strong>Versi√≥n:</strong> ' + result.version + '</p>';
          html += '<p><strong>Timestamp:</strong> ' + result.timestamp + '</p>';
          html += '<p><strong>SPREADSHEET_ID:</strong> ' + (result.spreadsheetIdConfigured ? '‚úÖ Configurado' : '‚ùå NO configurado') + '</p>';
          if (result.spreadsheetIdConfigured) {
            html += '<p><strong>Valor:</strong> <code>' + result.spreadsheetIdValue + '</code></p>';
          }
          html += '<p>' + result.message + '</p>';
          html += '</div>';
          
          html += '<div class="warning status-box">';
          html += '<h3>‚ö†Ô∏è SIGUIENTE PASO</h3>';
          html += '<p>El c√≥digo local est√° actualizado. Ahora verifica el deployment Web App usando el bot√≥n "2Ô∏è‚É£ Verificar Deployment Web App".</p>';
          html += '<p><strong>IMPORTANTE:</strong> Si el deployment devuelve una versi√≥n diferente o error, necesitas actualizar el deployment.</p>';
          html += '</div>';
          
          document.getElementById('resultadoLocal').innerHTML = html;
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').style.display = 'none';
          
          let html = '<div class="error status-box">';
          html += '<h3>‚ùå ERROR</h3>';
          html += '<p>' + error.message + '</p>';
          html += '</div>';
          
          document.getElementById('resultadoLocal').innerHTML = html;
        })
        .getDeploymentVersion();
    }
    
    function verificarDeployment() {
      let url = prompt('Pega la URL de tu deployment Web App:\n(Ejemplo: https://script.google.com/macros/s/ABC123.../exec)');
      
      if (!url) {
        alert('‚ùå URL no proporcionada');
        return;
      }
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultadoDeployment').innerHTML = '';
      
      // Agregar par√°metro para llamar a la funci√≥n de verificaci√≥n
      let testUrl = url + '?action=checkVersion';
      
      fetch(testUrl, {
        redirect: 'follow'
      })
      .then(response => response.text())
      .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        // Intentar parsear como JSON
        try {
          let result = JSON.parse(data);
          mostrarResultadoDeployment(result, true);
        } catch (e) {
          // No es JSON, probablemente HTML del portal
          mostrarResultadoDeployment({ error: 'El deployment no responde con la versi√≥n esperada' }, false);
        }
      })
      .catch(error => {
        document.getElementById('loading').style.display = 'none';
        mostrarResultadoDeployment({ error: error.message }, false);
      });
    }
    
    function mostrarResultadoDeployment(result, exito) {
      let html = '';
      
      if (exito && result.version) {
        html += '<div class="success status-box">';
        html += '<h3>‚úÖ DEPLOYMENT - OK</h3>';
        html += '<p><strong>Versi√≥n:</strong> ' + result.version + '</p>';
        html += '<p><strong>SPREADSHEET_ID:</strong> ' + (result.spreadsheetIdConfigured ? '‚úÖ Configurado' : '‚ùå NO configurado') + '</p>';
        html += '</div>';
        
        html += '<div class="success status-box">';
        html += '<h3>üéâ ¬°TODO LISTO!</h3>';
        html += '<p>El deployment est√° usando la versi√≥n correcta del c√≥digo.</p>';
        html += '<p>Ahora puedes abrir la bit√°cora en el portal y deber√≠a funcionar correctamente.</p>';
        html += '</div>';
      } else {
        html += '<div class="error status-box">';
        html += '<h3>‚ùå DEPLOYMENT - DESACTUALIZADO</h3>';
        html += '<p>El deployment NO est√° usando la versi√≥n m√°s reciente del c√≥digo.</p>';
        html += '<p><strong>Error:</strong> ' + (result.error || 'Versi√≥n incorrecta') + '</p>';
        html += '</div>';
        
        html += mostrarInstruccionesActualizacion();
      }
      
      document.getElementById('resultadoDeployment').innerHTML = html;
    }
    
    function mostrarInstruccionesActualizacion() {
      let html = '<div class="warning status-box">';
      html += '<h3>üîß C√ìMO ACTUALIZAR EL DEPLOYMENT</h3>';
      
      html += '<div class="step">';
      html += '<h4>PASO 1: Eliminar Deployments Viejos</h4>';
      html += '<ol>';
      html += '<li>En Apps Script Editor, click en <strong>"Implementar"</strong> (arriba a la derecha)</li>';
      html += '<li>Click en <strong>"Gestionar implementaciones"</strong></li>';
      html += '<li>Para CADA deployment en la lista:';
      html += '<ul><li>Click en los 3 puntos (‚ãÆ)</li>';
      html += '<li>Click en <strong>"Archivar"</strong></li></ul></li>';
      html += '<li>Aseg√∫rate de que la lista quede <strong>VAC√çA</strong></li>';
      html += '</ol>';
      html += '</div>';
      
      html += '<div class="step">';
      html += '<h4>PASO 2: Crear Deployment NUEVO</h4>';
      html += '<ol>';
      html += '<li>En Apps Script Editor, click en <strong>"Implementar"</strong></li>';
      html += '<li>Click en <strong>"Nueva implementaci√≥n"</strong></li>';
      html += '<li>Click en el ‚öôÔ∏è junto a "Seleccionar tipo"</li>';
      html += '<li>Selecciona <strong>"Aplicaci√≥n web"</strong></li>';
      html += '<li>Configuraci√≥n:';
      html += '<ul>';
      html += '<li><strong>Descripci√≥n:</strong> <code>Bit√°cora v4.0 FINAL - 2025-01-15</code></li>';
      html += '<li><strong>Ejecutar como:</strong> Yo (tu email)</li>';
      html += '<li><strong>Qui√©n tiene acceso:</strong> Cualquier persona</li>';
      html += '</ul></li>';
      html += '<li>Click en <strong>"Implementar"</strong></li>';
      html += '<li><strong>COPIA LA URL NUEVA</strong> que aparece</li>';
      html += '</ol>';
      html += '</div>';
      
      html += '<div class="step">';
      html += '<h4>PASO 3: Probar</h4>';
      html += '<ol>';
      html += '<li>Cierra TODAS las ventanas del portal</li>';
      html += '<li>Abre <strong>ventana de inc√≥gnito</strong></li>';
      html += '<li>Pega la URL nueva</li>';
      html += '<li>Inicia sesi√≥n</li>';
      html += '<li>Abre la bit√°cora</li>';
      html += '</ol>';
      html += '</div>';
      
      html += '</div>';
      
      return html;
    }
  </script>
</body>
</html>

