<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transperuana ¬∑ Portal Cobranzas</title>

    <!-- Incluir el archivo de estilos -->
    <?!= include('styles'); ?>

</head>

<body>
    <!-- LOGIN -->
    <section id="loginSection" class="login-container">
        <div class="login-card">
            <img src="https://i.imgur.com/RUhA0kt.png" alt="Transperuana Logo" class="login-logo" />
            <h1 class="login-title">Portal Cobranzas</h1>
            <form id="loginForm" onsubmit="return handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="username">Usuario</label>
                    <input type="text" id="username" placeholder="cobranzas1" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Contrase√±a</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">
                    <span id="loginBtnText">Iniciar sesi√≥n</span>
                    <span id="loginSpinner" class="spinner hidden"></span>
                </button>
                <div id="loginError" class="status status-error hidden" style="margin-top: 1rem"></div>
            </form>
        </div>
    </section>

    <!-- LOADING -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem"></div>
            <div id="loadingText">Cargando...</div>
        </div>
    </div>

    <!-- PORTAL -->
    <div id="portalSection" class="hidden app-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://i.imgur.com/RUhA0kt.png" alt="Transperuana Logo" class="sidebar-logo" />
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchView('actualizar')" id="nav-actualizar">
                    <span class="nav-icon">üì§</span>
                    <span>Actualizar Base</span>
                </div>
                <div class="nav-item" onclick="switchView('generar')" id="nav-generar">
                    <span class="nav-icon">üìÑ</span>
                    <span>Generar EECC</span>
                </div>
                <div class="nav-item" onclick="switchView('enviar')" id="nav-enviar">
                    <span class="nav-icon">üìß</span>
                    <span>Enviar Correos</span>
                </div>
                <div class="nav-item" onclick="switchView('bitacora')" id="nav-bitacora">
                    <span class="nav-icon">üìù</span>
                    <span>Bit√°cora</span>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div style="font-size: var(--tp-text-sm); font-weight: 500;">
                        <span id="sidebarUser">Usuario</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="handleLogout()" style="width: 100%; font-size: 0.8125rem;">
                    Cerrar sesi√≥n
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="topbar">
                <div class="header-title" style="font-size: 1.25rem;">
                    Portal Cobranzas
                </div>
                <div class="header-right">
                    <div class="notification-container">
                        <button class="btn-notification" id="btnNotificaciones" onclick="toggleNotificaciones()"
                            title="Notificaciones de compromisos de pago">
                            <span class="notification-icon">üîî</span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>

                        <!-- Panel de notificaciones -->
                        <div class="notification-panel" id="notificationPanel">
                            <div class="notification-header">
                                <h3>üîî Recordatorios de Compromisos</h3>
                                <button class="btn-close-notification" onclick="toggleNotificaciones()">√ó</button>
                            </div>
                            <div class="notification-body" id="notificationBody">
                                <div class="notification-loading">
                                    <div class="loader-spinner"></div>
                                    <p>Cargando notificaciones...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="main-scroll" id="mainScroll">

                <!-- VIEW: DASHBOARD (Default) -->
                <div id="view-dashboard" class="view-section active">
                    <!-- DASHBOARD ANAL√çTICO -->
                    <section class="pbi-section" id="pbi-embed">
                        <div class="pbi-toggle collapsed" onclick="togglePowerBI()">
                            <div class="pbi-toggle-left">
                                <div>
                                    <h2 class="pbi-toggle-title">üìä Dashboard Anal√≠tico</h2>
                                    <p class="pbi-toggle-subtitle">Visualiza m√©tricas y an√°lisis de cobranzas en tiempo
                                        real</p>
                                </div>
                            </div>
                            <div class="pbi-toggle-icon">‚ñº</div>
                        </div>
                        <div class="pbi-content" id="pbiContent">
                            <div class="pbi-container" style="min-height: 600px; height: 70vh;">
                                <iframe id="pbiFrame" class="pbi-iframe" src="" frameborder="0" allowfullscreen
                                    style="width: 100%; height: 100%;"></iframe>
                            </div>
                        </div>
                    </section>

                    <!-- PHASE 3: DASHBOARD STATS WIDGET -->
                    <section id="dashboardStatsSection" class="card" style="margin-bottom: 1rem; margin-top: 1rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1rem; color: var(--tp-text-primary);">üìä M√©tricas del
                                Sistema</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span id="statsLastUpdated"
                                    style="font-size: 0.75rem; color: var(--tp-text-muted);">Cargando...</span>
                                <button onclick="refreshDashboardStats()" class="btn btn-sm"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">üîÑ</button>
                            </div>
                        </div>
                        <div id="statsGrid"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                            <div class="stat-card"
                                style="background: var(--tp-bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--tp-primary);"
                                    id="statEeccToday">-</div>
                                <div style="font-size: 0.75rem; color: var(--tp-text-muted);">EECC Hoy</div>
                            </div>
                            <div class="stat-card"
                                style="background: var(--tp-bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--tp-primary);"
                                    id="statEeccWeek">-</div>
                                <div style="font-size: 0.75rem; color: var(--tp-text-muted);">EECC Semana</div>
                            </div>
                            <div class="stat-card"
                                style="background: var(--tp-bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2e7d32;" id="statMailSent">-
                                </div>
                                <div style="font-size: 0.75rem; color: var(--tp-text-muted);">Enviados 24h</div>
                            </div>
                            <div class="stat-card"
                                style="background: var(--tp-bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #EF6C00;" id="statMailQueued">-
                                </div>
                                <div style="font-size: 0.75rem; color: var(--tp-text-muted);">En Cola</div>
                            </div>
                            <div class="stat-card"
                                style="background: var(--tp-bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #C62828;" id="statErrors">-
                                </div>
                                <div style="font-size: 0.75rem; color: var(--tp-text-muted);">Errores 24h</div>
                            </div>
                        </div>
                    </section>

                    <!-- PHASE 3: QUEUE HEALTH PANEL -->
                    <section id="queueHealthSection" class="card" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                            onclick="toggleQueueHealthPanel()">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span id="queueHealthIndicator" style="font-size: 1.25rem;">‚è≥</span>
                                <h3 style="margin: 0; font-size: 1rem; color: var(--tp-text-primary);">Estado de Cola de
                                    Correos</h3>
                                <span id="queueHealthBadge" class="badge"
                                    style="font-size: 0.7rem; padding: 2px 8px;">Cargando...</span>
                            </div>
                            <span id="queueHealthToggleIcon"
                                style="font-size: 0.8rem; color: var(--tp-text-muted);">‚ñº</span>
                        </div>
                        <div id="queueHealthDetails"
                            style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--tp-border-light);">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; font-size: 0.85rem;">
                                <div><strong>Pendientes:</strong> <span id="qhPending">-</span></div>
                                <div><strong>Procesando:</strong> <span id="qhProcessing">-</span></div>
                                <div><strong>Fallidos 24h:</strong> <span id="qhFailed">-</span></div>
                                <div><strong>M√°s antiguo:</strong> <span id="qhOldest">-</span></div>
                                <div><strong>√öltimo procesado:</strong> <span id="qhLastProcessed">-</span></div>
                            </div>
                            <div id="qhReasons" style="margin-top: 0.75rem; color: #C62828; font-size: 0.8rem;"></div>
                        </div>
                    </section>

                    <!-- SHORTCUTS (Original Cards, but smaller or grid) -->
                    <h2 class="section-title" style="margin-top: 2rem;">Accesos Directos</h2>
                    <div class="grid">
                        <div class="card" onclick="switchView('actualizar')" style="cursor: pointer;">
                            <h3 class="card-title">üì§ Actualizar Base</h3>
                            <p class="text-muted">Sube archivos Excel/CSV</p>
                        </div>
                        <div class="card" onclick="switchView('generar')" style="cursor: pointer;">
                            <h3 class="card-title">üìÑ Generar EECC</h3>
                            <p class="text-muted">Crea estados de cuenta</p>
                        </div>
                        <div class="card" onclick="switchView('enviar')" style="cursor: pointer;">
                            <h3 class="card-title">üìß Enviar Correos</h3>
                            <p class="text-muted">Env√≠o masivo de EECC</p>
                        </div>
                        <div class="card" onclick="switchView('bitacora')" style="cursor: pointer;">
                            <h3 class="card-title">üìù Bit√°cora</h3>
                            <p class="text-muted">Gestiona seguimientos</p>
                        </div>
                    </div>

                    <!-- Activity Log remains in Dashboard -->
                    <div class="card" style="margin-top: 2rem;">
                        <h2 class="card-title">üìã Registro de Actividad Reciente</h2>
                        <div id="activityLog" class="activity-log">
                            <div class="log-entry log-info"><span>--:--:--</span> ‚Ä¢ Esperando actividad...</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: ACTUALIZAR -->
                <div id="view-actualizar" class="view-section">
                    <h2 class="text-2xl font-bold mb-6">üì§ Actualizar Base de Datos</h2>
                    <div class="card">
                        <div class="form-group">
                            <label class="form-label" for="fileInput">Archivo Excel o CSV</label>
                            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;">
                                Se deduplicar√° autom√°ticamente por CUP√ìN. Aceptamos .xlsx, .xls y .csv.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="hasHeader" checked>
                                El archivo tiene encabezados
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="handleUpload()" id="uploadBtn">
                            üì§ Subir y actualizar
                        </button>
                        <div id="uploadStatus"></div>

                        <!-- Log de actividad de carga -->
                        <div id="uploadActivityLog" class="activity-log"
                            style="margin-top: 1.5rem; max-height: 300px; overflow-y: auto; display: none;">
                            <h4 style="margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--tp-text-secondary);">üìã
                                Log de actividad:</h4>
                            <div id="uploadLogEntries"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: GENERAR EECC -->
                <div id="view-generar" class="view-section">
                    <h2 class="text-2xl font-bold mb-6">üìÑ Generar Estado de Cuenta</h2>
                    <div class="card">
                        <div class="form-group">
                            <!-- GRUPO_ECONOMICO - Selector de Modo -->
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; justify-content: flex-start;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="eeccMode" value="asegurado" checked
                                        onchange="toggleEECCMode()">
                                    <span>üë§ Por Asegurado</span>
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="eeccMode" value="grupo" onchange="toggleEECCMode()">
                                    <span>üë• Por Grupo</span>
                                </label>
                            </div>

                            <!-- Componente Autocomplete para EECC -->
                            <div class="autocomplete-wrapper" style="max-width: 600px;">
                                <div class="autocomplete-input-container">
                                    <span class="autocomplete-icon">üîç</span>
                                    <input type="text" id="aseguradoSelect" class="autocomplete-input"
                                        placeholder="Escribe o selecciona un cliente..." autocomplete="off"
                                        oninput="filtrarAutocompleteEECC()"
                                        onfocus="mostrarDropdownAutocompleteEECC()" />
                                    <button type="button" class="autocomplete-dropdown-btn"
                                        onclick="toggleDropdownAutocompleteEECC()" title="Ver todas las opciones">
                                        ‚ñº
                                    </button>
                                    <button type="button" class="autocomplete-clear-btn" id="clearAseguradoEECC"
                                        onclick="limpiarAutocompleteEECC()" style="display: none;"
                                        title="Limpiar selecci√≥n">
                                        ‚úï
                                    </button>
                                </div>
                                <div id="autocompleteDropdownEECC" class="autocomplete-dropdown" style="display: none;">
                                    <div id="autocompleteCounterEECC" class="autocomplete-counter"
                                        style="display: none;"></div>
                                    <div id="autocompleteOptionsEECC" class="autocomplete-options"></div>
                                </div>

                                <div class="btn-group" style="margin-top: 1rem;">
                                    <button class="btn btn-secondary" id="previewBtn" onclick="handlePreview()">üëÅ
                                        Previsualizar</button>
                                    <button class="btn btn-secondary" onclick="toggleObs()" id="obsBtn">üìù Agregar
                                        OBS</button>
                                </div>

                                <div class="form-group" style="margin-top: 1rem; margin-bottom: 0;">
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="exportType" value="both" checked>
                                            <span>üìÑüìä PDF + XLSX</span>
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="exportType" value="pdf">
                                            <span>üìÑ Solo PDF</span>
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="exportType" value="xlsx">
                                            <span>üìä Solo XLSX</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="ramSelectContainer" class="form-group hidden" style="margin-top: 1rem;">
                                    <label class="form-label" for="ramSelect">Seleccionar RAM para OBS</label>
                                    <select id="ramSelect" multiple size="6">
                                        <option value="__ALL__" selected>Todos los RAM</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="handleGenerate()" id="generateBtn" disabled
                                    style="margin-top: 1rem; width: 100%;">
                                    ‚öô Generar EECC
                                </button>
                                <div id="generateStatus"></div>

                                <div id="downloadLinks" class="hidden generated-files-card expanded"
                                    style="margin-top: 1rem;">
                                    <div class="generated-files-header" onclick="toggleGeneratedFiles()">
                                        <div class="generated-files-title">
                                            <span>Archivos generados:</span>
                                            <span id="generatedCountBadge"
                                                class="badge badge-sm badge-outline hidden">0</span>
                                        </div>
                                        <div class="generated-files-toggle-icon">‚ñº</div>
                                    </div>
                                    <div class="generated-files-body">
                                        <div id="linksContainer"></div>
                                    </div>
                                    <div id="generatedFilesFooter" class="generated-files-footer hidden">
                                        <!-- El bot√≥n ZIP se inyectar√° aqu√≠ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PREVIEW TABLE (Moved here) -->
                    <div id="previewSection" class="card hidden" style="margin-top: 2rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem">
                            <h3 style="margin: 0">Pre-visualizaci√≥n de datos</h3>
                            <span id="previewCount" class="text-muted">0 registros</span>
                        </div>
                        <div class="table-container">
                            <table id="previewTable">
                                <thead id="previewTableHead"></thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                        </div>
                        <p class="text-muted" style="margin-top: 1rem">
                            Selecciona las filas que deseas excluir de la generaci√≥n
                        </p>
                    </div>
                </div>

                <!-- VIEW: ENVIAR (INLINE - NO POPUP) -->
                <div id="view-enviar" class="view-section">
                    <h2 class="text-2xl font-bold mb-6">üìß Enviar EECC por Correo</h2>
                    <div id="enviarInlineHost" class="inline-module-host inline-render-mode"
                        style="min-height: 500px; background: var(--tp-surface-overlay); border-radius: 12px; border: 1px solid var(--tp-border-light);">
                        <div class="module-loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--tp-text-secondary);">
                            <div class="spinner"
                                style="width: 40px; height: 40px; border: 3px solid var(--tp-border-light); border-top-color: var(--tp-primary); border-radius: 50%; animation: spin 1s linear infinite;">
                            </div>
                            <p style="margin-top: 1rem;">Cargando m√≥dulo de env√≠o...</p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: BITACORA (EMBEBIDO v15 - NO POPUP) -->
                <div id="view-bitacora" class="view-section">
                    <h2 class="text-2xl font-bold mb-4">üìù Bit√°cora de Gestiones de Cobranzas</h2>
                    <p class="text-muted mb-4" style="font-size: 0.875rem;">
                        Registra y consulta el seguimiento de todas las gestiones realizadas
                    </p>

                    <!-- TABS v15 -->
                    <div class="bitacora-tabs"
                        style="display: flex; border-bottom: 2px solid var(--tp-border-light); margin-bottom: 1.5rem;">
                        <button class="bitacora-tab active" onclick="switchBitacoraTabEmbedded('estado')"
                            id="bitacora-tab-btn-estado"
                            style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--tp-primary); border-bottom: 3px solid var(--tp-primary); margin-bottom: -2px;">
                            üìä Estado Actual
                        </button>
                        <button class="bitacora-tab" onclick="switchBitacoraTabEmbedded('registrar')"
                            id="bitacora-tab-btn-registrar"
                            style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--tp-text-secondary);">
                            ‚úçÔ∏è Registrar Gesti√≥n
                        </button>
                    </div>

                    <!-- PHASE 5: QUICK ACTIONS BAR (only if QUICK_ACTIONS_ENABLED) -->
                    <div id="quickActionsBar" class="quick-actions-bar"
                        style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #FFF3E0 0%, #FFECB3 100%); border-radius: 8px; border: 1px solid #FFE0B2;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #E65100; font-size: 0.875rem;">‚ö° Acciones
                                r√°pidas:</span>
                            <button class="btn btn-sm quick-action-btn" onclick="executeQuickAction('llamada_sin_resp')"
                                style="background: white; border: 1px solid #FFB74D; color: #E65100;">üìû Sin
                                respuesta</button>
                            <button class="btn btn-sm quick-action-btn" onclick="executeQuickAction('whatsapp_enviado')"
                                style="background: white; border: 1px solid #FFB74D; color: #E65100;">üí¨
                                WhatsApp</button>
                            <button class="btn btn-sm quick-action-btn" onclick="executeQuickAction('correo_leido')"
                                style="background: white; border: 1px solid #FFB74D; color: #E65100;">üìß Correo</button>
                            <button class="btn btn-sm quick-action-btn" onclick="executeQuickAction('compromiso_pago')"
                                style="background: white; border: 1px solid #FFB74D; color: #E65100;">‚úÖ
                                Compromiso</button>
                            <button class="btn btn-sm quick-action-btn" onclick="executeQuickAction('no_contactable')"
                                style="background: white; border: 1px solid #FFB74D; color: #E65100;">‚ùå No
                                contactable</button>
                        </div>
                    </div>

                    <!-- TAB 1: ESTADO ACTUAL -->
                    <div id="bitacora-embedded-estado" class="bitacora-pane">
                        <!-- Filtros -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--tp-surface-secondary); border-radius: 8px;">
                            <div class="form-group mb-0">
                                <label class="form-label" for="filtroAseguradoEmb">üè¢ Asegurado / Cliente</label>
                                <select id="filtroAseguradoEmb" onchange="filtrarBitacoraEmbedded()"
                                    style="width: 100%;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="filtroEstadoEmb">üìå Estado de Gesti√≥n</label>
                                <select id="filtroEstadoEmb" onchange="filtrarBitacoraEmbedded()" style="width: 100%;">
                                    <option value="">Todos los estados</option>
                                    <option value="SIN_RESPUESTA">‚ùå Sin respuesta</option>
                                    <option value="EN_SEGUIMIENTO">üëÅÔ∏è En seguimiento</option>
                                    <option value="COMPROMISO_PAGO">ü§ù Compromiso de pago</option>
                                    <option value="CERRADO_PAGADO">‚úÖ Cerrado/Pagado</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="filtroResponsableEmb">üë§ Responsable</label>
                                <select id="filtroResponsableEmb" onchange="filtrarBitacoraEmbedded()"
                                    style="width: 100%;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="filtroDiasEmb">üìÖ Antig√ºedad</label>
                                <select id="filtroDiasEmb" onchange="filtrarBitacoraEmbedded()" style="width: 100%;">
                                    <option value="">Todos los per√≠odos</option>
                                    <option value="0-7">üìó Reciente (0-7 d√≠as)</option>
                                    <option value="8-30">üìô Medio (8-30 d√≠as)</option>
                                    <option value="31-60">üìï Antiguo (31-60 d√≠as)</option>
                                    <option value="61-">‚ö†Ô∏è Cr√≠tico (+60 d√≠as)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tabla -->
                        <div class="table-container"
                            style="overflow-x: auto; border-radius: 8px; border: 1px solid var(--tp-border-light);">
                            <table id="bitacoraTableEmb" style="width: 100%; border-collapse: collapse;">
                                <thead
                                    style="background: #E5E7EB; color: #374151; position: sticky; top: 0; z-index: 5;">
                                    <tr>
                                        <th
                                            style="padding: 8px 10px; text-align: left; font-weight: 600; font-size: 0.7rem; white-space: nowrap;">
                                            ASEGURADO</th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">ESTADO</th>
                                        <th style="padding: 8px 6px; text-align: left; font-size: 0.7rem;">RESP.</th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">F. EECC
                                        </th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">F. GESTI√ìN
                                        </th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">D√çAS</th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">COMPROM.
                                        </th>
                                        <th style="padding: 8px 6px; text-align: left; font-size: 0.7rem;">PR√ìX. ACCI√ìN
                                        </th>
                                        <th style="padding: 8px 6px; text-align: center; font-size: 0.7rem;">‚ö°</th>
                                    </tr>
                                </thead>
                                <tbody id="bitacoraTableBodyEmb">
                                    <tr>
                                        <td colspan="9"
                                            style="text-align: center; padding: 3rem; color: var(--tp-text-secondary);">
                                            <div class="spinner"
                                                style="width: 40px; height: 40px; border: 3px solid var(--tp-border-light); border-top-color: var(--tp-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;">
                                            </div>
                                            Cargando gestiones...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 1rem;">
                            <span class="text-muted"><span id="bitacoraCountEmb">0</span> ciclos de gesti√≥n</span>
                        </div>
                    </div>

                    <!-- TAB 2: REGISTRAR GESTI√ìN - Formulario inline -->
                    <div id="bitacora-embedded-registrar" class="bitacora-pane" style="display: none;">
                        <div style="padding: 1.5rem; background: var(--tp-surface-secondary); border-radius: 8px;">
                            <p style="margin-bottom: 1.5rem; color: var(--tp-text-secondary);">
                                ‚úçÔ∏è Completa este formulario para registrar una nueva gesti√≥n de cobranza.
                                Los campos marcados con <span style="color: #D32F2F;">*</span> son obligatorios.
                            </p>

                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">üè¢ Asegurado <span style="color:#D32F2F;">*</span></label>
                                    <select id="gestionAseguradoEmb" style="width:100%;">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">üìå Tipo de Gesti√≥n <span
                                            style="color:#D32F2F;">*</span></label>
                                    <select id="gestionTipoEmb" style="width:100%;">
                                        <option value="">Seleccionar...</option>
                                        <option value="LLAMADA">üìû Llamada</option>
                                        <option value="WHATSAPP">üí¨ WhatsApp</option>
                                        <option value="EMAIL">‚úâÔ∏è Email</option>
                                        <option value="REUNION">ü§ù Reuni√≥n</option>
                                        <option value="VISITA">üöó Visita</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">üìä Estado <span style="color:#D32F2F;">*</span></label>
                                    <select id="gestionEstadoEmb" style="width:100%;">
                                        <option value="">Seleccionar...</option>
                                        <option value="SIN_RESPUESTA">‚ùå Sin respuesta</option>
                                        <option value="EN_SEGUIMIENTO">üëÅÔ∏è En seguimiento</option>
                                        <option value="COMPROMISO_PAGO">ü§ù Compromiso de pago</option>
                                        <option value="CERRADO_PAGADO">‚úÖ Cerrado/Pagado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">üìÖ Fecha Compromiso</label>
                                    <input type="date" id="gestionFechaCompromisoEmb" style="width:100%;">
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">üìù Pr√≥xima Acci√≥n <span
                                        style="color:#D32F2F;">*</span></label>
                                <input type="text" id="gestionProximaAccionEmb"
                                    placeholder="Ej: Llamar para confirmar pago..." style="width:100%;">
                            </div>

                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">üìã Observaciones</label>
                                <textarea id="gestionObservacionesEmb" rows="3" placeholder="Detalles adicionales..."
                                    style="width:100%;"></textarea>
                            </div>

                            <div style="margin-top: 1.5rem; text-align: right;">
                                <button class="btn btn-primary" onclick="registrarGestionEmbedded()">
                                    üíæ Registrar Gesti√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <footer class="portal-footer" style="margin-top: auto; padding-top: 2rem;">
                    <div class="footer-content">
                        <p class="footer-left">
                            Copyright ¬© 2025 Transperuana Corredores de Seguros S.A.
                        </p>
                        <p class="footer-right">
                            v3.0 Fix Definitivo
                        </p>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL: ENV√çO MASIVO DE CORREOS
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="mailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">üìß Env√≠o Masivo de Correos</h2>
                    <p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        Env√≠a estados de cuenta a m√∫ltiples clientes de forma simult√°nea
                    </p>
                </div>
                <button class="btn-close" onclick="closeMailModal()">√ó</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchMailTab('seleccionar')">
                    1. Seleccionar Clientes
                </button>
                <button class="tab" onclick="switchMailTab('parametros')">
                    2. Configurar Env√≠o
                </button>
                <button class="tab" onclick="switchMailTab('previsualizar')">
                    3. Revisar
                </button>
            </div>

            <div class="modal-body">
                <!-- TAB 1: Seleccionar Clientes -->
                <div class="tab-pane active" id="mail-tab-seleccionar">
                    <div class="form-group">
                        <label class="form-label" for="mailSearch">
                            üîç Buscar empresa
                        </label>
                        <input type="search" id="mailSearch" placeholder="Escribe para filtrar empresas..."
                            oninput="filterMailClientes()">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="mailClientesSelect">
                            Empresas disponibles
                        </label>
                        <select id="mailClientesSelect" multiple style="height: 220px;">
                            <option disabled>Cargando empresas...</option>
                        </select>
                        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;">
                            <strong><span id="mailSelectedCount">0</span> empresa(s) seleccionada(s)</strong> ¬∑
                            Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples
                        </p>
                    </div>
                </div>

                <!-- TAB 2: Par√°metros -->
                <div class="tab-pane" id="mail-tab-parametros">
                    <div class="form-group">
                        <label class="form-label" for="mailFechaCorte">
                            üìÖ Fecha de corte del estado de cuenta
                        </label>
                        <input type="date" id="mailFechaCorte">
                        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;">
                            Define hasta qu√© fecha considerar la deuda en el estado de cuenta
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            üìé Formatos de archivo a adjuntar
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mailPdf" checked>
                            <strong>PDF</strong> - Estado de cuenta en formato imprimible
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mailXlsx" checked>
                            <strong>XLSX</strong> - Estado de cuenta en formato editable (Excel)
                        </label>
                    </div>

                    <button class="btn btn-secondary" onclick="previewMailContent()"
                        style="width: 100%; margin-top: 1rem;">
                        üëÅ Previsualizar contenido del correo
                    </button>
                    <div id="mailPreviewContent" class="hidden" style="margin-top: 1rem;"></div>
                </div>

                <!-- TAB 3: Previsualizar -->
                <div class="tab-pane" id="mail-tab-previsualizar">
                    <p class="text-muted mb-4" style="font-size: 0.875rem;">
                        Revisa la lista final de correos antes de enviar. Puedes excluir empresas si es necesario.
                    </p>
                    <div id="mailPreviewContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div style="font-weight: 500; margin-top: 0.5rem;">
                                Selecciona empresas en el paso 1
                            </div>
                            <div style="font-size: 0.8125rem; color: var(--tp-text-secondary); margin-top: 0.25rem;">
                                Luego aparecer√°n aqu√≠ para revisi√≥n final
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <span class="text-muted" style="font-size: 0.875rem;">
                    ‚úÖ <strong><span id="mailApprovedCount">0</span></strong> correos listos para enviar
                </span>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="sendMailTest()" id="btnMailTest">
                        üß™ Enviar prueba
                    </button>
                    <button class="btn btn-secondary" onclick="closeMailModal()">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="sendEmails()" id="btnSendEmails" disabled>
                        ‚úâÔ∏è Enviar correos ahora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL: BIT√ÅCORA DE GESTIONES
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="bitacoraModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">üìù Bit√°cora de Gestiones de Cobranzas</h2>
                    <p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        Registra y consulta el seguimiento de todas las gestiones realizadas
                    </p>
                </div>
                <button class="btn-close" onclick="closeBitacoraModal()">√ó</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchBitacoraTab('estado')">
                    üìä Estado Actual
                </button>
                <button class="tab" onclick="switchBitacoraTab('registrar')">
                    ‚úçÔ∏è Registrar Gesti√≥n
                </button>
            </div>

            <div class="modal-body">
                <!-- TAB 1: ESTADO ACTUAL -->
                <div class="tab-pane active" id="bitacora-tab-estado">
                    <!-- Filtros de b√∫squeda -->
                    <div style="margin-bottom: 1rem;">
                        <p style="font-size: 0.875rem; color: var(--tp-text-secondary); margin-bottom: 0.75rem;">
                            üîç Filtra las gestiones para encontrar lo que necesitas
                        </p>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group mb-0">
                            <label class="form-label" for="filtroAsegurado">
                                üè¢ Asegurado / Cliente
                            </label>
                            <select id="filtroAsegurado" onchange="filtrarBitacora()">
                                <option value="">Todos los clientes</option>
                            </select>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label" for="filtroEstado">
                                üìå Estado de Gesti√≥n
                            </label>
                            <select id="filtroEstado" onchange="filtrarBitacora()">
                                <option value="">Todos los estados</option>
                                <option value="SIN_RESPUESTA">‚ùå Sin respuesta</option>
                                <option value="EN_SEGUIMIENTO">üëÅÔ∏è En seguimiento</option>
                                <option value="COMPROMISO_PAGO">ü§ù Compromiso de pago</option>
                                <option value="REPROGRAMADO">üìÖ Reprogramado</option>
                                <option value="DERIVADO_COMERCIAL">üîÄ Derivado Comercial</option>
                                <option value="DERIVADO_RRHH">üîÄ Derivado RRHH</option>
                                <option value="DERIVADO_RIESGOS_GENERALES">üîÄ Derivado Riesgos</option>
                                <option value="CERRADO_PAGADO">‚úÖ Cerrado/Pagado</option>
                                <option value="NO_COBRABLE">‚õî No cobrable</option>
                            </select>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label" for="filtroResponsable">
                                üë§ Responsable
                            </label>
                            <select id="filtroResponsable" onchange="filtrarBitacora()">
                                <option value="">Todos los responsables</option>
                            </select>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label" for="filtroDias">
                                üìÖ Antig√ºedad
                            </label>
                            <select id="filtroDias" onchange="filtrarBitacora()">
                                <option value="">Todos los per√≠odos</option>
                                <option value="0-7">üìó Reciente (0-7 d√≠as)</option>
                                <option value="8-30">üìô Medio (8-30 d√≠as)</option>
                                <option value="31-60">üìï Antiguo (31-60 d√≠as)</option>
                                <option value="61-">‚ö†Ô∏è Cr√≠tico (+60 d√≠as)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla resumen -->
                    <div class="table-container">
                        <table id="bitacoraTable">
                            <thead>
                                <tr>
                                    <th>Asegurado</th>
                                    <th>Estado</th>
                                    <th>Responsable</th>
                                    <th>Fecha Env√≠o EECC</th>
                                    <th>Fecha √öltima Gesti√≥n</th>
                                    <th>D√≠as Ciclo</th>
                                    <th>Fecha Compromiso</th>
                                    <th>Pr√≥xima Acci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bitacoraTableBody">
                                <tr>
                                    <td colspan="9" class="text-muted" style="text-align: center; padding: 2rem;">
                                        Cargando gestiones...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1rem;">
                        <span class="text-muted">
                            <span id="bitacoraCount">0</span> ciclos de gesti√≥n
                        </span>
                    </div>
                </div>

                <!-- TAB 2: REGISTRAR GESTI√ìN -->
                <div class="tab-pane" id="bitacora-tab-registrar">
                    <div style="margin-bottom: 1.5rem;">
                        <p style="font-size: 0.875rem; color: var(--tp-text-secondary); line-height: 1.5;">
                            ‚úçÔ∏è Completa este formulario para registrar una nueva gesti√≥n de cobranza.
                            Los campos marcados con <span style="color: #D32F2F;">*</span> son obligatorios.
                        </p>
                    </div>

                    <form id="formGestion" onsubmit="return registrarGestionManual(event)">
                        <!-- Grid de 2 columnas en desktop -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">

                            <!-- COLUMNA 1: Datos del Cliente y Gesti√≥n -->
                            <div>
                                <h3
                                    style="font-size: 1rem; font-weight: 600; color: var(--tp-text-primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--tp-border-light);">
                                    üìã Informaci√≥n del Cliente
                                </h3>

                                <!-- GRUPO_ECONOMICO - Selector de Modo -->
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="bitacoraMode" value="asegurado" checked
                                            onchange="toggleBitacoraMode()">
                                        <span>üë§ Individual</span>
                                    </label>
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="bitacoraMode" value="grupo"
                                            onchange="toggleBitacoraMode()">
                                        <span>üë• Grupo Econ√≥mico</span>
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="gestionAsegurado">
                                        üè¢ Asegurado / Cliente <span style="color: #D32F2F;">*</span>
                                    </label>

                                    <!-- Componente Autocomplete (Combobox): Escribe o selecciona -->
                                    <div class="autocomplete-wrapper">
                                        <div class="autocomplete-input-container">
                                            <span class="autocomplete-icon">üîç</span>
                                            <input type="text" id="gestionAsegurado" class="autocomplete-input"
                                                placeholder="Escribe o selecciona un cliente..." autocomplete="off"
                                                required oninput="filtrarAutocomplete()"
                                                onfocus="mostrarDropdownAutocomplete()" />
                                            <button type="button" class="autocomplete-dropdown-btn"
                                                onclick="toggleDropdownAutocomplete()" title="Ver todas las opciones">
                                                ‚ñº
                                            </button>
                                            <button type="button" class="autocomplete-clear-btn" id="clearAsegurado"
                                                onclick="limpiarAutocomplete()" style="display: none;"
                                                title="Limpiar selecci√≥n">
                                                ‚úï
                                            </button>
                                        </div>

                                        <!-- Dropdown de opciones -->
                                        <div class="autocomplete-dropdown" id="autocompleteDropdown"
                                            style="display: none;">
                                            <div class="autocomplete-options" id="autocompleteOptions">
                                                <!-- Las opciones se cargan din√°micamente -->
                                            </div>
                                        </div>

                                        <!-- Contador de resultados -->
                                        <small id="autocompleteCounter" class="autocomplete-counter"
                                            style="display: none;"></small>
                                    </div>

                                    <!-- Hidden input para mantener compatibilidad con validaci√≥n del formulario -->
                                    <input type="hidden" id="gestionAseguradoValue" name="asegurado" required />
                                </div>

                                <div class="form-group">
                                    <div class="fecha-field-wrapper">
                                        <div class="fecha-field-header">
                                            <label class="form-label" style="margin: 0;">
                                                üìÖ Fecha Env√≠o EECC (Inicio del ciclo)
                                            </label>

                                            <!-- Selector Autom√°tico / Manual con dise√±o profesional -->
                                            <div class="radio-toggle-group">
                                                <input type="radio" id="fechaEnvioAuto" name="fechaEnvioMode"
                                                    value="auto" checked class="radio-toggle-input"
                                                    onchange="toggleFechaEnvioMode()">
                                                <label for="fechaEnvioAuto" class="radio-toggle-label">
                                                    <span class="radio-toggle-icon">ü§ñ</span>
                                                    <span>Autom√°tico</span>
                                                </label>

                                                <input type="radio" id="fechaEnvioManual" name="fechaEnvioMode"
                                                    value="manual" class="radio-toggle-input"
                                                    onchange="toggleFechaEnvioMode()">
                                                <label for="fechaEnvioManual" class="radio-toggle-label">
                                                    <span class="radio-toggle-icon">‚úçÔ∏è</span>
                                                    <span>Manual</span>
                                                </label>
                                            </div>
                                        </div>

                                        <input type="datetime-local" id="gestionFechaEnvioEECC" readonly
                                            placeholder="Se completar√° autom√°ticamente">
                                        <small class="form-help">
                                            <span id="fechaEnvioHelp">Fecha del env√≠o del EECC que inici√≥ este ciclo de
                                                cobranza</span>
                                        </small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="fecha-field-wrapper">
                                        <div class="fecha-field-header">
                                            <label class="form-label" style="margin: 0;">
                                                üìÖ Fecha de esta Gesti√≥n
                                            </label>

                                            <!-- Selector Hoy / Manual con dise√±o profesional -->
                                            <div class="radio-toggle-group">
                                                <input type="radio" id="fechaGestionHoy" name="fechaGestionMode"
                                                    value="auto" checked class="radio-toggle-input"
                                                    onchange="toggleFechaGestionMode()">
                                                <label for="fechaGestionHoy" class="radio-toggle-label">
                                                    <span class="radio-toggle-icon">ü§ñ</span>
                                                    <span>Hoy</span>
                                                </label>

                                                <input type="radio" id="fechaGestionManual" name="fechaGestionMode"
                                                    value="manual" class="radio-toggle-input"
                                                    onchange="toggleFechaGestionMode()">
                                                <label for="fechaGestionManual" class="radio-toggle-label">
                                                    <span class="radio-toggle-icon">‚úçÔ∏è</span>
                                                    <span>Manual</span>
                                                </label>
                                            </div>
                                        </div>

                                        <input type="datetime-local" id="gestionFechaGestion" readonly>
                                        <small class="form-help">
                                            <span id="fechaGestionHelp">Por defecto se usa la fecha y hora actual</span>
                                        </small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="gestionResponsable">
                                        üë§ Responsable
                                    </label>
                                    <input type="text" id="gestionResponsable" readonly placeholder="Usuario actual"
                                        style="background-color: var(--tp-surface-overlay);">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="gestionTipo">
                                        üìû Tipo de Gesti√≥n <span style="color: #D32F2F;">*</span>
                                    </label>
                                    <select id="gestionTipo" required>
                                        <option value="">¬øC√≥mo contactaste al cliente?</option>
                                        <option value="LLAMADA">üìû Llamada telef√≥nica</option>
                                        <option value="WHATSAPP">üí¨ Mensaje por WhatsApp</option>
                                        <option value="CORREO_INDIVIDUAL">üìß Correo electr√≥nico individual</option>
                                        <option value="REUNION">ü§ù Reuni√≥n presencial o virtual</option>
                                        <option value="OTRO">üìù Otro tipo de gesti√≥n</option>
                                    </select>
                                </div>
                            </div>

                            <!-- COLUMNA 2: Estado y Seguimiento -->
                            <div>
                                <h3
                                    style="font-size: 1rem; font-weight: 600; color: var(--tp-text-primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--tp-border-light);">
                                    üìä Resultado y Seguimiento
                                </h3>

                                <div class="form-group">
                                    <label class="form-label" for="gestionEstado">
                                        üìå Estado de Gesti√≥n <span style="color: #D32F2F;">*</span>
                                    </label>
                                    <select id="gestionEstado" required onchange="onEstadoChange()">
                                        <option value="">¬øCu√°l fue el resultado?</option>
                                        <option value="SIN_RESPUESTA">‚ùå Sin respuesta</option>
                                        <option value="EN_SEGUIMIENTO">üëÅÔ∏è En seguimiento</option>
                                        <option value="COMPROMISO_PAGO">ü§ù Compromiso de pago</option>
                                        <option value="REPROGRAMADO">üìÖ Reprogramado</option>
                                        <option value="DERIVADO_COMERCIAL">üîÄ Derivado Comercial</option>
                                        <option value="DERIVADO_RRHH">üîÄ Derivado RRHH</option>
                                        <option value="DERIVADO_RIESGOS_GENERALES">üîÄ Derivado Riesgos Generales
                                        </option>
                                        <option value="CERRADO_PAGADO">‚úÖ Cerrado/Pagado</option>
                                        <option value="NO_COBRABLE">‚õî No cobrable</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="gestionCanal">
                                        üì° Canal de Contacto <span style="color: #D32F2F;">*</span>
                                    </label>
                                    <select id="gestionCanal" required>
                                        <option value="">¬øPor qu√© medio se realiz√≥?</option>
                                        <option value="EMAIL">üìß Correo electr√≥nico</option>
                                        <option value="LLAMADA">üìû Llamada telef√≥nica</option>
                                        <option value="WHATSAPP">üí¨ WhatsApp</option>
                                        <option value="REUNION">ü§ù Reuni√≥n</option>
                                        <option value="OTRO">üìù Otro canal</option>
                                    </select>
                                </div>

                                <div class="form-group hidden" id="grupoFechaCompromiso">
                                    <label class="form-label" for="gestionFechaCompromiso">
                                        üóìÔ∏è Fecha de Compromiso <span id="requiredCompromiso" class="hidden"
                                            style="color: #D32F2F;">*</span>
                                    </label>
                                    <input type="date" id="gestionFechaCompromiso">
                                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;">
                                        üí° <strong>Obligatorio</strong> si el estado es "Compromiso de pago" o
                                        "Reprogramado"
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="gestionProximaAccion">
                                        üéØ Pr√≥xima Acci√≥n <span style="color: #D32F2F;">*</span>
                                    </label>
                                    <input type="text" id="gestionProximaAccion" required
                                        placeholder="Ej: Llamar si no paga el 20/11, Enviar recordatorio..."
                                        maxlength="200">
                                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;">
                                        Define qu√© hacer despu√©s de esta gesti√≥n
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones (ancho completo) -->
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label" for="gestionObservaciones">
                                Observaciones <span id="requiredObs" class="hidden" style="color: #D32F2F;">*</span>
                            </label>
                            <textarea id="gestionObservaciones" rows="4"
                                placeholder="Detalles de la gesti√≥n (con qui√©n se habl√≥, qu√© se acord√≥, etc.)"></textarea>
                            <p class="text-muted" style="margin-top: 0.25rem; font-size: 0.875rem;">
                                Obligatorio para estados: Derivaciones, No cobrable
                            </p>
                        </div>

                        <!-- Estado del formulario -->
                        <div id="gestionStatus" style="margin-top: 1rem;"></div>

                        <!-- Botones -->
                        <div class="btn-group" style="margin-top: 1.5rem;">
                            <button type="button" class="btn btn-secondary" onclick="limpiarFormGestion()">
                                Limpiar
                            </button>
                            <button type="submit" class="btn btn-primary" id="btnGuardarGestion">
                                üíæ Registrar Gesti√≥n
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL: TIMELINE DEL CICLO
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="timelineModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--tp-text-primary);">
                        üìä Timeline del Ciclo de Cobranza
                    </h2>
                    <p id="timelineSubtitle"
                        style="margin: 0.5rem 0 0 0; color: var(--tp-text-secondary); font-size: 0.875rem;">
                        Historial completo de gestiones
                    </p>
                </div>
                <button class="btn-close" onclick="closeTimelineModal()" aria-label="Cerrar">‚úï</button>
            </div>

            <div class="modal-body" style="padding: var(--tp-space-6);">
                <div id="timelineContent" style="position: relative;">
                    <!-- El contenido se cargar√° din√°micamente -->
                    <div class="loader" style="text-align: center; padding: 3rem;">
                        <div class="loader-spinner"></div>
                        <p>Cargando timeline...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN ==========
        const SCRIPT_URL = "<?= scriptUrl ?>"; // Inyectado desde el backend

        // ========== DEBUG ==================================================
        // ESTADO GLOBAL
        // ============================================================
        let TOKEN = null;
        let CURRENT_USER = null;
        let INCLUDE_OBS = false;
        let PREVIEW_DATA = null;
        let ALL_CLIENTES = []; // DEPRECATED Phase 2: Will contain only partial list or fallback
        let ALL_GRUPOS = []; // GRUPO_ECONOMICO
        let EECC_MODE = 'asegurado'; // asegurado | grupo
        let BITACORA_MODE = 'asegurado'; // asegurado | grupo
        let MAIL_STATE = { previews: [], currentTab: 'seleccionar', allClientes: [] };

        // Phase 2: Pagination Data Source
        let ASEGURADOS_DS = {
            items: [],
            nextCursor: null,
            hasMore: true,
            loading: false,
            search: ''
        };
        let SEARCH_TIMEOUT = null;

        const PBI_URL = 'https://app.powerbi.com/view?r=eyJrIjoiNTJmNjA0ZmQtOGU4Yi00Nzk2LWIzOWMtM2NmMTM4N2Y5ZDEzIiwidCI6IjMyMDliNTBiLWI3OWItNDNkYy05ZmM0LThkNDJjNDA2ZGQ2MSIsImMiOjR9';

        // ============================================================
        // UTILIDADES: LOG, TOAST, LOADING
        // ============================================================
        function log(message, type = 'info') {
            const logEl = document.getElementById('activityLog');
            if (!logEl) return;
            const time = new Date().toLocaleTimeString('es-PE');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            let icon = '‚Ä¢';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ö†';
            entry.innerHTML = `<span>${time}</span> ${icon} ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span class="toast-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</span><div>${message}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading(show, text = 'Cargando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (show) {
                loadingText.textContent = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        /**
         * PARTE A: Oculta TODOS los overlays de loading globales
         * Debe llamarse despu√©s de que cada m√≥dulo inline est√© listo
         */
        function hideGlobalLoader(reason) {
            const candidates = [
                '#loadingOverlay',
                '#globalLoader',
                '.global-loader',
                '.loading-overlay',
                '.overlay-loading',
                '.module-loading'
            ];
            let hidden = 0;

            candidates.forEach(sel => {
                document.querySelectorAll(sel).forEach(el => {
                    el.style.display = 'none';
                    el.style.pointerEvents = 'none';
                    el.classList.add('hidden');
                    el.setAttribute('aria-hidden', 'true');
                    hidden++;
                });
            });

            // Fallback: detectar por texto "Cargando..."
            document.querySelectorAll('div, section, p').forEach(el => {
                if (el && el.innerText && el.innerText.trim() === 'Cargando...') {
                    const parent = el.closest('.module-loading, .loading-overlay, .loader');
                    if (parent) {
                        parent.style.display = 'none';
                        hidden++;
                    }
                }
            });

            // Tambi√©n ocultar spinners internos de m√≥dulos inline
            const enviarHost = document.getElementById('enviarInlineHost');
            const bitacoraHost = document.getElementById('bitacoraInlineHost');

            [enviarHost, bitacoraHost].forEach(host => {
                if (host) {
                    const loader = host.querySelector('.module-loading');
                    if (loader) {
                        loader.style.display = 'none';
                        hidden++;
                    }
                }
            });

            console.log(`[LOADER] hideGlobalLoader(${reason}) -> hidden=${hidden}`);
        }

        function showStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = `status status-${type}`;
            el.textContent = message;
            el.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => el.classList.add('hidden'), 5000);
            }
        }

        function getExportType() {
            const val = document.querySelector('input[name="exportType"]:checked').value;
            return {
                exportPdf: val === 'both' || val === 'pdf',
                exportXlsx: val === 'both' || val === 'xlsx'
            };
        }

        // ============================================================
        // SIDEBAR NAVIGATION
        // ============================================================
        /**
         * Handles Sidebar Navigation - switches between views
         * @param {string} viewName - The ID suffix of the view to show (e.g., 'dashboard', 'generar')
         */
        let ENVIAR_MODULE_LOADED = false;
        let BITACORA_MODULE_LOADED = false;

        function switchView(viewName) {
            // 1. Hide all views
            const views = document.querySelectorAll('.view-section');
            views.forEach(v => v.classList.remove('active'));

            // 2. Deactivate all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(n => n.classList.remove('active'));

            // 3. Show selected view
            const selectedView = document.getElementById(`view-${viewName}`);
            if (selectedView) {
                selectedView.classList.add('active');
            } else {
                console.error(`View not found: view-${viewName}`);
            }

            // 4. Activate nav item
            const selectedNav = document.getElementById(`nav-${viewName}`);
            if (selectedNav) {
                selectedNav.classList.add('active');
            }

            // 5. Scroll to top
            const mainScroll = document.getElementById('mainScroll');
            if (mainScroll) mainScroll.scrollTop = 0;

            log(`Navegado a: ${viewName}`, 'info');

            // AUTO-CARGAR m√≥dulos inline cuando se navega a ellos
            if (viewName === 'enviar') {
                renderEnviarInline();
            }

            // FIX: Bit√°cora embebida v15 - cargar datos directamente sin inyectar HTML
            if (viewName === 'bitacora') {
                loadBitacoraEmbeddedData();
            }
        }

        // ============================================================
        // M√ìDULOS INLINE (REEMPLAZO DE POPUPS/MODALES)
        // ============================================================

        // Variables para evitar recargar m√≥dulos
        let ENVIAR_INLINE_LOADED = false;
        let BITACORA_INLINE_LOADED = false;

        /**
         * FIX 2: Inyecta HTML con ejecuci√≥n real de scripts
         * Mueve estilos a head, luego inyecta HTML, luego ejecuta scripts
         */
        function injectHtmlWithScripts(host, html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Mover estilos a head
            temp.querySelectorAll('style').forEach(s => document.head.appendChild(s.cloneNode(true)));

            // Extraer scripts antes de inyectar
            const scripts = [...temp.querySelectorAll('script')];
            scripts.forEach(s => s.remove());

            // Inyectar HTML limpio
            host.innerHTML = temp.innerHTML;

            // Ejecutar scripts en orden
            scripts.forEach(oldScript => {
                const s = document.createElement('script');
                [...oldScript.attributes].forEach(a => s.setAttribute(a.name, a.value));
                s.textContent = oldScript.textContent;
                host.appendChild(s);
            });

            console.log('[injectHtmlWithScripts] ‚úÖ HTML + scripts inyectados');
        }

        /**
         * Renderiza el m√≥dulo de Enviar Correos INLINE (sin popup)
         * Reemplaza openExternalDrawer()
         */
        function renderEnviarInline() {
            if (ENVIAR_INLINE_LOADED) {
                console.log('[renderEnviarInline] Ya cargado, omitiendo');
                return;
            }

            const host = document.getElementById('enviarInlineHost');
            if (!host) {
                console.error('[renderEnviarInline] Host #enviarInlineHost no encontrado');
                return;
            }

            console.log('[renderEnviarInline] üöÄ Cargando m√≥dulo de env√≠o...');
            log('Cargando m√≥dulo de env√≠o...', 'info');

            google.script.run
                .withSuccessHandler(html => {
                    console.log('[renderEnviarInline] ‚úÖ HTML recibido, inyectando con scripts...');

                    // FIX 2: Usar injectHtmlWithScripts para ejecutar scripts
                    injectHtmlWithScripts(host, html);

                    // FIX A: LLAMAR EXPL√çCITAMENTE a initDrawer() despu√©s de inyecci√≥n
                    setTimeout(() => {
                        if (typeof window.initDrawer === 'function') {
                            window.initDrawer();
                            console.log('[SEND] ‚úÖ initDrawer OK');
                            // PARTE A: Ocultar overlay despu√©s de init OK
                            hideGlobalLoader('send-ready');
                        } else {
                            console.error('[SEND] ‚ùå initDrawer NO definido');
                            host.innerHTML = `
                                <div style="padding: 2rem; text-align: center; color: var(--tp-error);">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                    <div>No se pudo inicializar el m√≥dulo de env√≠o.</div>
                                    <button class="btn btn-secondary" onclick="ENVIAR_INLINE_LOADED=false; renderEnviarInline();" style="margin-top: 1rem;">
                                        Reintentar
                                    </button>
                                </div>
                            `;
                        }
                    }, 100);

                    ENVIAR_INLINE_LOADED = true;
                    log('M√≥dulo de env√≠o cargado', 'success');
                    console.log('[UI] ‚úÖ enviar ready');
                })
                .withFailureHandler(err => {
                    console.error('[renderEnviarInline] ‚ùå Error:', err);
                    host.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--tp-error);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                            <div>Error al cargar m√≥dulo: ${err.message}</div>
                            <button class="btn btn-secondary" onclick="ENVIAR_INLINE_LOADED=false; renderEnviarInline();" style="margin-top: 1rem;">
                                Reintentar
                            </button>
                        </div>
                    `;
                    log('Error cargando m√≥dulo de env√≠o: ' + err.message, 'error');
                })
                .getDrawerContent();
        }

        /**
         * Renderiza la Bit√°cora INLINE (sin modal)
         * Reemplaza openBitacoraModal()
         */
        function renderBitacoraInline() {
            if (BITACORA_INLINE_LOADED) {
                console.log('[renderBitacoraInline] Ya cargado, omitiendo');
                return;
            }

            const host = document.getElementById('bitacoraInlineHost');
            if (!host) {
                console.error('[renderBitacoraInline] Host #bitacoraInlineHost no encontrado');
                return;
            }

            console.log('[renderBitacoraInline] üöÄ Cargando bit√°cora...');
            log('Cargando bit√°cora...', 'info');

            google.script.run
                .withSuccessHandler(html => {
                    console.log('[renderBitacoraInline] ‚úÖ HTML recibido, inyectando con scripts...');

                    // FIX 2: Usar injectHtmlWithScripts para ejecutar scripts (switchTab, etc)
                    injectHtmlWithScripts(host, html);

                    // FIX B: LLAMAR EXPL√çCITAMENTE funciones de init v15
                    setTimeout(() => {
                        initBitacoraInline();
                    }, 100);

                    BITACORA_INLINE_LOADED = true;
                    log('Bit√°cora cargada', 'success');
                    console.log('[UI] ‚úÖ bitacora ready');
                })
                .withFailureHandler(err => {
                    console.error('[renderBitacoraInline] ‚ùå Error:', err);
                    host.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--tp-error);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                            <div>Error al cargar bit√°cora: ${err.message}</div>
                            <button class="btn btn-secondary" onclick="BITACORA_INLINE_LOADED=false; renderBitacoraInline();" style="margin-top: 1rem;">
                                Reintentar
                            </button>
                        </div>
                    `;
                    log('Error cargando bit√°cora: ' + err.message, 'error');
                })
                .getBitacoraHtml();
        }

        /**
         * FIX B: Inicializa Bit√°cora con comportamiento v15
         * Llamada expl√≠cita a funciones que antes se ejecutaban en openBitacoraModal()
         */
        function initBitacoraInline() {
            try {
                console.log('[BITACORA] Inicializando...');

                // Comportamiento v15: cargar datos
                if (typeof window.loadBitacoraData === 'function') {
                    window.loadBitacoraData(true);
                    console.log('[BITACORA] ‚úÖ loadBitacoraData OK');
                }

                // Cargar clientes con ciclos activos
                if (typeof window.loadClientesConCiclos === 'function') {
                    window.loadClientesConCiclos();
                    console.log('[BITACORA] ‚úÖ loadClientesConCiclos OK');
                }

                // Cargar responsables √∫nicos
                if (typeof window.loadResponsablesUnicos === 'function') {
                    window.loadResponsablesUnicos();
                    console.log('[BITACORA] ‚úÖ loadResponsablesUnicos OK');
                }

                console.log('[BITACORA] ‚úÖ init OK');

                // PARTE B: Ocultar overlay despu√©s de init OK
                hideGlobalLoader('bitacora-ready');
            } catch (e) {
                console.error('[BITACORA] ‚ùå init FAIL', e);
                const host = document.getElementById('bitacoraInlineHost');
                if (host) {
                    host.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--tp-error);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                            <div>No se pudo inicializar Bit√°cora: ${e.message}</div>
                            <button class="btn btn-secondary" onclick="BITACORA_INLINE_LOADED=false; renderBitacoraInline();" style="margin-top: 1rem;">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ============================================================
        // LOGIN Y LOGOUT
        // ============================================================
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const btnText = document.getElementById('loginBtnText');
            const spinner = document.getElementById('loginSpinner');
            const errorEl = document.getElementById('loginError');

            errorEl.classList.add('hidden');
            btnText.textContent = 'Verificando...';
            spinner.classList.remove('hidden');
            showLoading(true, 'Iniciando sesi√≥n...');

            google.script.run
                .withSuccessHandler(response => {
                    showLoading(false);
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Iniciar sesi√≥n';

                    if (!response || !response.ok) {
                        errorEl.textContent = response?.error || 'Error desconocido';
                        errorEl.classList.remove('hidden');
                        return;
                    }

                    TOKEN = response.token;
                    CURRENT_USER = response.user;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('portalSection').classList.remove('hidden');

                    // FIX: null-guard para elementos que pueden no existir en v17
                    const userEl = document.getElementById('currentUser');
                    if (userEl) userEl.textContent = CURRENT_USER;

                    console.log('[LOGIN] ‚úÖ success, user:', CURRENT_USER);
                    initPortal();
                })
                .withFailureHandler(error => {
                    showLoading(false);
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Iniciar sesi√≥n';
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                })
                .loginPassword(username, password);

            return false;
        }

        function handleLogout() {
            if (TOKEN) google.script.run.logout(TOKEN);
            location.reload();
        }

        // ============================================================
        // INICIALIZACI√ìN DEL PORTAL
        // ============================================================
        function initPortal() {
            console.log('[initPortal] üöÄ Iniciando portal...');
            log('Portal inicializado', 'success');

            // Cargar PBI
            const pbiFrame = document.getElementById('pbiFrame');
            if (pbiFrame) {
                pbiFrame.src = PBI_URL;
                console.log('[initPortal] ‚úÖ PBI URL cargada');
                log('Dashboard PBI cargado', 'info');
            } else {
                console.error('[initPortal] ‚ùå pbiFrame no encontrado');
            }

            // Cargar asegurados y grupos
            loadAsegurados();
            loadGrupos();

            // Inicializar notificaciones
            inicializarNotificaciones();

            // Phase 3: Load Dashboard Stats
            refreshDashboardStats();
            loadQueueHealth();
            startDashboardAutoRefresh();

            // Phase 5: UX Enhancements
            initQuickActions();
            initGlobalSearch();
        }

        // ============================================================
        // PHASE 3: DASHBOARD STATS & QUEUE HEALTH
        // ============================================================
        let dashboardStatsInterval = null;

        function refreshDashboardStats() {
            const statsSection = document.getElementById('dashboardStatsSection');
            if (!statsSection) return;

            document.getElementById('statsLastUpdated').textContent = 'Actualizando...';

            google.script.run
                .withSuccessHandler(result => {
                    if (result && result.ok) {
                        document.getElementById('statEeccToday').textContent = result.eecc?.today ?? '-';
                        document.getElementById('statEeccWeek').textContent = result.eecc?.week ?? '-';
                        document.getElementById('statMailSent').textContent = result.mail?.sent24h ?? '-';
                        document.getElementById('statMailQueued').textContent = result.mail?.queuedNow ?? '-';
                        const errors = (result.eecc?.errors24h ?? 0) + (result.mail?.failed24h ?? 0) + (result.system?.errors24h ?? 0);
                        document.getElementById('statErrors').textContent = errors;

                        const now = new Date();
                        document.getElementById('statsLastUpdated').textContent = 'Actualizado: ' + now.toLocaleTimeString('es-PE');
                        console.log('[Phase3] Dashboard stats loaded', result);
                    } else {
                        document.getElementById('statsLastUpdated').textContent = 'Error al cargar';
                    }
                })
                .withFailureHandler(err => {
                    console.warn('[Phase3] Dashboard stats failed', err);
                    document.getElementById('statsLastUpdated').textContent = 'No disponible';
                })
                .getDashboardStats(TOKEN);
        }

        function loadQueueHealth() {
            const section = document.getElementById('queueHealthSection');
            if (!section) return;

            google.script.run
                .withSuccessHandler(result => {
                    const indicator = document.getElementById('queueHealthIndicator');
                    const badge = document.getElementById('queueHealthBadge');

                    if (!result || !result.ok || !result.available) {
                        indicator.textContent = '‚ùì';
                        badge.textContent = 'No disponible';
                        badge.style.background = 'var(--tp-bg-muted)';
                        return;
                    }

                    // Status indicators
                    if (result.status === 'OK') {
                        indicator.textContent = 'üü¢';
                        badge.textContent = 'Cola saludable';
                        badge.style.background = '#E8F5E9';
                        badge.style.color = '#2e7d32';
                    } else if (result.status === 'WARN') {
                        indicator.textContent = 'üü°';
                        badge.textContent = 'Retraso detectado';
                        badge.style.background = '#FFF3E0';
                        badge.style.color = '#EF6C00';
                    } else {
                        indicator.textContent = 'üî¥';
                        badge.textContent = 'Cola atascada';
                        badge.style.background = '#FFEBEE';
                        badge.style.color = '#C62828';
                    }

                    // Details
                    document.getElementById('qhPending').textContent = result.pendingCount ?? '-';
                    document.getElementById('qhProcessing').textContent = result.processingCount ?? '-';
                    document.getElementById('qhFailed').textContent = result.failedCount24h ?? '-';
                    document.getElementById('qhOldest').textContent = result.oldestPendingAgeMinutes ? result.oldestPendingAgeMinutes + ' min' : '-';
                    document.getElementById('qhLastProcessed').textContent = result.lastProcessedAt
                        ? new Date(result.lastProcessedAt).toLocaleString('es-PE')
                        : 'Nunca';

                    // Reasons
                    const reasonsEl = document.getElementById('qhReasons');
                    if (result.reasons && result.reasons.length > 0) {
                        reasonsEl.innerHTML = result.reasons.map(r => '‚ö†Ô∏è ' + r).join('<br>');
                    } else {
                        reasonsEl.innerHTML = '';
                    }

                    console.log('[Phase3] Queue health loaded', result);
                })
                .withFailureHandler(err => {
                    console.warn('[Phase3] Queue health failed', err);
                    document.getElementById('queueHealthIndicator').textContent = '‚ùì';
                    document.getElementById('queueHealthBadge').textContent = 'Error';
                })
                .getMailQueueHealth(TOKEN);
        }

        function toggleQueueHealthPanel() {
            const details = document.getElementById('queueHealthDetails');
            const icon = document.getElementById('queueHealthToggleIcon');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function startDashboardAutoRefresh() {
            // Only auto-refresh when Dashboard view is active
            if (dashboardStatsInterval) clearInterval(dashboardStatsInterval);
            dashboardStatsInterval = setInterval(() => {
                const dashboardView = document.getElementById('view-dashboard');
                if (dashboardView && dashboardView.classList.contains('active')) {
                    refreshDashboardStats();
                    loadQueueHealth();
                }
            }, 60000); // 60 seconds
        }

        // ============================================================
        // PHASE 4: SKELETON & EMPTY STATE HELPERS
        // ============================================================

        /**
         * Renders skeleton loading rows in a table tbody
         * @param {HTMLElement} tbody - The tbody element
         * @param {number} rows - Number of skeleton rows (default 5)
         * @param {number} cols - Number of columns (default 6)
         */
        function renderSkeletonTable(tbody, rows = 5, cols = 6) {
            if (!tbody) return;
            tbody.innerHTML = '';
            for (let i = 0; i < rows; i++) {
                const tr = document.createElement('tr');
                tr.classList.add('tp-skeleton-loading-row');
                for (let j = 0; j < cols; j++) {
                    const td = document.createElement('td');
                    td.innerHTML = '<div class="tp-skeleton tp-skeleton-row"></div>';
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        /**
         * Renders an empty state with CTA in a table tbody
         * @param {HTMLElement} tbody - The tbody element
         * @param {Object} config - { icon, title, message, ctaLabel, ctaOnClick }
         */
        function renderEmptyState(tbody, config = {}) {
            if (!tbody) return;
            const {
                icon = 'üìã',
                title = 'No hay datos',
                message = '',
                ctaLabel = '',
                ctaOnClick = null,
                colspan = 9
            } = config;

            let html = `
                <tr>
                    <td colspan="${colspan}">
                        <div class="tp-empty-state">
                            <div class="tp-empty-state-icon">${icon}</div>
                            <div class="tp-empty-state-title">${title}</div>
                            ${message ? `<div class="tp-empty-state-message">${message}</div>` : ''}
                            ${ctaLabel ? `<button class="btn btn-primary" id="emptyStateCta">${ctaLabel}</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML = html;

            if (ctaLabel && ctaOnClick) {
                const btn = document.getElementById('emptyStateCta');
                if (btn) btn.onclick = ctaOnClick;
            }
        }

        // ============================================================
        // PHASE 5: QUICK ACTIONS (preset templates for bit√°cora)
        // ============================================================

        // Quick action presets (matching config.js QUICK_ACTIONS)
        const QUICK_ACTION_PRESETS = {
            'llamada_sin_resp': { tipoGestion: 'LLAMADA', estadoGestion: 'SIN_RESPUESTA' },
            'whatsapp_enviado': { tipoGestion: 'WHATSAPP', estadoGestion: 'EN_SEGUIMIENTO' },
            'correo_leido': { tipoGestion: 'CORREO_INDIVIDUAL', estadoGestion: 'EN_SEGUIMIENTO' },
            'compromiso_pago': { tipoGestion: 'LLAMADA', estadoGestion: 'COMPROMISO_PAGO' },
            'no_contactable': { tipoGestion: 'LLAMADA', estadoGestion: 'NO_CONTACTABLE' }
        };

        /**
         * Initialize Quick Actions bar if feature enabled
         */
        function initQuickActions() {
            const bar = document.getElementById('quickActionsBar');
            if (!bar) return;

            // Check flag via server config or assume false by default
            // Bar hidden by default, show if enabled
            google.script.run
                .withSuccessHandler(function (enabled) {
                    if (enabled) {
                        bar.style.display = 'block';
                        console.log('[QuickActions] ‚úÖ Quick Actions bar enabled');
                    }
                })
                .withFailureHandler(function () {
                    // Keep hidden on error
                    console.log('[QuickActions] Flag check failed, keeping hidden');
                })
                .getFeatureFlag('QUICK_ACTIONS_ENABLED');
        }

        /**
         * Execute a quick action: opens registrar modal pre-filled
         * @param {string} actionId - One of the QUICK_ACTION_PRESETS keys
         */
        function executeQuickAction(actionId) {
            console.log('[QuickActions] Executing:', actionId);

            const preset = QUICK_ACTION_PRESETS[actionId];
            if (!preset) {
                console.error('[QuickActions] Unknown action:', actionId);
                return;
            }

            // Switch to "Registrar Gesti√≥n" tab
            if (typeof switchBitacoraTabEmbedded === 'function') {
                switchBitacoraTabEmbedded('registrar');
            }

            // Pre-fill the form fields
            setTimeout(() => {
                // Tipo de gesti√≥n
                const tipoSelect = document.getElementById('tipoGestionEmb');
                if (tipoSelect && preset.tipoGestion) {
                    tipoSelect.value = preset.tipoGestion;
                    // Trigger change event for any listeners
                    tipoSelect.dispatchEvent(new Event('change'));
                }

                // Estado de gesti√≥n
                const estadoSelect = document.getElementById('estadoGestionEmb');
                if (estadoSelect && preset.estadoGestion) {
                    estadoSelect.value = preset.estadoGestion;
                    estadoSelect.dispatchEvent(new Event('change'));
                }

                // Focus on asegurado field for user to complete
                const aseguradoInput = document.getElementById('aseguradoGestionEmb');
                if (aseguradoInput) {
                    aseguradoInput.focus();
                }

                console.log('[QuickActions] Form pre-filled with:', preset);
            }, 100);
        }

        // ============================================================
        // PHASE 5: TIMELINE VISUAL (gestiones history)
        // ============================================================

        const GESTION_ICONS = {
            'ENVIO_EECC': 'üìß',
            'LLAMADA': 'üìû',
            'WHATSAPP': 'üí¨',
            'CORREO_INDIVIDUAL': 'üìß',
            'REUNION': 'üë•',
            'OTRO': 'üìã'
        };

        const ESTADO_COLORS = {
            'SIN_RESPUESTA': { bg: '#FFF3E0', text: '#E65100' },
            'EN_SEGUIMIENTO': { bg: '#E3F2FD', text: '#1565C0' },
            'COMPROMISO_PAGO': { bg: '#E8F5E9', text: '#2E7D32' },
            'REPROGRAMADO': { bg: '#FFF3E0', text: '#F57C00' },
            'CERRADO_PAGADO': { bg: '#E8F5E9', text: '#1B5E20' },
            'NO_CONTACTABLE': { bg: '#FFEBEE', text: '#C62828' }
        };

        /**
         * Open timeline modal for a ciclo
         * @param {string} idCiclo - Ciclo ID
         * @param {string} asegurado - Asegurado name (for display)
         */
        function openTimelineModal(idCiclo, asegurado) {
            console.log('[Timeline] Opening for:', idCiclo, asegurado);

            // Check feature flag first
            google.script.run
                .withSuccessHandler(function (enabled) {
                    if (!enabled) {
                        console.log('[Timeline] Feature disabled');
                        alert('Funci√≥n Timeline no habilitada');
                        return;
                    }
                    loadTimelineData(idCiclo, asegurado);
                })
                .withFailureHandler(function () {
                    // Fallback: try anyway
                    loadTimelineData(idCiclo, asegurado);
                })
                .getFeatureFlag('TIMELINE_VIEW_ENABLED');
        }

        function loadTimelineData(idCiclo, asegurado) {
            // Create modal if doesn't exist
            let modal = document.getElementById('timelineModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'timelineModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3 id="timelineModalTitle">üìã Timeline de Gestiones</h3>
                            <button class="btn-close" onclick="closeTimelineModal()">√ó</button>
                        </div>
                        <div class="modal-body tp-timeline-modal" id="timelineModalBody">
                            <div class="notification-loading">
                                <div class="loader-spinner"></div>
                                <p>Cargando historial...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Show modal with loading
            modal.style.display = 'flex';
            document.getElementById('timelineModalTitle').textContent = `üìã Timeline: ${asegurado}`;
            document.getElementById('timelineModalBody').innerHTML = `
                <div class="notification-loading">
                    <div class="loader-spinner"></div>
                    <p>Cargando historial...</p>
                </div>
            `;

            // Fetch data using existing endpoint
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result && result.ok && result.gestiones) {
                        renderTimelineContent(result.gestiones, asegurado);
                    } else {
                        document.getElementById('timelineModalBody').innerHTML = `
                            <div class="tp-empty-state">
                                <div class="tp-empty-state-icon">üìã</div>
                                <div class="tp-empty-state-title">Sin gestiones</div>
                                <div class="tp-empty-state-message">No hay gestiones registradas para este ciclo</div>
                            </div>
                        `;
                    }
                })
                .withFailureHandler(function (error) {
                    document.getElementById('timelineModalBody').innerHTML = `
                        <div class="tp-empty-state">
                            <div class="tp-empty-state-icon">‚ùå</div>
                            <div class="tp-empty-state-title">Error</div>
                            <div class="tp-empty-state-message">${error.message || 'Error al cargar historial'}</div>
                        </div>
                    `;
                })
                .bitacoraGetGestionesPorCiclo(idCiclo, TOKEN);
        }

        function renderTimelineContent(gestiones, asegurado) {
            const body = document.getElementById('timelineModalBody');
            if (!gestiones || gestiones.length === 0) {
                body.innerHTML = `
                    <div class="tp-empty-state">
                        <div class="tp-empty-state-icon">üìã</div>
                        <div class="tp-empty-state-title">Sin gestiones</div>
                        <div class="tp-empty-state-message">No hay gestiones registradas</div>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            gestiones.sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));

            let html = '<div class="tp-timeline">';
            gestiones.forEach(g => {
                const icon = GESTION_ICONS[g.tipoGestion] || 'üìã';
                const colors = ESTADO_COLORS[g.estadoGestion] || { bg: '#F5F5F5', text: '#666' };
                const fecha = g.fechaRegistro ? new Date(g.fechaRegistro).toLocaleString('es-PE') : '-';
                const obs = g.observaciones || '';

                html += `
                    <div class="tp-timeline-item">
                        <div class="tp-timeline-icon">${icon}</div>
                        <div class="tp-timeline-date">${fecha}</div>
                        <div class="tp-timeline-title">
                            <span class="tp-timeline-badge" style="background: ${colors.bg}; color: ${colors.text};">
                                ${(g.estadoGestion || '').replace(/_/g, ' ')}
                            </span>
                            ${(g.tipoGestion || '').replace(/_/g, ' ')}
                        </div>
                        ${obs ? `<div class="tp-timeline-body">${obs}</div>` : ''}
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                            Por: ${g.usuario || 'Sistema'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            body.innerHTML = html;
        }

        function closeTimelineModal() {
            const modal = document.getElementById('timelineModal');
            if (modal) modal.style.display = 'none';
        }

        // ============================================================
        // PHASE 5: GLOBAL SEARCH (Ctrl+K command palette)
        // ============================================================

        let COMMAND_PALETTE_OPEN = false;
        let COMMAND_PALETTE_ITEMS = [];
        let COMMAND_SELECTED_INDEX = 0;

        const COMMAND_ACTIONS = [
            { id: 'nav_dashboard', icon: 'üìä', title: 'Dashboard', subtitle: 'Ir al dashboard principal', action: () => showView('dashboard') },
            { id: 'nav_eecc', icon: 'üìß', title: 'Generar EECC', subtitle: 'Estados de cuenta', action: () => showView('eecc') },
            { id: 'nav_correos', icon: '‚úâÔ∏è', title: 'Enviar Correos', subtitle: 'M√≥dulo de env√≠o de correos', action: () => showView('correos') },
            { id: 'nav_bitacora', icon: 'üìù', title: 'Bit√°cora', subtitle: 'Gestiones de cobranza', action: () => showView('bitacora') },
            { id: 'action_nueva_gestion', icon: '‚ûï', title: 'Nueva Gesti√≥n', subtitle: 'Registrar gesti√≥n en bit√°cora', action: () => { showView('bitacora'); setTimeout(() => switchBitacoraTabEmbedded && switchBitacoraTabEmbedded('registrar'), 100); } },
            { id: 'action_upload', icon: 'üì§', title: 'Actualizar Base', subtitle: 'Subir archivo de base de datos', action: () => showView('actualizar') }
        ];

        /**
         * Initialize global search keyboard shortcut
         */
        function initGlobalSearch() {
            document.addEventListener('keydown', function (e) {
                // Ctrl+K or Cmd+K
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    toggleCommandPalette();
                }
                // Escape to close
                if (e.key === 'Escape' && COMMAND_PALETTE_OPEN) {
                    closeCommandPalette();
                }
                // Arrow navigation
                if (COMMAND_PALETTE_OPEN) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        COMMAND_SELECTED_INDEX = Math.min(COMMAND_SELECTED_INDEX + 1, COMMAND_PALETTE_ITEMS.length - 1);
                        updateCommandSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        COMMAND_SELECTED_INDEX = Math.max(COMMAND_SELECTED_INDEX - 1, 0);
                        updateCommandSelection();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        executeSelectedCommand();
                    }
                }
            });
        }

        function toggleCommandPalette() {
            if (COMMAND_PALETTE_OPEN) {
                closeCommandPalette();
            } else {
                openCommandPalette();
            }
        }

        function openCommandPalette() {
            // Check feature flag
            google.script.run
                .withSuccessHandler(function (enabled) {
                    if (!enabled) {
                        console.log('[GlobalSearch] Feature disabled');
                        return;
                    }
                    showCommandPalette();
                })
                .withFailureHandler(function () {
                    showCommandPalette(); // Fallback: show anyway
                })
                .getFeatureFlag('GLOBAL_SEARCH_ENABLED');
        }

        function showCommandPalette() {
            let overlay = document.getElementById('commandPaletteOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'commandPaletteOverlay';
                overlay.className = 'tp-command-overlay';
                overlay.onclick = function (e) { if (e.target === overlay) closeCommandPalette(); };
                overlay.innerHTML = `
                    <div class="tp-command-palette">
                        <div class="tp-command-input-wrapper">
                            <span style="font-size: 18px;">üîç</span>
                            <input type="text" id="commandInput" class="tp-command-input" placeholder="Buscar asegurados, acciones..." autocomplete="off" oninput="filterCommands()">
                            <span class="tp-command-shortcut">Esc para cerrar</span>
                        </div>
                        <div class="tp-command-results" id="commandResults"></div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            overlay.style.display = 'flex';
            COMMAND_PALETTE_OPEN = true;
            COMMAND_SELECTED_INDEX = 0;

            // Focus input
            setTimeout(() => {
                const input = document.getElementById('commandInput');
                if (input) {
                    input.value = '';
                    input.focus();
                }
                filterCommands();
            }, 50);
        }

        function closeCommandPalette() {
            const overlay = document.getElementById('commandPaletteOverlay');
            if (overlay) overlay.style.display = 'none';
            COMMAND_PALETTE_OPEN = false;
        }

        function filterCommands() {
            const input = document.getElementById('commandInput');
            const query = (input?.value || '').toLowerCase().trim();
            const results = document.getElementById('commandResults');
            if (!results) return;

            // Build results: Actions + Asegurados (from cache)
            COMMAND_PALETTE_ITEMS = [];
            let html = '';

            // Filter actions
            const matchingActions = COMMAND_ACTIONS.filter(a =>
                a.title.toLowerCase().includes(query) ||
                a.subtitle.toLowerCase().includes(query)
            );

            if (matchingActions.length > 0) {
                html += '<div class="tp-command-group"><div class="tp-command-group-label">Acciones</div>';
                matchingActions.forEach((a, idx) => {
                    COMMAND_PALETTE_ITEMS.push({ type: 'action', data: a });
                    html += `
                        <div class="tp-command-item ${idx === 0 ? 'selected' : ''}" data-index="${COMMAND_PALETTE_ITEMS.length - 1}" onclick="executeCommand(${COMMAND_PALETTE_ITEMS.length - 1})">
                            <div class="tp-command-icon">${a.icon}</div>
                            <div class="tp-command-text">
                                <div class="tp-command-title">${a.title}</div>
                                <div class="tp-command-subtitle">${a.subtitle}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Filter asegurados from cache (if available)
            if (query.length >= 2 && window.ASEGURADOS_DS && ASEGURADOS_DS.items) {
                const matchingAseg = ASEGURADOS_DS.items.filter(item =>
                    item.label.toLowerCase().includes(query)
                ).slice(0, 5);

                if (matchingAseg.length > 0) {
                    html += '<div class="tp-command-group"><div class="tp-command-group-label">Asegurados</div>';
                    matchingAseg.forEach(a => {
                        COMMAND_PALETTE_ITEMS.push({ type: 'asegurado', data: a });
                        html += `
                            <div class="tp-command-item" data-index="${COMMAND_PALETTE_ITEMS.length - 1}" onclick="executeCommand(${COMMAND_PALETTE_ITEMS.length - 1})">
                                <div class="tp-command-icon">üè¢</div>
                                <div class="tp-command-text">
                                    <div class="tp-command-title">${a.label}</div>
                                    <div class="tp-command-subtitle">Ver EECC</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            if (COMMAND_PALETTE_ITEMS.length === 0) {
                html = '<div class="tp-command-empty">No se encontraron resultados</div>';
            }

            results.innerHTML = html;
            COMMAND_SELECTED_INDEX = 0;
        }

        function updateCommandSelection() {
            const items = document.querySelectorAll('.tp-command-item');
            items.forEach((el, idx) => {
                el.classList.toggle('selected', idx === COMMAND_SELECTED_INDEX);
            });
        }

        function executeSelectedCommand() {
            if (COMMAND_PALETTE_ITEMS[COMMAND_SELECTED_INDEX]) {
                executeCommand(COMMAND_SELECTED_INDEX);
            }
        }

        function executeCommand(index) {
            const item = COMMAND_PALETTE_ITEMS[index];
            if (!item) return;

            closeCommandPalette();

            if (item.type === 'action' && item.data.action) {
                item.data.action();
            } else if (item.type === 'asegurado') {
                // Navigate to EECC view with this asegurado selected
                showView('eecc');
                setTimeout(() => {
                    const select = document.getElementById('eeccAsegurado');
                    if (select) {
                        select.value = item.data.label;
                        select.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }
        }

        // Phase 2: Fetch Paged Data
        function fetchAseguradosPaged(search = '', cursor = null, reset = false) {
            if (ASEGURADOS_DS.loading) return;

            ASEGURADOS_DS.loading = true;
            if (reset) {
                ASEGURADOS_DS.items = [];
                ASEGURADOS_DS.nextCursor = null;
                ASEGURADOS_DS.hasMore = true;
                ASEGURADOS_DS.search = search;
            }

            console.log(`[fetchPage] search="${search}" cursor=${cursor} reset=${reset}`);

            google.script.run
                .withSuccessHandler(res => {
                    ASEGURADOS_DS.loading = false;
                    if (!res.ok) {
                        console.warn('[fetchPage] Server error:', res.error);
                        // Fallback only on initial load error
                        if (reset) fallbackLoadSafe();
                        return;
                    }

                    if (reset) ASEGURADOS_DS.items = res.items || [];
                    else ASEGURADOS_DS.items = [...ASEGURADOS_DS.items, ...(res.items || [])];

                    ASEGURADOS_DS.nextCursor = res.nextCursor;
                    ASEGURADOS_DS.hasMore = res.hasMore;

                    // Compatibilidad legacy (partial list)
                    ALL_CLIENTES = ASEGURADOS_DS.items;

                    // Update UI
                    renderAutocompleteOptionsEECC();
                    log(`${ASEGURADOS_DS.items.length} asegurados cargados (Paginado)`, 'success');
                })
                .withFailureHandler(err => {
                    ASEGURADOS_DS.loading = false;
                    console.error('[fetchPage] Fatal:', err);
                    if (reset) fallbackLoadSafe();
                })
                .getAseguradosPaged(TOKEN, { limit: 50, cursor: cursor, search: search });
        }

        function fallbackLoadSafe() {
            console.log('[Fallback] Reverting to getAseguradosSafe...');
            google.script.run
                .withSuccessHandler(res => {
                    if (res.ok) {
                        ALL_CLIENTES = res.list || [];
                        ASEGURADOS_DS.items = ALL_CLIENTES;
                        ASEGURADOS_DS.hasMore = false;
                        renderAutocompleteOptionsEECC();
                        log(`Fallback exitoso: ${ALL_CLIENTES.length} clientes`, 'warning');
                    } else {
                        alert('Error cr√≠tico cargando asegurados: ' + res.error);
                    }
                })
                .getAseguradosSafe(TOKEN);
        }

        function loadAsegurados() {
            log('Cargando asegurados (v2)...');
            // Initial load: Page 1, no search
            fetchAseguradosPaged('', null, true);
        }

        function loadGrupos() {
            console.log('[loadGrupos] Cargando grupos...');
            google.script.run
                .withSuccessHandler(response => {
                    if (response.ok) {
                        ALL_GRUPOS = response.data;
                        console.log(`[loadGrupos] ‚úÖ ${ALL_GRUPOS.length} grupos cargados`);
                    } else {
                        console.error('[loadGrupos] Error:', response.error);
                    }
                })
                .withFailureHandler(error => {
                    console.error('[loadGrupos] Error fatal:', error);
                })
                .getGrupos_API(TOKEN);
        }

        function toggleEECCMode() {
            const radios = document.getElementsByName('eeccMode');
            for (const radio of radios) {
                if (radio.checked) {
                    EECC_MODE = radio.value;
                    break;
                }
            }
            console.log('[toggleEECCMode] Modo:', EECC_MODE);

            // Limpiar y actualizar autocomplete
            limpiarAutocompleteEECC();

            // Actualizar placeholder
            const input = document.getElementById('aseguradoSelect');
            if (input) {
                input.placeholder = EECC_MODE === 'grupo' ? 'Buscar grupo econ√≥mico...' : 'Escribe o selecciona un cliente...';
            }

            // Actualizar opciones disponibles
            if (EECC_MODE === 'grupo') {
                AUTOCOMPLETE_EECC_OPTIONS = [...ALL_GRUPOS];
            } else {
                AUTOCOMPLETE_EECC_OPTIONS = [...ALL_CLIENTES];
            }
        }

        function toggleBitacoraMode() {
            const radios = document.getElementsByName('bitacoraMode');
            for (const radio of radios) {
                if (radio.checked) {
                    BITACORA_MODE = radio.value;
                    break;
                }
            }
            console.log('[toggleBitacoraMode] Modo:', BITACORA_MODE);

            // Limpiar y actualizar autocomplete
            limpiarAutocomplete();

            // Actualizar placeholder
            const input = document.getElementById('gestionAsegurado');
            if (input) {
                input.placeholder = BITACORA_MODE === 'grupo' ? 'Buscar grupo econ√≥mico...' : 'Escribe o selecciona un cliente...';
            }

            // Actualizar opciones disponibles
            if (BITACORA_MODE === 'grupo') {
                AUTOCOMPLETE_OPTIONS = [...ALL_GRUPOS];
            } else {
                AUTOCOMPLETE_OPTIONS = [...ALL_CLIENTES];
            }
        }

        // ============================================================
        // AUTOCOMPLETE PARA GENERAR EECC
        // ============================================================

        let AUTOCOMPLETE_EECC_OPTIONS = [];
        let AUTOCOMPLETE_EECC_FILTERED = [];
        let AUTOCOMPLETE_EECC_SELECTED_INDEX = -1;

        // NEW: Validation helper for Generate button
        function toggleGenerarBtnState() {
            const input = document.getElementById('aseguradoSelect');
            const btn = document.getElementById('generateBtn');
            if (input && btn) {
                // Enable if input has text (simple validation for paged data)
                btn.disabled = !input.value || input.value.trim() === '';
            }
        }

        function filtrarAutocompleteEECC() {
            toggleGenerarBtnState();  // Enable/Disable on typing
            const input = document.getElementById('aseguradoSelect');
            const dropdown = document.getElementById('autocompleteDropdownEECC');
            const optionsContainer = document.getElementById('autocompleteOptionsEECC');
            const clearBtn = document.getElementById('clearAseguradoEECC');
            const counter = document.getElementById('autocompleteCounterEECC');

            if (!input || !dropdown || !optionsContainer) return;

            const searchText = input.value;
            clearBtn.style.display = searchText ? 'flex' : 'none';

            // MODE: Grupo (Client Side)
            if (EECC_MODE === 'grupo') {
                const normalized = normalizeText(searchText);
                if (!searchText) {
                    AUTOCOMPLETE_EECC_FILTERED = [...ALL_GRUPOS];
                } else {
                    AUTOCOMPLETE_EECC_FILTERED = ALL_GRUPOS.filter(o => normalizeText(o).includes(normalized));
                }
                renderAutocompleteOptionsEECC();
                if (searchText) dropdown.style.display = 'block';
                return;
            }

            // MODE: Asegurado (Server Side Paged - Debounced)
            if (SEARCH_TIMEOUT) clearTimeout(SEARCH_TIMEOUT);

            SEARCH_TIMEOUT = setTimeout(() => {
                // If search changed, fetch new
                if (searchText !== ASEGURADOS_DS.search) {
                    fetchAseguradosPaged(searchText, null, true);
                }
                dropdown.style.display = 'block';
            }, 300);
        }

        function renderAutocompleteOptionsEECC() {
            const optionsContainer = document.getElementById('autocompleteOptionsEECC');
            if (!optionsContainer) return;

            optionsContainer.innerHTML = '';

            // Loading Indicator
            if (EECC_MODE === 'asegurado' && ASEGURADOS_DS.loading && ASEGURADOS_DS.items.length === 0) {
                optionsContainer.innerHTML = '<div class="autocomplete-option disabled">‚è≥ Cargando...</div>';
                return;
            }

            let list = [];
            if (EECC_MODE === 'grupo') {
                list = AUTOCOMPLETE_EECC_FILTERED;
            } else {
                list = ASEGURADOS_DS.items;
            }

            if (list.length === 0) {
                if (EECC_MODE === 'asegurado' && ASEGURADOS_DS.loading) {
                    // Loading more...
                } else {
                    optionsContainer.innerHTML = '<div class="autocomplete-option disabled">‚ùå Sin resultados</div>';
                    return;
                }
            }

            list.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'autocomplete-option';
                div.textContent = opt;
                div.onclick = () => seleccionarOpcionAutocompleteEECC(opt);
                optionsContainer.appendChild(div);
            });

            // Load More Button
            if (EECC_MODE === 'asegurado' && ASEGURADOS_DS.hasMore) {
                const loadMore = document.createElement('div');
                loadMore.className = 'autocomplete-option load-more';
                loadMore.style.textAlign = 'center';
                loadMore.style.color = 'var(--tp-primary)';
                loadMore.style.fontWeight = 'bold';
                loadMore.style.borderTop = '1px solid var(--tp-border-light)';

                if (ASEGURADOS_DS.loading) {
                    loadMore.textContent = '‚è≥ Cargando m√°s...';
                } else {
                    loadMore.textContent = '‚¨áÔ∏è Cargar m√°s...';
                    loadMore.onclick = (e) => {
                        e.stopPropagation();
                        // input value might have changed without debounce firing
                        const input = document.getElementById('aseguradoSelect');
                        fetchAseguradosPaged(input.value, ASEGURADOS_DS.nextCursor, false);
                    };
                }
                optionsContainer.appendChild(loadMore);
            }
        }

        function seleccionarOpcionAutocompleteEECC(value) {
            const input = document.getElementById('aseguradoSelect');
            const dropdown = document.getElementById('autocompleteDropdownEECC');
            const clearBtn = document.getElementById('clearAseguradoEECC');
            const counter = document.getElementById('autocompleteCounterEECC');

            if (input) {
                input.value = value;
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }

            if (clearBtn) {
                clearBtn.style.display = 'flex';
            }

            if (counter) {
                counter.style.display = 'none';
            }

            console.log('[seleccionarOpcionAutocompleteEECC] Seleccionado:', value);
            toggleGenerarBtnState(); // Enable button on selection
        }

        function mostrarDropdownAutocompleteEECC() {
            const dropdown = document.getElementById('autocompleteDropdownEECC');
            const input = document.getElementById('aseguradoSelect');

            if (!dropdown || !input) return;

            // Phase 2: Ensure initial data
            if (EECC_MODE === 'asegurado') {
                if (ASEGURADOS_DS.items.length === 0 && !ASEGURADOS_DS.loading) {
                    fetchAseguradosPaged('', null, true);
                }
            } else if (EECC_MODE === 'grupo') {
                if (!input.value.trim()) {
                    AUTOCOMPLETE_EECC_FILTERED = [...ALL_GRUPOS];
                    renderAutocompleteOptionsEECC();
                }
            }

            dropdown.style.display = 'block';
        }

        function toggleDropdownAutocompleteEECC() {
            const dropdown = document.getElementById('autocompleteDropdownEECC');
            const input = document.getElementById('aseguradoSelect');

            if (!dropdown) return;

            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                AUTOCOMPLETE_EECC_FILTERED = [...AUTOCOMPLETE_EECC_OPTIONS];
                renderAutocompleteOptionsEECC();
                dropdown.style.display = 'block';

                if (input) {
                    input.focus();
                }
            } else {
                dropdown.style.display = 'none';
            }
        }

        function limpiarAutocompleteEECC() {
            const input = document.getElementById('aseguradoSelect');
            const dropdown = document.getElementById('autocompleteDropdownEECC');
            const clearBtn = document.getElementById('clearAseguradoEECC');
            const counter = document.getElementById('autocompleteCounterEECC');

            if (input) {
                input.value = '';
                input.focus();
                toggleGenerarBtnState(); // Disable button
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }

            if (clearBtn) {
                clearBtn.style.display = 'none';
            }

            if (counter) {
                counter.style.display = 'none';
            }

            console.log('[limpiarAutocompleteEECC] Autocomplete limpiado');
        }

        function highlightAutocompleteOptionEECC(index) {
            const options = document.querySelectorAll('#autocompleteOptionsEECC .autocomplete-option');
            options.forEach((opt, i) => {
                if (i === index) {
                    opt.classList.add('autocomplete-option-highlighted');
                } else {
                    opt.classList.remove('autocomplete-option-highlighted');
                }
            });
        }

        // ============================================================
        // ACTUALIZAR BASE DE DATOS (UPLOAD)
        // ============================================================
        // Helper para log de upload
        function uploadLog(message, type = 'info') {
            const logContainer = document.getElementById('uploadActivityLog');
            const logEntries = document.getElementById('uploadLogEntries');
            if (!logContainer || !logEntries) return;

            logContainer.style.display = 'block';
            const time = new Date().toLocaleTimeString('es-PE');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            let icon = '‚Ä¢';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'warning') icon = '‚ö†Ô∏è';
            entry.innerHTML = `<span style="color: var(--tp-text-tertiary);">${time}</span> ${icon} ${message}`;
            logEntries.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const hasHeader = document.getElementById('hasHeader').checked;
            const btn = document.getElementById('uploadBtn');
            const logEntries = document.getElementById('uploadLogEntries');

            // Limpiar log anterior
            if (logEntries) logEntries.innerHTML = '';

            if (!fileInput.files.length) {
                alert('Selecciona un archivo');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            log(`üì§ Subiendo: ${file.name}`, 'info');
            uploadLog(`Iniciando carga de: ${file.name}`, 'info');
            uploadLog(`Tama√±o: ${(file.size / 1024).toFixed(2)} KB`, 'info');
            btn.disabled = true;
            btn.textContent = 'Subiendo...';
            showLoading(true, 'Procesando archivo...');

            reader.onload = e => {
                const base64 = e.target.result.split(',')[1];
                uploadLog('Archivo le√≠do correctamente', 'success');
                uploadLog('Enviando al servidor...', 'info');

                google.script.run
                    .withSuccessHandler(result => {
                        showLoading(false);
                        btn.disabled = false;
                        btn.textContent = 'Subir y actualizar';

                        if (result && result.ok) {
                            const mensaje = result.mensaje || result.message || 'Base actualizada';
                            const filas = result.filas || result.rows || 0;
                            const duplicados = result.duplicados || 0;
                            const nuevos = result.nuevos || 0;

                            log(`‚úÖ ${mensaje}`, 'success');
                            uploadLog(`Procesamiento completado`, 'success');
                            uploadLog(`üìä Filas procesadas: ${filas}`, 'success');
                            if (duplicados > 0) {
                                uploadLog(`üîÑ Cupones duplicados omitidos: ${duplicados}`, 'warning');
                            }
                            if (nuevos > 0) {
                                uploadLog(`‚ú® Registros nuevos agregados: ${nuevos}`, 'success');
                            }
                            uploadLog(`Base de datos actualizada exitosamente`, 'success');

                            showStatus('uploadStatus', mensaje, 'success');
                            showToast(`Base actualizada: ${filas} filas`, 'success');
                            fileInput.value = '';
                            loadAsegurados();
                            loadGrupos();
                            checkLogin();
                        } else {
                            const error = result?.mensaje || result?.error || 'Error desconocido';
                            log(`‚ùå ${error}`, 'error');
                            uploadLog(`Error: ${error}`, 'error');
                            showStatus('uploadStatus', error, 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        showLoading(false);
                        btn.disabled = false;
                        btn.textContent = 'Subir y actualizar';
                        log(`‚ùå ${error.message}`, 'error');
                        uploadLog(`Error fatal: ${error.message}`, 'error');
                        showStatus('uploadStatus', error.message, 'error');
                    })
                    .subirArchivoBase({
                        name: file.name,
                        mimeType: file.type,
                        dataBase64: base64,
                        tieneEncabezado: hasHeader
                    }, TOKEN);
            };

            reader.readAsDataURL(file);
        }

        // ============================================================
        // OBS TOGGLE
        // ============================================================
        function toggleObs() {
            INCLUDE_OBS = !INCLUDE_OBS;
            const container = document.getElementById('ramSelectContainer');
            const btn = document.getElementById('obsBtn');

            if (INCLUDE_OBS) {
                container.classList.remove('hidden');
                btn.textContent = 'üìù Quitar OBS';

                // Cargar RAMs instant√°neamente del asegurado seleccionado
                const asegurado = document.getElementById('aseguradoSelect').value;
                if (asegurado) {
                    console.log('[toggleObs] Cargando RAMs para:', asegurado);

                    // Mostrar loading en el select
                    const ramSelect = document.getElementById('ramSelect');
                    ramSelect.innerHTML = '<option>‚è≥ Cargando RAMs...</option>';

                    // Cargar RAMs desde el servidor
                    google.script.run
                        .withSuccessHandler(result => {
                            if (result && result.rams && result.rams.length > 0) {
                                ramSelect.innerHTML = '<option value="__ALL__" selected>Todos los RAM</option>' +
                                    result.rams.map(r => `<option value="${r}">${r}</option>`).join('');
                                console.log('[toggleObs] ‚úÖ RAMs cargados:', result.rams.length);
                            } else {
                                ramSelect.innerHTML = '<option value="__ALL__">Todos los RAM</option>';
                                console.log('[toggleObs] ‚ö†Ô∏è No hay RAMs disponibles');
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('[toggleObs] Error al cargar RAMs:', error);
                            ramSelect.innerHTML = '<option value="__ALL__">Todos los RAM</option>';
                        })
                        .previewAsegurado(asegurado, 1, false, null, TOKEN);
                }
            } else {
                container.classList.add('hidden');
                btn.textContent = 'üìù Agregar OBS';
            }
        }

        /**
         * Toggle Power BI Dashboard (collapse/expand)
         */
        function togglePowerBI() {
            const toggle = document.querySelector('.pbi-toggle');
            const content = document.getElementById('pbiContent');
            const icon = document.querySelector('.pbi-toggle-icon');

            if (toggle.classList.contains('collapsed')) {
                // Expandir
                toggle.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.textContent = '‚ñ≤';
                log('Dashboard PBI expandido', 'info');
            } else {
                // Colapsar
                toggle.classList.add('collapsed');
                content.classList.remove('expanded');
                icon.textContent = '‚ñº';
            }
        }

        // ============================================================
        // PREVISUALIZACI√ìN
        // ============================================================
        function handlePreview() {
            const asegurado = document.getElementById('aseguradoSelect').value;
            if (!asegurado) {
                alert('Selecciona un asegurado');
                return;
            }

            const btn = document.getElementById('previewBtn');
            btn.disabled = true;
            btn.textContent = 'Cargando...';
            log(`Preview para ${asegurado}...`);

            let obsForRAM = '__ALL__';
            if (INCLUDE_OBS) {
                const ramSelect = document.getElementById('ramSelect');
                const selected = Array.from(ramSelect.selectedOptions).map(opt => opt.value);
                obsForRAM = selected.length === 0 || selected.includes('__ALL__') ? '__ALL__' : selected;
            }

            google.script.run
                .withSuccessHandler(result => {
                    btn.disabled = false;
                    btn.textContent = 'üëÅ Previsualizar';

                    if (!result || !result.rows) {
                        alert('No hay datos');
                        return;
                    }

                    PREVIEW_DATA = result;

                    // Actualizar lista de RAMs si OBS est√° activado
                    if (INCLUDE_OBS && result.rams) {
                        const ramSelect = document.getElementById('ramSelect');
                        ramSelect.innerHTML = '<option value="__ALL__">Todos los RAM</option>' +
                            result.rams.map(r => `<option value="${r}">${r}</option>`).join('');
                    }

                    // Mostrar la secci√≥n de previsualizaci√≥n
                    document.getElementById('previewSection').classList.remove('hidden');
                    document.getElementById('previewCount').textContent = `${result.total} registros`;

                    // Renderizar tabla
                    const thead = document.getElementById('previewTableHead');
                    const tbody = document.getElementById('previewTableBody');

                    thead.innerHTML = '<tr><th>Excluir</th>' +
                        result.headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

                    tbody.innerHTML = result.rows.map((row, idx) => {
                        const cells = row.map((cell, cellIdx) => {
                            const className = result.headers[cellIdx] === 'IMPORTE' ? 'cell-number' :
                                result.headers[cellIdx] === 'D√çAS' ? 'cell-center' : '';
                            return `<td class="${className}">${cell || ''}</td>`;
                        }).join('');
                        return `<tr><td class="cell-center"><input type="checkbox" data-idx="${idx + 1}"></td>${cells}</tr>`;
                    }).join('');

                    log(`Preview cargado: ${result.total} registros`, 'success');
                })
                .withFailureHandler(error => {
                    btn.disabled = false;
                    btn.textContent = 'üëÅ Previsualizar';
                    alert('Error: ' + error.message);
                    log('Error: ' + error.message, 'error');
                })
                .previewAsegurado(asegurado, 200, INCLUDE_OBS, obsForRAM, TOKEN);
        }

        // ============================================================
        // GENERAR ESTADO DE CUENTA
        // ============================================================
        function handleGenerate() {
            const asegurado = document.getElementById('aseguradoSelect').value;
            if (!asegurado) {
                alert('Selecciona un asegurado');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Generando...';
            document.getElementById('downloadLinks').classList.add('hidden');

            const { exportPdf, exportXlsx } = getExportType();

            // Leer checkboxes directamente de la tabla visible
            const checkboxes = document.querySelectorAll('#previewTableBody input[type="checkbox"]:checked');
            const rowsToSkip = Array.from(checkboxes).map(cb => Number(cb.dataset.idx));

            // Obtener RAMs seleccionados
            let obsForRAM = '__ALL__';
            if (INCLUDE_OBS) {
                const ramSelect = document.getElementById('ramSelect');
                const selected = Array.from(ramSelect.selectedOptions).map(opt => opt.value);
                obsForRAM = selected.length === 0 || selected.includes('__ALL__') ? '__ALL__' : selected;
            }

            log(`Generando EECC para ${asegurado}...`);

            // GRUPO_ECONOMICO - L√≥gica condicional
            // GRUPO_ECONOMICO - L√≥gica secuencial desde Frontend (para evitar timeouts)
            if (EECC_MODE === 'grupo') {
                showStatus('generateStatus', 'Obteniendo miembros del grupo...', 'info');

                // 1. Obtener lista de asegurados del grupo
                google.script.run
                    .withSuccessHandler(async (response) => {
                        if (!response || !response.ok || !response.data || response.data.length === 0) {
                            btn.disabled = false;
                            btn.textContent = '‚öô Generar';
                            showStatus('generateStatus', 'Error: El grupo no tiene asegurados o no existe', 'error');
                            return;
                        }

                        const asegurados = response.data;
                        const total = asegurados.length;
                        const results = [];
                        let successCount = 0;
                        let errorCount = 0;

                        log(`Grupo ${asegurado} tiene ${total} asegurados. Iniciando generaci√≥n secuencial...`);

                        // 2. Iterar secuencialmente (uno por uno)
                        for (let i = 0; i < total; i++) {
                            const currentAsegurado = asegurados[i];
                            const progressMsg = `Generando ${i + 1}/${total}: ${currentAsegurado}...`;

                            showStatus('generateStatus', progressMsg, 'info');
                            btn.textContent = `‚öô ${Math.round(((i) / total) * 100)}%`;

                            try {
                                // Promesa para envolver google.script.run
                                const result = await new Promise((resolve, reject) => {
                                    google.script.run
                                        .withSuccessHandler(resolve)
                                        .withFailureHandler(reject)
                                        .generateHeadless_API(currentAsegurado, {
                                            exportPdf: exportPdf,
                                            exportXlsx: exportXlsx,
                                            includeObs: INCLUDE_OBS,
                                            obsForRAM: obsForRAM,
                                            rowsToSkip: [] // No aplicar skip rows en grupo
                                        }, TOKEN);
                                });

                                if (result.ok) {
                                    successCount++;
                                    results.push({
                                        asegurado: currentAsegurado,
                                        pdfUrl: result.pdfUrl,
                                        xlsxUrl: result.xlsxUrl
                                    });
                                    log(`‚úÖ ${currentAsegurado} generado OK`, 'success');
                                } else {
                                    errorCount++;
                                    log(`‚ùå ${currentAsegurado} fall√≥: ${result.error}`, 'error');
                                }

                            } catch (err) {
                                errorCount++;
                                log(`‚ùå Error cr√≠tico en ${currentAsegurado}: ${err.message}`, 'error');
                            }

                            // Peque√±a pausa para no saturar UI
                            await new Promise(r => setTimeout(r, 500));
                        }

                        // 3. Finalizar
                        btn.disabled = false;
                        btn.textContent = '‚öô Generar';

                        const finalMsg = `Generaci√≥n grupal completada. √âxitos: ${successCount}/${total}`;
                        showStatus('generateStatus', finalMsg, errorCount > 0 ? 'warning' : 'success');
                        showToast(finalMsg, errorCount > 0 ? 'warning' : 'success');

                        // Mostrar resultados en tabla compacta
                        if (results.length > 0) {
                            const container = document.getElementById('linksContainer');
                            const footer = document.getElementById('generatedFilesFooter');
                            const downloadLinks = document.getElementById('downloadLinks');

                            // Construir tabla interna
                            let tableHtml = `
                                <table class="generated-files-table">
                                    <thead>
                                        <tr>
                                            <th>Asegurado</th>
                                            <th class="text-center">PDF</th>
                                            <th class="text-center">Excel</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;

                            const allFileUrls = [];

                            results.forEach(res => {
                                let pdfLink = '<span class="text-muted">-</span>';
                                let xlsxLink = '<span class="text-muted">-</span>';

                                if (res.pdfUrl) {
                                    pdfLink = `<a href="${res.pdfUrl}" target="_blank" class="btn btn-sm btn-outline-danger" title="Ver PDF" style="padding: 2px 8px; font-size: 0.75rem;">üìÑ PDF</a>`;
                                    allFileUrls.push(res.pdfUrl);
                                }

                                if (res.xlsxUrl) {
                                    xlsxLink = `<a href="${res.xlsxUrl}" target="_blank" class="btn btn-sm btn-outline-success" title="Ver Excel" style="padding: 2px 8px; font-size: 0.75rem;">üìä Excel</a>`;
                                    allFileUrls.push(res.xlsxUrl);
                                }

                                tableHtml += `
                                    <tr>
                                        <td>${res.asegurado}</td>
                                        <td class="text-center">${pdfLink}</td>
                                        <td class="text-center">${xlsxLink}</td>
                                    </tr>
                                `;
                            });

                            tableHtml += `</tbody></table>`;

                            // Inyectar tabla en el cuerpo
                            container.innerHTML = tableHtml;

                            // Bot√≥n ZIP en el footer
                            if (allFileUrls.length > 0) {
                                footer.innerHTML = `
                                    <div class="d-grid">
                                        <button id="btnDownloadZip" class="btn btn-primary" onclick="downloadZip('${asegurado}', ${JSON.stringify(allFileUrls).replace(/"/g, '&quot;')})" style="width: 100%">
                                            üì¶ Descargar Todo (ZIP)
                                        </button>
                                        <div id="zipStatus" class="text-center text-muted small mt-1"></div>
                                    </div>
                                `;
                                footer.classList.remove('hidden');
                            } else {
                                footer.classList.add('hidden');
                            }

                            // Mostrar tarjeta
                            downloadLinks.classList.remove('hidden');

                            // Si son muchos, colapsar por defecto (opcional, aqu√≠ lo dejamos expandido pero con scroll)
                            // Si se prefiere colapsar si > 5 items:
                            if (results.length > 10) {
                                downloadLinks.classList.remove('expanded');
                            } else {
                                downloadLinks.classList.add('expanded');
                            }
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btn.textContent = '‚öô Generar';
                        showStatus('generateStatus', 'Error al obtener grupo: ' + error.message, 'error');
                    })
                    .getAseguradosPorGrupo_API(asegurado, TOKEN);

            } else {
                // L√≥gica original para asegurado individual
                google.script.run
                    .withSuccessHandler(result => {
                        btn.disabled = false;
                        btn.textContent = '‚öô Generar';

                        if (result && result.ok) {
                            showStatus('generateStatus', 'Generaci√≥n exitosa', 'success');
                            showToast('EECC generado exitosamente', 'success');
                            log('EECC generado', 'success');

                            const links = [];
                            if (result.pdfUrl) links.push(`<a href="${result.pdfUrl}" target="_blank" class="btn btn-secondary">üìÑ PDF</a>`);
                            if (result.xlsxUrl) links.push(`<a href="${result.xlsxUrl}" target="_blank" class="btn btn-secondary">üìä XLSX</a>`);

                            if (links.length > 0) {
                                document.getElementById('linksContainer').innerHTML = links.join('');
                                document.getElementById('downloadLinks').classList.remove('hidden');
                            }
                        } else {
                            showStatus('generateStatus', 'Error: ' + (result?.error || 'desconocido'), 'error');
                            showToast('Error al generar EECC', 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btn.textContent = '‚öô Generar';
                        showStatus('generateStatus', 'Error: ' + error.message, 'error');
                        showToast('Error: ' + error.message, 'error');
                        log('Error: ' + error.message, 'error');
                    })
                    .generateForAsegurado_API(asegurado, {
                        exportPdf,
                        exportXlsx,
                        rowsToSkip,
                        includeObs: INCLUDE_OBS,
                        obsForRAM
                    }, TOKEN);
            }
        }

        /**
         * Toggle para la secci√≥n de archivos generados
         */
        function toggleGeneratedFiles() {
            const card = document.getElementById('downloadLinks');
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // ============================================================
        // MODAL DE CORREO: APERTURA Y PESTA√ëAS
        // ============================================================

        /**
         * [NUEVO] Abre el drawer de env√≠o de correos como iframe externo
         * Usa ui_send_drawer.html con todas las mejoras (filtros, plantillas, scheduling)
         */
        /**
         * [NUEVO] Abre el drawer de env√≠o de correos inyectando HTML (SPA)
         * Evita problemas de iframe/auth en Google Workspace
         */
        function openExternalDrawer() {
            // Crear overlay
            const overlay = document.createElement('div');
            overlay.id = 'drawerOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
            `;

            // Crear container
            const container = document.createElement('div');
            container.style.cssText = `
                width: 98%;
                max-width: 1200px;
                height: 98%;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                overflow: hidden;
                position: relative;
                display: flex;
                flex-direction: column;
            `;

            // Loader inicial
            container.innerHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">
                    <div class="spinner"></div>
                    <div style="color: #666;">Cargando m√≥dulo de env√≠os...</div>
                </div>
                <button onclick="document.getElementById('drawerOverlay').remove()" style="position: absolute; top: 10px; right: 10px; border: none; background: none; font-size: 24px; cursor: pointer;">√ó</button>
            `;

            overlay.appendChild(container);
            document.body.appendChild(overlay);

            // Fade in
            requestAnimationFrame(() => overlay.style.opacity = '1');

            // Cargar contenido
            google.script.run
                .withSuccessHandler(html => {
                    // Limpiar loader
                    container.innerHTML = '';

                    // Bot√≥n cerrar (re-agregar)
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '√ó';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: #D32F2F;
                        color: white;
                        border: none;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        font-size: 24px;
                        cursor: pointer;
                        z-index: 10001;
                        line-height: 28px;
                        text-align: center;
                    `;
                    closeBtn.onclick = () => {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 300);
                    };
                    container.appendChild(closeBtn);

                    // Contenedor de contenido
                    const contentDiv = document.createElement('div');
                    contentDiv.style.cssText = 'width: 100%; height: 100%; overflow: hidden;';
                    container.appendChild(contentDiv);

                    // Inyectar HTML y ejecutar scripts
                    const temp = document.createElement('div');
                    temp.innerHTML = html;

                    // 1. Mover estilos al head (opcional, pero limpio)
                    const styles = temp.querySelectorAll('style');
                    styles.forEach(style => document.head.appendChild(style));

                    // 2. Mover contenido body
                    // Buscamos si hay un body expl√≠cito o tomamos todo
                    // Al inyectar innerHTML de un documento completo, el navegador suele ignorar html/head/body tags y dejar el contenido
                    // As√≠ que tomamos los hijos directos que no sean script/style

                    // Simplemente inyectamos todo el HTML limpio
                    // Quitamos scripts para ejecutarlos manualmente
                    const scripts = temp.querySelectorAll('script');
                    scripts.forEach(s => s.remove());
                    styles.forEach(s => s.remove()); // Ya movidos

                    contentDiv.innerHTML = temp.innerHTML;

                    // 3. Ejecutar scripts
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        contentDiv.appendChild(newScript);
                    });

                    // 4. Inicializar expl√≠citamente (SPA Init)
                    if (window.initDrawer) {
                        window.initDrawer();
                    } else {
                        // Fallback por si el script tarda en parsearse
                        setTimeout(() => {
                            if (window.initDrawer) window.initDrawer();
                        }, 100);
                    }

                    log('M√≥dulo cargado correctamente (SPA)', 'success');
                })
                .withFailureHandler(error => {
                    container.innerHTML = `
                        <div style="padding: 2rem; color: #D32F2F; text-align: center;">
                            <h3>‚ùå Error al cargar</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-secondary" onclick="document.getElementById('drawerOverlay').remove()">Cerrar</button>
                        </div>
                    `;
                    log('Error cargando m√≥dulo', error.message, 'error');
                })
                .getDrawerContent();
        }

        /**
         * [LEGACY] Abre el modal de correo embebido (mantenido como fallback)
         */
        function openMailModal() {
            document.getElementById('mailModal').classList.add('active');
            switchMailTab('seleccionar');
        }

        function closeMailModal() {
            document.getElementById('mailModal').classList.remove('active');
        }

        function switchMailTab(tab) {
            MAIL_STATE.currentTab = tab;

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            document.querySelector(`.tab:nth-child(${tab === 'seleccionar' ? 1 : tab === 'parametros' ? 2 : 3})`).classList.add('active');
            document.getElementById(`mail-tab-${tab}`).classList.add('active');

            if (tab === 'previsualizar') loadMailPreview();
        }

        // ============================================================
        // MODAL DE CORREO: B√öSQUEDA Y SELECCI√ìN
        // ============================================================



        function filterMailClientes() {
            const searchInput = document.getElementById('mailSearch');
            if (!searchInput) return;

            const search = normalizeText(searchInput.value);
            const select = document.getElementById('mailClientesSelect');
            const options = select.querySelectorAll('option');

            options.forEach(opt => {
                const text = normalizeText(opt.textContent);
                opt.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function updateMailSelectedCount() {
            const select = document.getElementById('mailClientesSelect');
            document.getElementById('mailSelectedCount').textContent = select.selectedOptions.length;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mailSelect = document.getElementById('mailClientesSelect');
            if (mailSelect) mailSelect.addEventListener('change', updateMailSelectedCount);
        });

        // ============================================================
        // MODAL DE CORREO: PREVISUALIZACI√ìN DE CONTENIDO
        // ============================================================
        function previewMailContent() {
            const select = document.getElementById('mailClientesSelect');
            const selected = Array.from(select.selectedOptions).map(o => o.value);

            if (selected.length === 0) {
                alert('Selecciona al menos una empresa');
                return;
            }

            const container = document.getElementById('mailPreviewContent');
            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="preview-detail">
                    <h4>üìß Asunto:</h4>
                    <p>EECC ${selected[0]} -- Corte ${document.getElementById('mailFechaCorte').value || 'HOY'}</p>
                    <h4 style="margin-top: 1rem;">üìù Cuerpo:</h4>
                    <p style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        Estimados,<br><br>Adjuntamos el Estado de Cuenta.<br><br>Saludos cordiales.
                    </p>
                    <h4 style="margin-top: 1rem;">üìé Adjuntos:</h4>
                    <p>
                        ${document.getElementById('mailPdf').checked ? '‚úÖ PDF' : '‚ùå PDF'}<br>
                        ${document.getElementById('mailXlsx').checked ? '‚úÖ XLSX' : '‚ùå XLSX'}
                    </p>
                </div>
            `;
            log('Preview de correo generado', 'success');
        }

        function loadMailPreview() {
            const select = document.getElementById('mailClientesSelect');
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            const container = document.getElementById('mailPreviewContainer');

            if (selected.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìß</div><div>Selecciona empresas</div></div>`;
                return;
            }

            MAIL_STATE.previews = selected.map(aseg => ({ aseguradoId: aseg, status: 'pending' }));
            renderMailPreview();
            document.getElementById('btnSendEmails').disabled = false;
        }

        function renderMailPreview() {
            let html = '<div class="preview-list">';
            MAIL_STATE.previews.forEach(item => {
                const statusClass = {
                    pending: 'status-pending',
                    approved: 'status-approved',
                    excluded: 'status-excluded'
                }[item.status];
                const statusText = {
                    pending: 'Pendiente',
                    approved: 'Aprobado',
                    excluded: 'Excluido'
                }[item.status];

                html += `
                <div class="preview-item">
                    <div class="preview-item-header">
                        <div class="preview-item-name">${item.aseguradoId}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="btn-group">
                        ${item.status !== 'approved' ? `<button class="btn btn-primary" onclick="approveMailItem('${item.aseguradoId}')">‚úÖ Aprobar</button>` : ''}
                        ${item.status !== 'excluded' ? `<button class="btn btn-secondary" onclick="excludeMailItem('${item.aseguradoId}')">‚ùå Excluir</button>` : ''}
                    </div>
                </div>`;
            });
            html += '</div>';

            document.getElementById('mailPreviewContainer').innerHTML = html;
            updateMailCount();
        }

        function approveMailItem(id) {
            const item = MAIL_STATE.previews.find(p => p.aseguradoId === id);
            if (item) item.status = 'approved';
            renderMailPreview();
        }

        function excludeMailItem(id) {
            const item = MAIL_STATE.previews.find(p => p.aseguradoId === id);
            if (item) item.status = 'excluded';
            renderMailPreview();
        }

        function updateMailCount() {
            const count = MAIL_STATE.previews.filter(p => p.status === 'approved').length;
            document.getElementById('mailApprovedCount').textContent = count;
        }

        // ============================================================
        // ENV√çO DE CORREOS: PRUEBA
        // ============================================================
        function sendMailTest() {
            const select = document.getElementById('mailClientesSelect');
            const selected = Array.from(select.selectedOptions).map(o => o.value);

            if (selected.length === 0) {
                alert('Selecciona al menos una empresa');
                return;
            }

            const firstClient = selected[0];

            if (!confirm(`¬øEnviar correo de PRUEBA para "${firstClient}"?\n\nSe enviar√° a tu correo con adjuntos reales.`)) return;

            showLoading(true, 'Enviando prueba...');
            log(`üß™ Enviando prueba para ${firstClient}...`, 'info');

            google.script.run
                .withSuccessHandler(result => {
                    showLoading(false);
                    if (result && result.ok) {
                        log(`‚úÖ Prueba enviada (ID: ${result.messageId})`, 'success');
                        showToast('‚úÖ Correo de prueba enviado', 'success');
                        alert(`‚úÖ Correo de prueba enviado\n\nRevisa tu bandeja.\n\nID: ${result.messageId}`);
                    } else {
                        log(`‚ùå Error: ${result?.error}`, 'error');
                        showToast(`‚ùå Error: ${result?.error}`, 'error');
                        alert(`Error:\n\n${result?.error || 'Desconocido'}`);
                    }
                })
                .withFailureHandler(error => {
                    showLoading(false);
                    log(`‚ùå Error: ${error.message}`, 'error');
                    showToast(`‚ùå Error: ${error.message}`, 'error');
                    alert(`Error:\n\n${error.message}`);
                })
                .sendTestEmail({ aseguradoId: firstClient }, TOKEN);
        }

        // ============================================================
        // ENV√çO DE CORREOS: ENV√çO REAL
        // ============================================================
        function sendEmails() {
            const approved = MAIL_STATE.previews.filter(p => p.status === 'approved');

            if (approved.length === 0) {
                alert('Aprueba al menos un √≠tem');
                return;
            }

            if (approved.length > 10) {
                alert('‚ö†Ô∏è Para lotes grandes (>10), env√≠a en tandas de 10.');
                return;
            }

            if (!confirm(`¬øENVIAR ${approved.length} CORREOS REALES?\n\n‚úâÔ∏è Se generar√°n EECC y se enviar√°n.\n\n‚ö†Ô∏è NO SE PUEDE DESHACER.`)) return;

            const btn = document.getElementById('btnSendEmails');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Enviando...';
            showLoading(true, `Enviando ${approved.length} correos...`);
            log(`üìß Iniciando env√≠o de ${approved.length} correos...`, 'info');

            const items = approved.map(item => ({ aseguradoId: item.aseguradoId }));

            google.script.run
                .withSuccessHandler(result => {
                    showLoading(false);
                    btn.disabled = false;
                    btn.innerHTML = originalText;

                    if (result && result.ok) {
                        log(`‚úÖ Completado: ${result.sent} exitosos, ${result.failed} fallidos`, 'success');

                        if (result.details) {
                            result.details.forEach(detail => {
                                if (detail.status === 'success') {
                                    log(`‚úâÔ∏è ${detail.aseguradoId}: Enviado (${detail.messageId})`, 'success');
                                } else {
                                    log(`‚ùå ${detail.aseguradoId}: ${detail.error}`, 'error');
                                }
                            });
                        }

                        showToast(`‚úÖ ${result.sent} correos enviados`, 'success');

                        if (result.failed > 0 && result.errors) {
                            let errorMsg = `‚ö†Ô∏è ${result.failed} fallidos:\n\n`;
                            result.errors.forEach(err => errorMsg += `‚Ä¢ ${err.aseguradoId}: ${err.error}\n`);
                            setTimeout(() => alert(errorMsg), 1000);
                        }

                        setTimeout(() => closeMailModal(), 2000);
                    } else {
                        log(`‚ùå Error: ${result?.error}`, 'error');
                        showToast(`‚ùå Error: ${result?.error}`, 'error');
                        alert(`Error:\n\n${result?.error || 'Desconocido'}`);
                    }
                })
                .withFailureHandler(error => {
                    showLoading(false);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    log(`‚ùå Error cr√≠tico: ${error.message}`, 'error');
                    showToast(`‚ùå Error: ${error.message}`, 'error');
                    alert(`Error cr√≠tico:\n\n${error.message}\n\nRevisa Extensiones > Apps Script > Ver > Registros`);
                })
                .sendEmailsNow(items, TOKEN);
        }

        // ============================================================
        // CERRAR MODAL AL HACER CLIC FUERA
        // ============================================================
        document.getElementById('mailModal').addEventListener('click', function (e) {
            if (e.target === this) closeMailModal();
        });

        // ============================================================
        // SISTEMA DE NOTIFICACIONES DE COMPROMISOS
        // ============================================================

        let NOTIFICACIONES = [];
        let NOTIFICATION_PANEL_OPEN = false;
        let NOTIFICACIONES_CACHE = null;
        let NOTIFICACIONES_CACHE_TIME = null;
        const NOTIFICACIONES_CACHE_DURATION = 2 * 60 * 1000; // 2 minutos

        /**
         * Toggle del panel de notificaciones
         */
        function toggleNotificaciones() {
            const panel = document.getElementById('notificationPanel');
            NOTIFICATION_PANEL_OPEN = !NOTIFICATION_PANEL_OPEN;

            if (NOTIFICATION_PANEL_OPEN) {
                panel.classList.add('active');
                cargarNotificaciones();
            } else {
                panel.classList.remove('active');
            }
        }

        /**
         * Cierra el panel al hacer clic fuera
         */
        document.addEventListener('click', function (e) {
            const panel = document.getElementById('notificationPanel');
            const btn = document.getElementById('btnNotificaciones');

            if (NOTIFICATION_PANEL_OPEN && !panel.contains(e.target) && !btn.contains(e.target)) {
                toggleNotificaciones();
            }
        });

        /**
         * Carga y procesa las notificaciones de compromisos
         * OPTIMIZADO: Usa cach√© de 2 minutos para carga instant√°nea
         */
        function cargarNotificaciones(forceRefresh = false) {
            console.log('[Notificaciones] Cargando compromisos (forceRefresh=' + forceRefresh + ')...');

            const body = document.getElementById('notificationBody');
            const ahora = Date.now();

            // ‚ö° OPTIMIZACI√ìN: Verificar cach√©
            if (!forceRefresh && NOTIFICACIONES_CACHE && NOTIFICACIONES_CACHE_TIME) {
                const tiempoTranscurrido = ahora - NOTIFICACIONES_CACHE_TIME;

                if (tiempoTranscurrido < NOTIFICACIONES_CACHE_DURATION) {
                    console.log('[Notificaciones] ‚ö° Usando cach√© (', Math.round(tiempoTranscurrido / 1000), 's de antig√ºedad)');
                    procesarNotificaciones(NOTIFICACIONES_CACHE, true); // fromCache = true
                    return;
                }
            }

            // Mostrar loader solo si no hay cach√©
            if (!NOTIFICACIONES_CACHE) {
                body.innerHTML = '<div class="notification-loading"><div class="loader-spinner"></div><p>Cargando notificaciones...</p></div>';
            } else {
                // Si hay cach√© viejo, mostrar primero y actualizar en background
                console.log('[Notificaciones] üìä Mostrando cach√© antiguo mientras actualiza...');
                procesarNotificaciones(NOTIFICACIONES_CACHE, true); // fromCache = true
            }

            // Cargar datos frescos del servidor
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[Notificaciones] ‚úÖ Respuesta recibida del servidor');

                    if (result && result.ok && result.data) {
                        // Guardar en cach√©
                        NOTIFICACIONES_CACHE = result.data;
                        NOTIFICACIONES_CACHE_TIME = Date.now();
                        console.log('[Notificaciones] üíæ Datos guardados en cach√©');

                        procesarNotificaciones(result.data);
                    } else {
                        body.innerHTML = '<div class="notification-empty"><div class="notification-empty-icon">‚ùå</div><p>Error al cargar notificaciones</p></div>';
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('[Notificaciones] ‚ùå Error:', error);

                    // Si hay cach√©, mantenerlo en caso de error
                    if (NOTIFICACIONES_CACHE) {
                        console.log('[Notificaciones] ‚ö†Ô∏è Error del servidor, usando cach√© antiguo');
                        procesarNotificaciones(NOTIFICACIONES_CACHE);
                    } else {
                        body.innerHTML = '<div class="notification-empty"><div class="notification-empty-icon">‚ùå</div><p>Error: ' + error.message + '</p></div>';
                    }
                })
                .bitacoraGetCompromisosActivos(TOKEN);
        }

        /**
         * Procesa y clasifica las notificaciones por urgencia
         * @param {Array} compromisos - Lista de compromisos activos
         * @param {Boolean} fromCache - Indica si los datos vienen del cach√©
         */
        function procesarNotificaciones(compromisos, fromCache = false) {
            console.log('[Notificaciones] Procesando', compromisos.length, 'compromisos');

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            NOTIFICACIONES = compromisos.map(c => {
                const fechaCompromiso = new Date(c.fechaCompromiso);
                fechaCompromiso.setHours(0, 0, 0, 0);

                const diffTime = fechaCompromiso.getTime() - hoy.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let urgencia, urgenciaTexto, icono;

                if (diffDays < 0) {
                    urgencia = 'vencido';
                    urgenciaTexto = 'VENCIDO hace ' + Math.abs(diffDays) + ' d√≠as';
                    icono = 'üî¥';
                } else if (diffDays === 0) {
                    urgencia = 'vencido';
                    urgenciaTexto = 'VENCE HOY';
                    icono = 'üî¥';
                } else if (diffDays <= 3) {
                    urgencia = 'urgente';
                    urgenciaTexto = 'Faltan ' + diffDays + ' d√≠as';
                    icono = 'üü°';
                } else if (diffDays <= 7) {
                    urgencia = 'proximo';
                    urgenciaTexto = 'Faltan ' + diffDays + ' d√≠as';
                    icono = 'üü¢';
                } else {
                    urgencia = 'futuro';
                    urgenciaTexto = 'Faltan ' + diffDays + ' d√≠as';
                    icono = 'üìÖ';
                }

                return {
                    ...c,
                    urgencia,
                    urgenciaTexto,
                    icono,
                    diasRestantes: diffDays
                };
            });

            // Ordenar por urgencia (vencidos primero, luego urgentes, etc.)
            const ordenUrgencia = { 'vencido': 0, 'urgente': 1, 'proximo': 2, 'futuro': 3 };
            NOTIFICACIONES.sort((a, b) => {
                const urgA = ordenUrgencia[a.urgencia];
                const urgB = ordenUrgencia[b.urgencia];
                if (urgA !== urgB) return urgA - urgB;
                return a.diasRestantes - b.diasRestantes;
            });

            console.log('[Notificaciones] Clasificadas:', {
                vencidos: NOTIFICACIONES.filter(n => n.urgencia === 'vencido').length,
                urgentes: NOTIFICACIONES.filter(n => n.urgencia === 'urgente').length,
                proximos: NOTIFICACIONES.filter(n => n.urgencia === 'proximo').length,
                futuros: NOTIFICACIONES.filter(n => n.urgencia === 'futuro').length
            });

            renderNotificaciones(fromCache);
            actualizarBadgeNotificaciones();
        }

        /**
         * Renderiza el panel de notificaciones
         */
        function renderNotificaciones(fromCache = false) {
            const body = document.getElementById('notificationBody');

            // Agregar badge de cach√© si corresponde
            const header = document.querySelector('.notification-header h3');
            if (header && fromCache && NOTIFICACIONES_CACHE_TIME) {
                const tiempoTranscurrido = Date.now() - NOTIFICACIONES_CACHE_TIME;
                const segundos = Math.round(tiempoTranscurrido / 1000);

                // Limpiar badges anteriores
                const oldBadge = header.querySelector('.cache-badge');
                if (oldBadge) oldBadge.remove();

                // Agregar nuevo badge
                const badge = document.createElement('span');
                badge.className = 'cache-badge';
                badge.style.cssText = 'display: inline-block; margin-left: 8px; padding: 2px 6px; background: #10b981; color: white; font-size: 0.7rem; border-radius: 4px; font-weight: 600;';
                badge.textContent = `‚ö° ${segundos}s`;
                badge.title = 'Datos cargados desde cach√© (instant√°neo)';
                header.appendChild(badge);
            }

            if (NOTIFICACIONES.length === 0) {
                body.innerHTML = `
                    <div class="notification-empty">
                        <div class="notification-empty-icon">‚úÖ</div>
                        <p><strong>¬°Todo al d√≠a!</strong></p>
                        <p style="font-size: 0.875rem;">No hay compromisos de pago pendientes</p>
                    </div>
                `;
                return;
            }

            // Agrupar por urgencia
            const grupos = {
                'vencido': { titulo: 'üî¥ Vencidos', notificaciones: [] },
                'urgente': { titulo: 'üü° Urgentes (1-3 d√≠as)', notificaciones: [] },
                'proximo': { titulo: 'üü¢ Pr√≥ximos (4-7 d√≠as)', notificaciones: [] },
                'futuro': { titulo: 'üìÖ Futuros (+7 d√≠as)', notificaciones: [] }
            };

            NOTIFICACIONES.forEach(n => {
                grupos[n.urgencia].notificaciones.push(n);
            });

            let html = '';

            Object.keys(grupos).forEach(key => {
                const grupo = grupos[key];
                if (grupo.notificaciones.length > 0) {
                    html += `
                        <div class="notification-group">
                            <div class="notification-group-header">
                                <span>${grupo.titulo}</span>
                                <span style="margin-left: auto; font-weight: 700;">${grupo.notificaciones.length}</span>
                            </div>
                            ${grupo.notificaciones.map(n => `
                                <div class="notification-item urgency-${n.urgencia}" onclick="irABitacoraCliente('${n.asegurado}')">
                                    <div class="notification-item-header">
                                        <div class="notification-item-icon">${n.icono}</div>
                                        <div class="notification-item-content">
                                            <div class="notification-item-title">${n.asegurado}</div>
                                            <div class="notification-item-subtitle">
                                                Compromiso de pago: ${formatDate(n.fechaCompromiso)}
                                            </div>
                                            <div class="notification-item-meta">
                                                <span class="notification-item-badge">${n.urgenciaTexto}</span>
                                                <span>üìû ${n.tipoGestion || 'Gesti√≥n'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            body.innerHTML = html;
        }

        /**
         * Actualiza el badge del contador de notificaciones
         */
        function actualizarBadgeNotificaciones() {
            const badge = document.getElementById('notificationBadge');
            const vencidosYUrgentes = NOTIFICACIONES.filter(n =>
                n.urgencia === 'vencido' || n.urgencia === 'urgente'
            ).length;

            if (vencidosYUrgentes > 0) {
                badge.textContent = vencidosYUrgentes;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        /**
         * Navega a la bit√°cora y filtra por cliente
         */
        function irABitacoraCliente(asegurado) {
            console.log('[Notificaciones] Ir a bit√°cora del cliente:', asegurado);

            // Cerrar panel de notificaciones
            if (NOTIFICATION_PANEL_OPEN) {
                toggleNotificaciones();
            }

            // Abrir bit√°cora
            openBitacoraModal();

            // Esperar a que cargue y luego filtrar
            setTimeout(() => {
                const selectCliente = document.getElementById('bitacoraFiltroAsegurado');
                if (selectCliente) {
                    // Buscar la opci√≥n que coincida
                    for (let i = 0; i < selectCliente.options.length; i++) {
                        if (selectCliente.options[i].value === asegurado) {
                            selectCliente.selectedIndex = i;
                            filterBitacora();
                            break;
                        }
                    }
                }
            }, 500);
        }

        /**
         * Carga inicial de notificaciones al cargar el portal
         * OPTIMIZADO: Carga en segundo plano y actualiza badge inmediatamente
         */
        function inicializarNotificaciones() {
            console.log('[Notificaciones] üöÄ Inicializando sistema...');

            // Cargar notificaciones en segundo plano de forma optimizada
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result && result.ok && result.data) {
                        console.log('[Notificaciones] ‚úÖ Datos iniciales recibidos:', result.data.length, 'compromisos');

                        // Guardar en cach√© inmediatamente
                        NOTIFICACIONES_CACHE = result.data;
                        NOTIFICACIONES_CACHE_TIME = Date.now();

                        // Procesar y actualizar badge
                        procesarNotificaciones(result.data);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('[Notificaciones] ‚ùå Error al cargar inicialmente:', error);
                })
                .bitacoraGetCompromisosActivos(TOKEN);

            // Actualizar cada 3 minutos (m√°s frecuente que el cach√© de 2min)
            setInterval(() => {
                console.log('[Notificaciones] üîÑ Actualizaci√≥n autom√°tica en background...');

                // Actualizar en background sin mostrar loader
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result && result.ok && result.data) {
                            // Actualizar cach√© silenciosamente
                            NOTIFICACIONES_CACHE = result.data;
                            NOTIFICACIONES_CACHE_TIME = Date.now();

                            // Solo procesar si cambi√≥ el n√∫mero de notificaciones
                            if (result.data.length !== NOTIFICACIONES.length) {
                                console.log('[Notificaciones] üì¢ Cambio detectado, actualizando badge...');
                                procesarNotificaciones(result.data);
                            }
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.warn('[Notificaciones] ‚ö†Ô∏è Error en actualizaci√≥n autom√°tica:', error.message);
                    })
                    .bitacoraGetCompromisosActivos(TOKEN);
            }, 3 * 60 * 1000);
        }

        // ============================================================
        // BIT√ÅCORA DE GESTIONES v3.0
        // ============================================================

        // Estado global de bit√°cora
        let BITACORA_DATA = [];
        let BITACORA_FILTERED = [];
        let BITACORA_CLIENTES = [];
        let BITACORA_RESPONSABLES = [];
        let BITACORA_EMB_LOADED = false;

        // ========== BIT√ÅCORA EMBEBIDA v15 ==========

        /**
         * Carga datos de bit√°cora en la tabla embebida
         */
        function loadBitacoraEmbeddedData() {
            console.log('[loadBitacoraEmbeddedData] üöÄ Iniciando carga...');

            if (BITACORA_EMB_LOADED && BITACORA_DATA.length > 0) {
                console.log('[loadBitacoraEmbeddedData] Ya cargado, usando datos existentes');
                renderBitacoraTableEmb();
                return;
            }

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[loadBitacoraEmbeddedData] ‚úÖ Respuesta:', result);
                    if (result && result.ok && result.data) {
                        BITACORA_DATA = result.data;
                        BITACORA_FILTERED = result.data;
                        BITACORA_EMB_LOADED = true;
                        renderBitacoraTableEmb();
                        populateFiltrosEmb();
                    } else {
                        showBitacoraEmbError('No hay datos disponibles');
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('[loadBitacoraEmbeddedData] ‚ùå Error:', err);
                    showBitacoraEmbError(err.message || 'Error al cargar datos');
                })
                .bitacoraGetResumenCiclos(TOKEN); // Funci√≥n correcta que funciona
        }

        function showBitacoraEmbError(msg) {
            const tbody = document.getElementById('bitacoraTableBodyEmb');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:#D32F2F;">‚ùå ' + msg + '</td></tr>';
            }
        }

        function renderBitacoraTableEmb() {
            const tbody = document.getElementById('bitacoraTableBodyEmb');
            const countEl = document.getElementById('bitacoraCountEmb');
            if (!tbody) return;

            if (!BITACORA_FILTERED || BITACORA_FILTERED.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--tp-text-secondary);">No hay gestiones registradas</td></tr>';
                if (countEl) countEl.textContent = '0';
                return;
            }

            let html = '';
            BITACORA_FILTERED.forEach(function (g) {
                // Colores distintivos de alto contraste para D√≠as Ciclo (Von Restorff)
                const dias = g.diasDesdeRegistro || 0;
                let diasBg, diasText, diasLabel;
                if (dias > 60) {
                    diasBg = '#DC2626'; diasText = '#FFFFFF'; diasLabel = 'üî¥ CR√çTICO';
                } else if (dias > 30) {
                    diasBg = '#EA580C'; diasText = '#FFFFFF'; diasLabel = 'üü† ALTO';
                } else if (dias > 7) {
                    diasBg = '#CA8A04'; diasText = '#FFFFFF'; diasLabel = 'üü° MEDIO';
                } else {
                    diasBg = '#16A34A'; diasText = '#FFFFFF'; diasLabel = 'üü¢ OK';
                }

                const estadoBadge = getEstadoBadge(g.estadoGestion);
                const responsable = (g.responsable || '-').replace(/@.*/, '').substring(0, 15);
                const proximaAccion = (g.proximaAccion || '-').substring(0, 25) + (g.proximaAccion && g.proximaAccion.length > 25 ? '...' : '');
                const asegurado = (g.asegurado || '-').substring(0, 30) + (g.asegurado && g.asegurado.length > 30 ? '...' : '');

                html += '<tr style="border-bottom:1px solid #E5E7EB;transition:background 0.15s;" onmouseover="this.style.background=\'#F9FAFB\'" onmouseout="this.style.background=\'transparent\'">';
                html += '<td style="padding:8px 10px;font-weight:500;font-size:0.8rem;max-width:180px;" title="' + (g.asegurado || '') + '">' + asegurado + '</td>';
                html += '<td style="padding:8px 6px;">' + estadoBadge + '</td>';
                html += '<td style="padding:8px 6px;font-size:0.75rem;color:#6B7280;">' + responsable + '</td>';
                html += '<td style="padding:8px 6px;font-size:0.75rem;white-space:nowrap;">' + formatDate(g.fechaEnvioEECC) + '</td>';
                html += '<td style="padding:8px 6px;font-size:0.75rem;white-space:nowrap;">' + formatDate(g.fechaRegistro) + '</td>';
                html += '<td style="padding:8px 6px;text-align:center;">' +
                    '<div style="display:flex;flex-direction:column;align-items:center;gap:2px;">' +
                    '<span style="background:' + diasBg + ';color:' + diasText + ';padding:3px 8px;border-radius:10px;font-size:0.7rem;font-weight:700;">' + dias + '</span>' +
                    '<span style="font-size:0.6rem;color:#9CA3AF;">' + diasLabel + '</span></div></td>';
                html += '<td style="padding:8px 6px;font-size:0.75rem;white-space:nowrap;">' + (g.fechaCompromiso ? formatDate(g.fechaCompromiso) : '<span style="color:#D1D5DB;">‚Äî</span>') + '</td>';
                html += '<td style="padding:8px 6px;font-size:0.75rem;color:#4B5563;max-width:140px;" title="' + (g.proximaAccion || '') + '">' + proximaAccion + '</td>';
                html += '<td style="padding:6px;text-align:center;white-space:nowrap;">';
                html += '<button onclick="verTimelineCiclo(null, \'' + (g.asegurado || '').replace(/'/g, "\\'") + '\')" style="padding:4px 6px;font-size:0.65rem;background:#F3F4F6;border:1px solid #D1D5DB;border-radius:4px;cursor:pointer;margin-right:3px;" title="Ver timeline">üìã</button>';
                html += '<button onclick="abrirRegistroGestionPara(\'' + (g.asegurado || '').replace(/'/g, "\\'") + '\')" style="padding:4px 6px;font-size:0.65rem;background:var(--tp-primary);color:white;border:none;border-radius:4px;cursor:pointer;" title="Agregar gesti√≥n">+</button>';
                html += '</td></tr>';
            });

            tbody.innerHTML = html;
            if (countEl) countEl.textContent = BITACORA_FILTERED.length;
        }

        function getEstadoBadge(estado) {
            // Badges compactos con alto contraste y emojis distintivos (Von Restorff)
            const badges = {
                'SIN_RESPUESTA': '<span style="display:inline-block;background:#FEF2F2;color:#B91C1C;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #FECACA;">‚ùå SIN RESP</span>',
                'EN_SEGUIMIENTO': '<span style="display:inline-block;background:#EFF6FF;color:#1D4ED8;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #BFDBFE;">üëÅÔ∏è SEGUIM</span>',
                'COMPROMISO_PAGO': '<span style="display:inline-block;background:#F0FDF4;color:#15803D;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #BBF7D0;">ü§ù COMPROM</span>',
                'CERRADO_PAGADO': '<span style="display:inline-block;background:#ECFDF5;color:#047857;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #A7F3D0;">‚úÖ CERRADO</span>',
                'REPROGRAMADO': '<span style="display:inline-block;background:#FEF3C7;color:#92400E;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #FDE68A;">üìÖ REPROG</span>',
                'DERIVADO_COMERCIAL': '<span style="display:inline-block;background:#F3E8FF;color:#7C3AED;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #DDD6FE;">üîÄ DERIV</span>'
            };
            return badges[estado] || '<span style="display:inline-block;background:#F3F4F6;color:#374151;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;border:1px solid #E5E7EB;">' + (estado || '-') + '</span>';
        }

        function formatDate(d) {
            if (!d) return '-';
            try {
                const date = new Date(d);
                return date.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) { return '-'; }
        }

        function populateFiltrosEmb() {
            // Poblar asegurados en filtro
            const asegSelect = document.getElementById('filtroAseguradoEmb');
            if (asegSelect && BITACORA_DATA.length > 0) {
                const asegurados = [...new Set(BITACORA_DATA.map(g => g.asegurado))].sort();
                asegSelect.innerHTML = '<option value="">Todos</option>' + asegurados.map(a => '<option value="' + a + '">' + a + '</option>').join('');
            }

            // Poblar responsables en filtro
            const respSelect = document.getElementById('filtroResponsableEmb');
            if (respSelect && BITACORA_DATA.length > 0) {
                const responsables = [...new Set(BITACORA_DATA.map(g => g.responsable).filter(r => r))].sort();
                respSelect.innerHTML = '<option value="">Todos</option>' + responsables.map(r => '<option value="' + r + '">' + r.replace(/@.*/, '') + '</option>').join('');
            }

            // Poblar asegurados en formulario de registro
            const gestionAsegSelect = document.getElementById('gestionAseguradoEmb');
            if (gestionAsegSelect && BITACORA_DATA.length > 0) {
                const asegurados = [...new Set(BITACORA_DATA.map(g => g.asegurado))].sort();
                gestionAsegSelect.innerHTML = '<option value="">Seleccionar...</option>' + asegurados.map(a => '<option value="' + a + '">' + a + '</option>').join('');
            }
        }

        /**
         * Registra una gesti√≥n desde el formulario embebido
         */
        function registrarGestionEmbedded() {
            const asegurado = document.getElementById('gestionAseguradoEmb')?.value;
            const tipo = document.getElementById('gestionTipoEmb')?.value;
            const estado = document.getElementById('gestionEstadoEmb')?.value;
            const fechaCompromiso = document.getElementById('gestionFechaCompromisoEmb')?.value;
            const proximaAccion = document.getElementById('gestionProximaAccionEmb')?.value;
            const observaciones = document.getElementById('gestionObservacionesEmb')?.value;

            // Validar campos obligatorios
            if (!asegurado || !tipo || !estado || !proximaAccion) {
                toast('Por favor completa todos los campos obligatorios', 'error');
                return;
            }

            const payload = {
                asegurado: asegurado,
                tipoGestion: tipo,
                estadoGestion: estado,
                fechaCompromiso: fechaCompromiso || null,
                proximaAccion: proximaAccion,
                observaciones: observaciones || ''
            };

            console.log('[registrarGestionEmbedded] Registrando:', payload);

            // Deshabilitar bot√≥n
            const btn = document.querySelector('#bitacora-embedded-registrar .btn-primary');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Registrando...';
            }

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[registrarGestionEmbedded] ‚úÖ Resultado:', result);
                    if (result && result.ok) {
                        toast('‚úÖ Gesti√≥n registrada correctamente', 'success');
                        // Limpiar formulario
                        document.getElementById('gestionAseguradoEmb').value = '';
                        document.getElementById('gestionTipoEmb').value = '';
                        document.getElementById('gestionEstadoEmb').value = '';
                        document.getElementById('gestionFechaCompromisoEmb').value = '';
                        document.getElementById('gestionProximaAccionEmb').value = '';
                        document.getElementById('gestionObservacionesEmb').value = '';
                        // Recargar datos
                        BITACORA_EMB_LOADED = false;
                        switchBitacoraTabEmbedded('estado');
                        loadBitacoraEmbeddedData();
                    } else {
                        toast('‚ùå Error: ' + (result?.message || 'Error desconocido'), 'error');
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'üíæ Registrar Gesti√≥n';
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('[registrarGestionEmbedded] ‚ùå Error:', err);
                    toast('‚ùå Error: ' + err.message, 'error');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'üíæ Registrar Gesti√≥n';
                    }
                })
                .registrarGestionManualBitacora(payload, TOKEN);
        }

        function filtrarBitacoraEmbedded() {
            const aseg = document.getElementById('filtroAseguradoEmb')?.value || '';
            const estado = document.getElementById('filtroEstadoEmb')?.value || '';
            const resp = document.getElementById('filtroResponsableEmb')?.value || '';
            const dias = document.getElementById('filtroDiasEmb')?.value || '';

            BITACORA_FILTERED = BITACORA_DATA.filter(function (g) {
                if (aseg && g.asegurado !== aseg) return false;
                if (estado && g.estadoGestion !== estado) return false;
                if (resp && g.responsable !== resp) return false;
                if (dias) {
                    const d = g.diasDesdeRegistro || 0;
                    if (dias === '0-7' && d > 7) return false;
                    if (dias === '8-30' && (d < 8 || d > 30)) return false;
                    if (dias === '31-60' && (d < 31 || d > 60)) return false;
                    if (dias === '61-' && d < 61) return false;
                }
                return true;
            });

            renderBitacoraTableEmb();
        }

        function switchBitacoraTabEmbedded(tab) {
            const estadoPane = document.getElementById('bitacora-embedded-estado');
            const registrarPane = document.getElementById('bitacora-embedded-registrar');
            const estadoBtn = document.getElementById('bitacora-tab-btn-estado');
            const registrarBtn = document.getElementById('bitacora-tab-btn-registrar');

            if (tab === 'estado') {
                if (estadoPane) estadoPane.style.display = 'block';
                if (registrarPane) registrarPane.style.display = 'none';
                if (estadoBtn) { estadoBtn.style.color = 'var(--tp-primary)'; estadoBtn.style.borderBottom = '3px solid var(--tp-primary)'; estadoBtn.style.fontWeight = '600'; }
                if (registrarBtn) { registrarBtn.style.color = 'var(--tp-text-secondary)'; registrarBtn.style.borderBottom = 'none'; registrarBtn.style.fontWeight = '500'; }
            } else {
                if (estadoPane) estadoPane.style.display = 'none';
                if (registrarPane) registrarPane.style.display = 'block';
                if (estadoBtn) { estadoBtn.style.color = 'var(--tp-text-secondary)'; estadoBtn.style.borderBottom = 'none'; estadoBtn.style.fontWeight = '500'; }
                if (registrarBtn) { registrarBtn.style.color = 'var(--tp-primary)'; registrarBtn.style.borderBottom = '3px solid var(--tp-primary)'; registrarBtn.style.fontWeight = '600'; }
            }
        }

        /**
         * Abre el tab de Registrar Gesti√≥n y preselecciona el asegurado
         */
        function abrirRegistroGestionPara(asegurado) {
            console.log('[abrirRegistroGestionPara] Abriendo formulario para:', asegurado);

            // Cambiar al tab Registrar
            switchBitacoraTabEmbedded('registrar');

            // Preseleccionar el asegurado en el formulario
            const selectAsegurado = document.getElementById('gestionAseguradoEmb');
            if (selectAsegurado && asegurado) {
                // Primero verificar si la opci√≥n existe
                const opciones = Array.from(selectAsegurado.options);
                const existe = opciones.some(opt => opt.value === asegurado);

                if (existe) {
                    selectAsegurado.value = asegurado;
                } else {
                    // Si no existe, a√±adirla
                    const nuevaOpcion = document.createElement('option');
                    nuevaOpcion.value = asegurado;
                    nuevaOpcion.textContent = asegurado;
                    selectAsegurado.appendChild(nuevaOpcion);
                    selectAsegurado.value = asegurado;
                }
            }

            // Scroll al top de la secci√≥n para ver el formulario
            const mainScroll = document.getElementById('mainScroll');
            if (mainScroll) mainScroll.scrollTop = 0;
        }

        function openRegistrarGestionModal(asegurado) {
            // Abrir el modal de registro existente
            const modal = document.getElementById('bitacoraModal');
            if (modal) {
                modal.classList.add('active');
                switchBitacoraTab('registrar');
                if (asegurado) {
                    const select = document.getElementById('gestionAsegurado');
                    if (select) select.value = asegurado;
                }
            }
        }

        // ========== CACH√â DE TIMELINES ==========
        // Cach√© de timelines para evitar llamadas repetidas al servidor
        const TIMELINE_CACHE = {};
        const TIMELINE_CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

        // ========== MODAL Y TABS ==========

        function openBitacoraModal() {
            console.log('[openBitacoraModal] Abriendo modal...');

            try {
                document.getElementById('bitacoraModal').classList.add('active');
                console.log('[openBitacoraModal] Modal activado, cargando datos...');

                // Limpiar cach√©s para asegurar datos frescos
                console.log('[openBitacoraModal] üîÑ Limpiando cach√©s para asegurar datos actualizados...');
                localStorage.removeItem('bitacora_data_cache');

                // Limpiar cach√© de timelines (opcional: solo si quieres forzar refresh al abrir)
                // Si prefieres mantener el cach√© de timelines, comenta esta l√≠nea
                // Object.keys(TIMELINE_CACHE).forEach(key => delete TIMELINE_CACHE[key]);

                // Cargar datos al abrir (forzar refresh)
                loadBitacoraData(true);
                loadClientesConCiclos();
                loadResponsablesUnicos();

                console.log('[openBitacoraModal] Funciones de carga iniciadas');
            } catch (error) {
                console.error('[openBitacoraModal] Error al abrir modal:', error);
                alert('Error al abrir bit√°cora: ' + error.message);
            }
        }

        function closeBitacoraModal() {
            console.log('[closeBitacoraModal] Cerrando modal...');
            document.getElementById('bitacoraModal').classList.remove('active');

            // Resetear campos de fecha a estado inicial
            // resetearCamposFecha(); // COMENTADO: Causa error al intentar acceder a elementos antes de que el modal est√© renderizado
        }

        function switchBitacoraTab(tab) {
            console.log('[switchBitacoraTab] Cambiando a tab:', tab);

            // Actualizar botones de tabs
            const tabs = document.querySelectorAll('#bitacoraModal .tab');
            tabs.forEach(t => t.classList.remove('active'));

            // Encontrar el bot√≥n del tab actual y marcarlo activo
            const tabButtons = document.querySelectorAll('#bitacoraModal .tab');
            tabButtons.forEach(btn => {
                if ((tab === 'estado' && btn.textContent.includes('Estado Actual')) ||
                    (tab === 'registrar' && btn.textContent.includes('Registrar'))) {
                    btn.classList.add('active');
                }
            });

            // Actualizar panes
            const panes = document.querySelectorAll('#bitacoraModal .tab-pane');
            panes.forEach(p => p.classList.remove('active'));

            if (tab === 'estado') {
                document.getElementById('bitacora-tab-estado').classList.add('active');
                // NO recargar datos - ya est√°n cargados y actualizados
                // Solo re-renderizar la tabla con los datos existentes
                if (BITACORA_DATA && BITACORA_DATA.length > 0) {
                    console.log('[switchBitacoraTab] Re-renderizando tabla con datos existentes:', BITACORA_DATA.length, 'registros');
                    renderBitacoraTable();
                } else {
                    console.log('[switchBitacoraTab] No hay datos, tabla se mantendr√° como est√°');
                }
            } else if (tab === 'registrar') {
                document.getElementById('bitacora-tab-registrar').classList.add('active');
            }
        }

        // ========== CACH√â Y CARGAR DATOS ==========

        const CACHE_KEY = 'bitacora_data_cache';
        const CACHE_DURATION = 2 * 60 * 1000; // 2 minutos

        /**
         * Obtiene datos del cach√© si est√°n vigentes
         */
        function getCachedBitacoraData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;

                const data = JSON.parse(cached);
                const now = new Date().getTime();

                // Verificar si el cach√© expir√≥
                if (now - data.timestamp > CACHE_DURATION) {
                    console.log('[Cache] ‚è∞ Cach√© expirado, eliminando...');
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }

                console.log('[Cache] ‚úÖ Cach√© v√°lido encontrado (' + data.data.length + ' gestiones)');
                return data.data;
            } catch (e) {
                console.error('[Cache] Error al leer cach√©:', e);
                return null;
            }
        }

        /**
         * Guarda datos en cach√©
         */
        function setCachedBitacoraData(data) {
            try {
                const cacheObj = {
                    timestamp: new Date().getTime(),
                    data: data
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObj));
                console.log('[Cache] üíæ Datos guardados en cach√© (' + data.length + ' gestiones)');
            } catch (e) {
                console.error('[Cache] Error al guardar cach√©:', e);
            }
        }

        /**
         * Carga datos de bit√°cora con cach√© inteligente
         * @param {boolean} forceRefresh - Forzar recarga desde servidor
         */
        function loadBitacoraData(forceRefresh = false) {
            console.log('[loadBitacoraData] üöÄ Iniciando carga (forceRefresh=' + forceRefresh + ')...');

            const tbody = document.getElementById('bitacoraTableBody');

            // 1. PRIMERO: Intentar cargar datos PRE-CARGADOS (m√°s r√°pido que cach√©)
            if (!forceRefresh) {
                try {
                    const datosPreCargados = '<?!= bitacoraDataPreload ?>';

                    if (datosPreCargados && datosPreCargados !== '' && datosPreCargados !== 'undefined' && datosPreCargados !== '[]') {
                        console.log('[loadBitacoraData] ‚ö°‚ö°‚ö° Usando datos PRE-CARGADOS (ULTRA-R√ÅPIDO)');

                        const datos = JSON.parse(datosPreCargados);

                        if (datos && datos.length > 0) {
                            BITACORA_DATA = datos;
                            BITACORA_FILTERED = datos;
                            renderBitacoraTable();
                            populateFiltros();

                            // Guardar en cach√© tambi√©n
                            setCachedBitacoraData(datos);

                            // Badge de √©xito
                            const badge = document.createElement('div');
                            badge.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 9999;';
                            badge.innerHTML = '‚ö° ' + datos.length + ' gestiones cargadas INSTANT√ÅNEAMENTE';
                            document.body.appendChild(badge);
                            setTimeout(() => badge.remove(), 3000);

                            console.log('[loadBitacoraData] ‚úÖ ' + datos.length + ' gestiones pre-cargadas exitosamente');
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('[loadBitacoraData] ‚ö†Ô∏è Error al leer datos pre-cargados:', error);
                }
            }

            // 2. SEGUNDO: Intentar cargar desde cach√©
            if (!forceRefresh) {
                const cachedData = getCachedBitacoraData();
                if (cachedData) {
                    console.log('[loadBitacoraData] ‚ö° Cargando desde cach√© (INSTANT√ÅNEO)');
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 1rem; color: #667eea;">‚ö° Cargando desde cach√©...</td></tr>';

                    // Peque√±o delay para mostrar el mensaje
                    setTimeout(() => {
                        BITACORA_DATA = cachedData;
                        BITACORA_FILTERED = cachedData;
                        renderBitacoraTable();
                        populateFiltros();

                        // Mostrar badge de cach√©
                        const badge = document.createElement('div');
                        badge.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 9999; animation: fadeOut 3s forwards;';
                        badge.innerHTML = '‚ö° Cargado desde cach√©';
                        document.body.appendChild(badge);

                        setTimeout(() => badge.remove(), 3000);
                    }, 100);

                    // Actualizar en background si el cach√© tiene m√°s de 1 minuto
                    setTimeout(() => loadBitacoraDataFromServer(true), 500);
                    return;
                }
            }

            // 3. √öLTIMO: Cargar desde servidor
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><br>‚è≥ Cargando estado actual (1 registro por asegurado)...</td></tr>';
            loadBitacoraDataFromServer(false);
        }

        /**
         * Carga datos desde el servidor
         * @param {boolean} silent - No mostrar indicadores de carga
         */
        function loadBitacoraDataFromServer(silent = false) {
            if (!silent) {
                console.log('[loadBitacoraData] üì° Cargando estado actual (1 registro por asegurado)...');
            }

            google.script.run
                .withSuccessHandler(function (result) {
                    if (!silent) {
                        console.log('[loadBitacoraData] ‚úÖ Respuesta recibida');
                    }

                    if (!result || !result.ok) {
                        if (!silent) {
                            console.error('[loadBitacoraData] ‚ùå Error:', result ? result.error : 'null');
                            showError('bitacoraTableBody', '‚ùå Error al cargar: ' + (result ? result.error : 'Sin respuesta'));
                        }
                        return;
                    }

                    // Guardar en cach√©
                    setCachedBitacoraData(result.data);

                    // Actualizar UI solo si no es silencioso
                    if (!silent) {
                        console.log('[loadBitacoraData] ‚úÖ ' + result.data.length + ' asegurados √∫nicos (ciclo m√°s reciente de cada uno)');
                        console.log('[loadBitacoraData] üìä Datos recibidos:', result.data);

                        // Verificar asegurados √∫nicos
                        const aseguradosUnicos = [...new Set(result.data.map(c => c.asegurado))];
                        console.log('[loadBitacoraData] üîç Asegurados √∫nicos:', aseguradosUnicos.length);
                        console.log('[loadBitacoraData] üîç Total de registros:', result.data.length);

                        if (aseguradosUnicos.length !== result.data.length) {
                            console.warn('[loadBitacoraData] ‚ö†Ô∏è ADVERTENCIA: Hay asegurados duplicados!');
                            console.warn('[loadBitacoraData] Asegurados √∫nicos:', aseguradosUnicos);
                        }

                        BITACORA_DATA = result.data;
                        BITACORA_FILTERED = result.data;
                        renderBitacoraTable();
                        populateFiltros();
                    } else {
                        console.log('[loadBitacoraData] üîÑ Cach√© actualizado en background (' + result.data.length + ' asegurados)');
                    }
                })
                .withFailureHandler(function (error) {
                    if (!silent) {
                        console.error('[loadBitacoraData] ‚ùå Error de conexi√≥n:', error);
                        showError('bitacoraTableBody', '‚ùå Error de conexi√≥n: ' + error.message);
                    }
                })
                .bitacoraGetResumenCiclos(TOKEN);
        }

        function loadClientesConCiclos() {
            console.log('[loadClientesConCiclos] Iniciando carga...');
            console.log('[loadClientesConCiclos] TOKEN:', TOKEN ? 'Disponible' : 'NO DISPONIBLE');

            if (!TOKEN) {
                console.error('[loadClientesConCiclos] ERROR: TOKEN no disponible');
                alert('ERROR: Sesi√≥n no v√°lida. Por favor recarga la p√°gina y vuelve a iniciar sesi√≥n.');
                return;
            }

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[loadClientesConCiclos] Respuesta recibida:', result);

                    if (result.ok) {
                        BITACORA_CLIENTES = result.data;
                        console.log('[loadClientesConCiclos] Clientes cargados:', BITACORA_CLIENTES.length);
                        populateAseguradoSelect();
                    } else {
                        console.error('[loadClientesConCiclos] Error en respuesta:', result.error);
                        alert('Error al cargar asegurados: ' + result.error);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('[loadClientesConCiclos] Error de conexi√≥n:', error);
                    alert('Error de conexi√≥n al cargar asegurados: ' + error.message);
                })
                .getClientesConCiclosActivos(TOKEN);
        }

        function loadResponsablesUnicos() {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.ok) {
                        BITACORA_RESPONSABLES = result.data;
                        populateResponsableFilter();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error al cargar responsables:', error);
                })
                .getResponsablesUnicos(TOKEN);
        }

        // ========== RENDERIZAR TABLA ==========

        function renderBitacoraTable() {
            console.log('[renderBitacoraTable] Iniciando renderizado...');

            try {
                const tbody = document.getElementById('bitacoraTableBody');
                const count = document.getElementById('bitacoraCount');

                if (!tbody || !count) {
                    console.error('[renderBitacoraTable] ERROR: Elementos DOM no encontrados');
                    return;
                }

                console.log('[renderBitacoraTable] BITACORA_FILTERED:', BITACORA_FILTERED ? BITACORA_FILTERED.length : 'undefined');

                if (!BITACORA_FILTERED || BITACORA_FILTERED.length === 0) {
                    // Phase 4: Use empty state helper with CTA
                    renderEmptyState(tbody, {
                        icon: 'üìã',
                        title: 'No hay gestiones registradas',
                        message: 'Comienza registrando tu primera gesti√≥n de cobranza',
                        ctaLabel: '+ Nueva Gesti√≥n',
                        ctaOnClick: () => { if (typeof mostrarRegistrarGestion === 'function') mostrarRegistrarGestion(); },
                        colspan: 9
                    });
                    count.textContent = '0';
                    console.log('[renderBitacoraTable] Sin datos para mostrar');
                    return;
                }

                const rows = BITACORA_FILTERED.map((ciclo, index) => {
                    try {
                        const badge = getEstadoBadge(ciclo.estadoGestion || '');
                        const fechaEnvio = formatDateTime(ciclo.fechaEnvioEECC);
                        const fechaGestion = formatDateTime(ciclo.fechaRegistro);
                        const fechaCompromiso = ciclo.fechaCompromiso ? formatDate(ciclo.fechaCompromiso) : '-';
                        const diasBadge = getDiasBadge(ciclo.diasDesdeRegistro || 0);
                        const aseguradoEscaped = (ciclo.asegurado || '').replace(/'/g, "\\'");
                        const idCicloEscaped = (ciclo.idCiclo || '').replace(/'/g, "\\'");

                        return `
                            <tr>
                                <td>${ciclo.asegurado || '-'}</td>
                                <td>${badge}</td>
                                <td>${ciclo.responsable || '-'}</td>
                                <td>${fechaEnvio}</td>
                                <td>${fechaGestion}</td>
                                <td>${diasBadge}</td>
                                <td>${fechaCompromiso}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ciclo.proximaAccion || '-'}</td>
                                <td style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                            onclick="verTimelineCiclo('${idCicloEscaped}', '${aseguradoEscaped}')" 
                                            title="Ver historial completo del ciclo">
                                        üìä Timeline
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                            onclick="seleccionarCicloParaGestion('${aseguradoEscaped}', '${idCicloEscaped}')">
                                        ‚ûï Gesti√≥n
                                    </button>
                                </td>
                            </tr>
                        `;
                    } catch (rowError) {
                        console.error('[renderBitacoraTable] Error al renderizar fila', index, rowError, ciclo);
                        return `<tr><td colspan="9" style="color: #D32F2F;">Error al renderizar fila ${index + 1}</td></tr>`;
                    }
                }).join('');

                tbody.innerHTML = rows;
                count.textContent = BITACORA_FILTERED.length;
                console.log('[renderBitacoraTable] Tabla renderizada exitosamente con', BITACORA_FILTERED.length, 'filas');

            } catch (error) {
                console.error('[renderBitacoraTable] Error fatal al renderizar tabla:', error);
                const tbody = document.getElementById('bitacoraTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #D32F2F;">‚ùå Error al renderizar tabla: ' + error.message + '</td></tr>';
                }
            }
        }

        // ========== FILTROS ==========

        function populateFiltros() {
            // Filtro de asegurado
            const filtroAseg = document.getElementById('filtroAsegurado');
            const aseguradosUnicos = [...new Set(BITACORA_DATA.map(c => c.asegurado))].sort();
            filtroAseg.innerHTML = '<option value="">Todos</option>' +
                aseguradosUnicos.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function populateResponsableFilter() {
            const filtroResp = document.getElementById('filtroResponsable');
            filtroResp.innerHTML = '<option value="">Todos</option>' +
                BITACORA_RESPONSABLES.map(r => `<option value="${r}">${r}</option>`).join('');
        }

        function populateAseguradoSelect() {
            console.log('[populateAseguradoSelect] Poblando autocomplete...');
            console.log('[populateAseguradoSelect] BITACORA_CLIENTES:', BITACORA_CLIENTES);

            if (!BITACORA_CLIENTES || BITACORA_CLIENTES.length === 0) {
                console.warn('[populateAseguradoSelect] ADVERTENCIA: Sin clientes para mostrar');
                AUTOCOMPLETE_OPTIONS = [];
                AUTOCOMPLETE_FILTERED = [];
                return;
            }

            // Cargar opciones en el autocomplete
            AUTOCOMPLETE_OPTIONS = [...BITACORA_CLIENTES];
            AUTOCOMPLETE_FILTERED = [...BITACORA_CLIENTES];

            console.log('[populateAseguradoSelect] Autocomplete poblado con', BITACORA_CLIENTES.length, 'opciones');
        }

        // ============================================================
        // AUTOCOMPLETE / COMBOBOX PARA ASEGURADOS
        // ============================================================

        let AUTOCOMPLETE_OPTIONS = []; // Lista completa de clientes
        let AUTOCOMPLETE_FILTERED = []; // Lista filtrada
        let AUTOCOMPLETE_SELECTED_INDEX = -1; // √çndice para navegaci√≥n con teclado

        /**
         * Filtra y muestra opciones del autocomplete en tiempo real
         */
        function filtrarAutocomplete() {
            const input = document.getElementById('gestionAsegurado');
            const dropdown = document.getElementById('autocompleteDropdown');
            const optionsContainer = document.getElementById('autocompleteOptions');
            const clearBtn = document.getElementById('clearAsegurado');
            const counter = document.getElementById('autocompleteCounter');

            if (!input || !dropdown || !optionsContainer) return;

            const searchText = normalizeText(input.value);

            // Mostrar/ocultar bot√≥n de limpiar
            clearBtn.style.display = searchText ? 'flex' : 'none';

            // Si no hay texto, mostrar todas las opciones
            if (!searchText) {
                AUTOCOMPLETE_FILTERED = [...AUTOCOMPLETE_OPTIONS];
                counter.style.display = 'none';
            } else {
                // Filtrar opciones que contienen el texto buscado (Accent-insensitive)
                AUTOCOMPLETE_FILTERED = AUTOCOMPLETE_OPTIONS.filter(option =>
                    normalizeText(option).includes(searchText)
                );

                // Actualizar contador
                if (AUTOCOMPLETE_FILTERED.length === 0) {
                    counter.textContent = '‚ùå No se encontraron clientes';
                    counter.style.color = '#D32F2F';
                } else if (AUTOCOMPLETE_FILTERED.length === 1) {
                    counter.textContent = '‚úÖ 1 cliente encontrado';
                    counter.style.color = '#10b981';
                } else {
                    counter.textContent = '‚úÖ ' + AUTOCOMPLETE_FILTERED.length + ' clientes encontrados';
                    counter.style.color = '#10b981';
                }
                counter.style.display = 'block';
            }

            // Renderizar opciones filtradas
            renderAutocompleteOptions();

            // Mostrar dropdown si hay texto
            if (searchText) {
                dropdown.style.display = 'block';
            }

            console.log('[filtrarAutocomplete] "' + searchText + '" ‚Üí ' + AUTOCOMPLETE_FILTERED.length + ' resultados');
        }

        /**
         * Renderiza las opciones del autocomplete
         */
        function renderAutocompleteOptions() {
            const optionsContainer = document.getElementById('autocompleteOptions');
            if (!optionsContainer) return;

            if (AUTOCOMPLETE_FILTERED.length === 0) {
                optionsContainer.innerHTML = '<div class="autocomplete-option autocomplete-option-empty">No se encontraron clientes</div>';
                return;
            }

            const input = document.getElementById('gestionAsegurado');
            const searchText = input ? input.value.toLowerCase().trim() : '';

            let html = '';

            AUTOCOMPLETE_FILTERED.forEach((option, index) => {
                // Resaltar texto coincidente
                let displayText = option;
                if (searchText) {
                    const regex = new RegExp(`(${searchText})`, 'gi');
                    displayText = option.replace(regex, '<strong>$1</strong>');
                }

                html += `
                    <div 
                        class="autocomplete-option" 
                        data-index="${index}"
                        onclick="seleccionarOpcionAutocomplete('${option.replace(/'/g, "\\'")}')"
                        onmouseenter="AUTOCOMPLETE_SELECTED_INDEX = ${index}; highlightAutocompleteOption(${index})"
                    >
                        ${displayText}
                    </div>
                `;
            });

            optionsContainer.innerHTML = html;
        }

        /**
         * Selecciona una opci√≥n del autocomplete
         */
        function seleccionarOpcionAutocomplete(value) {
            const input = document.getElementById('gestionAsegurado');
            const hiddenInput = document.getElementById('gestionAseguradoValue');
            const dropdown = document.getElementById('autocompleteDropdown');
            const clearBtn = document.getElementById('clearAsegurado');
            const counter = document.getElementById('autocompleteCounter');

            if (input) {
                input.value = value;
            }

            if (hiddenInput) {
                hiddenInput.value = value;
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }

            if (clearBtn) {
                clearBtn.style.display = 'flex';
            }

            if (counter) {
                counter.style.display = 'none';
            }

            // Trigger onAseguradoChange
            onAseguradoChange();

            console.log('[seleccionarOpcionAutocomplete] Seleccionado:', value);
        }

        /**
         * Muestra el dropdown del autocomplete
         */
        function mostrarDropdownAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            const input = document.getElementById('gestionAsegurado');

            if (!dropdown || !input) return;

            // Si no hay texto, mostrar todas las opciones
            if (!input.value.trim()) {
                AUTOCOMPLETE_FILTERED = [...AUTOCOMPLETE_OPTIONS];
                renderAutocompleteOptions();
            }

            dropdown.style.display = 'block';
        }

        /**
         * Toggle del dropdown (bot√≥n ‚ñº)
         */
        function toggleDropdownAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            const input = document.getElementById('gestionAsegurado');

            if (!dropdown) return;

            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                // Mostrar todas las opciones
                AUTOCOMPLETE_FILTERED = [...AUTOCOMPLETE_OPTIONS];
                renderAutocompleteOptions();
                dropdown.style.display = 'block';

                if (input) {
                    input.focus();
                }
            } else {
                dropdown.style.display = 'none';
            }
        }

        /**
         * Limpia el autocomplete
         */
        function limpiarAutocomplete() {
            const input = document.getElementById('gestionAsegurado');
            const hiddenInput = document.getElementById('gestionAseguradoValue');
            const dropdown = document.getElementById('autocompleteDropdown');
            const clearBtn = document.getElementById('clearAsegurado');
            const counter = document.getElementById('autocompleteCounter');

            if (input) {
                input.value = '';
                input.focus();
            }

            if (hiddenInput) {
                hiddenInput.value = '';
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }

            if (clearBtn) {
                clearBtn.style.display = 'none';
            }

            if (counter) {
                counter.style.display = 'none';
            }

            // Resetear campos de fecha si corresponde
            onAseguradoChange();

            console.log('[limpiarAutocomplete] Autocomplete limpiado');
        }

        /**
         * Resalta una opci√≥n del autocomplete (para navegaci√≥n con teclado)
         */
        function highlightAutocompleteOption(index) {
            const options = document.querySelectorAll('.autocomplete-option');
            options.forEach((opt, i) => {
                if (i === index) {
                    opt.classList.add('autocomplete-option-highlighted');
                } else {
                    opt.classList.remove('autocomplete-option-highlighted');
                }
            });
        }

        /**
         * Cierra el dropdown si se hace clic fuera
         */
        document.addEventListener('click', function (e) {
            // Cerrar dropdown de Bit√°cora
            const wrapperBitacora = document.querySelector('#bitacoraModal .autocomplete-wrapper');
            const dropdownBitacora = document.getElementById('autocompleteDropdown');

            if (wrapperBitacora && dropdownBitacora && !wrapperBitacora.contains(e.target)) {
                dropdownBitacora.style.display = 'none';
            }

            // Cerrar dropdown de EECC
            const wrapperEECC = document.querySelector('.card.step-card .autocomplete-wrapper');
            const dropdownEECC = document.getElementById('autocompleteDropdownEECC');

            if (wrapperEECC && dropdownEECC && !wrapperEECC.contains(e.target)) {
                dropdownEECC.style.display = 'none';
            }
        });

        /**
         * Navegaci√≥n con teclado (Arriba/Abajo/Enter/Escape)
         */
        document.addEventListener('keydown', function (e) {
            // Para autocomplete de Bit√°cora
            const inputBitacora = document.getElementById('gestionAsegurado');
            const dropdownBitacora = document.getElementById('autocompleteDropdown');

            if (inputBitacora && dropdownBitacora && dropdownBitacora.style.display !== 'none' && document.activeElement === inputBitacora) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    AUTOCOMPLETE_SELECTED_INDEX = Math.min(AUTOCOMPLETE_SELECTED_INDEX + 1, AUTOCOMPLETE_FILTERED.length - 1);
                    highlightAutocompleteOption(AUTOCOMPLETE_SELECTED_INDEX);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    AUTOCOMPLETE_SELECTED_INDEX = Math.max(AUTOCOMPLETE_SELECTED_INDEX - 1, 0);
                    highlightAutocompleteOption(AUTOCOMPLETE_SELECTED_INDEX);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (AUTOCOMPLETE_SELECTED_INDEX >= 0 && AUTOCOMPLETE_SELECTED_INDEX < AUTOCOMPLETE_FILTERED.length) {
                        seleccionarOpcionAutocomplete(AUTOCOMPLETE_FILTERED[AUTOCOMPLETE_SELECTED_INDEX]);
                    }
                } else if (e.key === 'Escape') {
                    dropdownBitacora.style.display = 'none';
                    AUTOCOMPLETE_SELECTED_INDEX = -1;
                }
            }

            // Para autocomplete de EECC
            const inputEECC = document.getElementById('aseguradoSelect');
            const dropdownEECC = document.getElementById('autocompleteDropdownEECC');

            if (inputEECC && dropdownEECC && dropdownEECC.style.display !== 'none' && document.activeElement === inputEECC) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    AUTOCOMPLETE_EECC_SELECTED_INDEX = Math.min(AUTOCOMPLETE_EECC_SELECTED_INDEX + 1, AUTOCOMPLETE_EECC_FILTERED.length - 1);
                    highlightAutocompleteOptionEECC(AUTOCOMPLETE_EECC_SELECTED_INDEX);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    AUTOCOMPLETE_EECC_SELECTED_INDEX = Math.max(AUTOCOMPLETE_EECC_SELECTED_INDEX - 1, 0);
                    highlightAutocompleteOptionEECC(AUTOCOMPLETE_EECC_SELECTED_INDEX);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (AUTOCOMPLETE_EECC_SELECTED_INDEX >= 0 && AUTOCOMPLETE_EECC_SELECTED_INDEX < AUTOCOMPLETE_EECC_FILTERED.length) {
                        seleccionarOpcionAutocompleteEECC(AUTOCOMPLETE_EECC_FILTERED[AUTOCOMPLETE_EECC_SELECTED_INDEX]);
                    }
                } else if (e.key === 'Escape') {
                    dropdownEECC.style.display = 'none';
                    AUTOCOMPLETE_EECC_SELECTED_INDEX = -1;
                }
            }
        });

        function filtrarBitacora() {
            const asegurado = document.getElementById('filtroAsegurado').value;
            const estado = document.getElementById('filtroEstado').value;
            const responsable = document.getElementById('filtroResponsable').value;
            const diasRango = document.getElementById('filtroDias').value;

            BITACORA_FILTERED = BITACORA_DATA.filter(ciclo => {
                if (asegurado && ciclo.asegurado !== asegurado) return false;
                if (estado && ciclo.estadoGestion !== estado) return false;
                if (responsable && ciclo.responsable !== responsable) return false;

                if (diasRango) {
                    const dias = ciclo.diasDesdeRegistro;
                    if (diasRango === '0-7' && (dias < 0 || dias > 7)) return false;
                    if (diasRango === '8-30' && (dias < 8 || dias > 30)) return false;
                    if (diasRango === '31-60' && (dias < 31 || dias > 60)) return false;
                    if (diasRango === '61-' && dias <= 60) return false;
                }

                return true;
            });

            renderBitacoraTable();
        }

        function actualizarKPIsBitacora() {
            // Validar que los datos existan
            if (!BITACORA_FILTERED || !Array.isArray(BITACORA_FILTERED)) {
                console.warn('[actualizarKPIsBitacora] BITACORA_FILTERED no est√° inicializado');
                return;
            }

            // Validar que los elementos DOM existan
            const kpiTotal = document.getElementById('kpiTotal');
            const kpiCompromisos = document.getElementById('kpiCompromisos');
            const kpiSeguimiento = document.getElementById('kpiSeguimiento');
            const kpiCerrados = document.getElementById('kpiCerrados');

            if (!kpiTotal || !kpiCompromisos || !kpiSeguimiento || !kpiCerrados) {
                console.warn('[actualizarKPIsBitacora] Elementos KPI no encontrados en el DOM');
                return;
            }

            const data = BITACORA_FILTERED;

            // Total de ciclos
            const total = data.length;

            // Compromisos de pago (incluye COMPROMISO_PAGO y REPROGRAMADO)
            const compromisos = data.filter(c =>
                c.estadoGestion === 'COMPROMISO_PAGO' ||
                c.estadoGestion === 'REPROGRAMADO'
            ).length;

            // En seguimiento
            const seguimiento = data.filter(c =>
                c.estadoGestion === 'EN_SEGUIMIENTO'
            ).length;

            // Cerrados/Pagados
            const cerrados = data.filter(c =>
                c.estadoGestion === 'CERRADO_PAGADO'
            ).length;

            // Actualizar DOM
            kpiTotal.textContent = total;
            kpiCompromisos.textContent = compromisos;
            kpiSeguimiento.textContent = seguimiento;
            kpiCerrados.textContent = cerrados;
        }

        // ========== REGISTRAR GESTI√ìN ==========

        function registrarGestionManual(event) {
            event.preventDefault();

            const asegurado = document.getElementById('gestionAsegurado').value;
            const fechaEnvioEECC = document.getElementById('gestionFechaEnvioEECC').value;
            const fechaGestion = document.getElementById('gestionFechaGestion').value;
            const tipoGestion = document.getElementById('gestionTipo').value;
            const estadoGestion = document.getElementById('gestionEstado').value;
            const canalContacto = document.getElementById('gestionCanal').value;
            const fechaCompromiso = document.getElementById('gestionFechaCompromiso').value;
            const proximaAccion = document.getElementById('gestionProximaAccion').value.trim();
            const observaciones = document.getElementById('gestionObservaciones').value.trim();

            // Validaci√≥n
            if (!asegurado || !tipoGestion || !estadoGestion || !canalContacto || !proximaAccion) {
                showGestionStatus('error', 'Por favor completa todos los campos obligatorios');
                return false;
            }

            // Validar Fecha Env√≠o EECC
            if (!fechaEnvioEECC) {
                showGestionStatus('error', 'Por favor ingresa o carga la Fecha de Env√≠o EECC');
                return false;
            }

            // Validar que sea una fecha v√°lida
            if (isNaN(new Date(fechaEnvioEECC).getTime())) {
                showGestionStatus('error', 'La Fecha de Env√≠o EECC no es v√°lida');
                return false;
            }

            // Validar Fecha Gesti√≥n
            if (!fechaGestion) {
                showGestionStatus('error', 'Por favor ingresa la Fecha de esta Gesti√≥n');
                return false;
            }

            // Validar que sea una fecha v√°lida
            if (isNaN(new Date(fechaGestion).getTime())) {
                showGestionStatus('error', 'La Fecha de Gesti√≥n no es v√°lida');
                return false;
            }

            // Validar FECHA_COMPROMISO si es obligatoria
            if ((estadoGestion === 'COMPROMISO_PAGO' || estadoGestion === 'REPROGRAMADO')) {
                if (!fechaCompromiso) {
                    showGestionStatus('error', 'El estado ' + estadoGestion + ' requiere FECHA_COMPROMISO');
                    return false;
                }
                // Validar que sea fecha v√°lida
                if (isNaN(new Date(fechaCompromiso).getTime())) {
                    showGestionStatus('error', 'La Fecha de Compromiso no es v√°lida');
                    return false;
                }
            }

            // Validar OBSERVACIONES si es obligatoria
            const estadosRequierenObs = ['DERIVADO_COMERCIAL', 'DERIVADO_RRHH', 'DERIVADO_RIESGOS_GENERALES', 'NO_COBRABLE'];
            if (estadosRequierenObs.includes(estadoGestion) && !observaciones) {
                showGestionStatus('error', 'El estado ' + estadoGestion + ' requiere OBSERVACIONES');
                return false;
            }

            // Deshabilitar bot√≥n
            const btn = document.getElementById('btnGuardarGestion');
            btn.disabled = true;
            btn.textContent = '‚è≥ Registrando...';

            showGestionStatus('info', 'Registrando gesti√≥n...');

            const payload = {
                asegurado: asegurado,
                fechaEnvioEECC: fechaEnvioEECC,  // Fecha del inicio del ciclo
                fechaGestion: fechaGestion,      // Fecha de esta gesti√≥n espec√≠fica
                tipoGestion: tipoGestion,
                estadoGestion: estadoGestion,
                canalContacto: canalContacto,
                fechaCompromiso: fechaCompromiso || null,
                proximaAccion: proximaAccion,
                observaciones: observaciones
            };

            google.script.run
                .withSuccessHandler(function (result) {
                    btn.disabled = false;
                    btn.textContent = 'üíæ Registrar Gesti√≥n';

                    if (result.ok) {
                        // Mensaje de √©xito visual
                        showGestionStatus('success', '‚úÖ Gesti√≥n registrada exitosamente');

                        // Mostrar notificaci√≥n flotante
                        mostrarNotificacionExito('‚úÖ Gesti√≥n registrada correctamente',
                            'El registro se ha guardado y aparecer√° en "Estado Actual"');

                        // Limpiar formulario
                        limpiarFormGestion();

                        // üîÑ ACTUALIZACI√ìN AUTOM√ÅTICA
                        console.log('[registrarGestionManual] ‚úÖ Registro exitoso - Actualizando datos...');

                        // 1. Limpiar TODOS los cach√©s (localStorage, memoria y timelines)
                        console.log('[registrarGestionManual] üóëÔ∏è Limpiando todos los cach√©s...');
                        localStorage.removeItem('bitacora_data_cache');
                        window.bitacoraDataPreload = null;
                        BITACORA_DATA = [];
                        BITACORA_FILTERED = [];

                        // Limpiar cach√©s de timelines y notificaciones para forzar recarga
                        Object.keys(TIMELINE_CACHE).forEach(key => delete TIMELINE_CACHE[key]);
                        NOTIFICACIONES_CACHE = null;
                        NOTIFICACIONES_CACHE_TIME = null;
                        console.log('[registrarGestionManual] üóëÔ∏è Cach√©s limpiados (timelines + notificaciones)');

                        // 2. Esperar para que el servidor escriba y commit los datos en Sheets
                        // Aumentado a 1500ms para asegurar que Sheets tenga los datos frescos
                        setTimeout(() => {
                            console.log('[registrarGestionManual] üîÑ Recargando Estado Actual con datos frescos...');
                            console.log('[registrarGestionManual] üì° Llamando a bitacoraGetResumenCiclos para obtener solo √∫ltima gesti√≥n por asegurado...');

                            // 3. Mostrar spinner mientras carga
                            const tbody = document.getElementById('bitacoraTableBody');
                            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><br>‚è≥ Actualizando con tu nueva gesti√≥n...</td></tr>';

                            // 4. Forzar recarga completa desde servidor (sin cach√©, solo resumen)
                            google.script.run
                                .withSuccessHandler(function (result) {
                                    console.log('[registrarGestionManual] ‚úÖ Datos frescos recibidos:', result);

                                    if (result && result.ok && result.data) {
                                        console.log('[registrarGestionManual] üìä ' + result.data.length + ' asegurados √∫nicos recibidos');

                                        // Actualizar datos globales
                                        BITACORA_DATA = result.data;
                                        BITACORA_FILTERED = result.data;

                                        // Guardar en cach√©
                                        setCachedBitacoraData(result.data);

                                        // Renderizar tabla
                                        renderBitacoraTable();
                                        populateFiltros();

                                        console.log('[registrarGestionManual] ‚úÖ Tabla actualizada correctamente');

                                        // Cambiar al tab "Estado Actual" DESPU√âS de actualizar los datos
                                        setTimeout(() => {
                                            switchBitacoraTab('estado');
                                            console.log('[registrarGestionManual] üìä Vista cambiada a Estado Actual con datos actualizados');

                                            // Actualizar notificaciones en background
                                            console.log('[registrarGestionManual] üîî Actualizando notificaciones...');
                                            inicializarNotificaciones();
                                        }, 200);
                                    } else {
                                        console.error('[registrarGestionManual] ‚ùå Respuesta inv√°lida:', result);
                                    }
                                })
                                .withFailureHandler(function (error) {
                                    console.error('[registrarGestionManual] ‚ùå Error al recargar:', error);
                                    showError('bitacoraTableBody', 'Error al actualizar: ' + error.message);
                                })
                                .bitacoraGetResumenCiclos(TOKEN);
                        }, 1500);

                    } else {
                        showGestionStatus('error', 'Error: ' + result.error);
                        mostrarNotificacionError('‚ùå Error al registrar', result.error);
                    }
                })
                .withFailureHandler(function (error) {
                    btn.disabled = false;
                    btn.textContent = 'üíæ Registrar Gesti√≥n';
                    showGestionStatus('error', 'Error de conexi√≥n: ' + error.message);
                    mostrarNotificacionError('‚ùå Error de conexi√≥n', error.message);
                })
                .registrarGestionManualBitacora(payload, TOKEN);

            return false;
        }

        function seleccionarCicloParaGestion(asegurado, idCiclo) {
            // Cambiar al tab de registro
            switchBitacoraTab('registrar');

            // Prellenar asegurado
            document.getElementById('gestionAsegurado').value = asegurado;
            onAseguradoChange();
        }

        /**
         * Alterna entre modo autom√°tico y manual para Fecha Env√≠o EECC
         */
        function toggleFechaEnvioMode() {
            const radioChecked = document.querySelector('input[name="fechaEnvioMode"]:checked');

            // Si el radio est√° deshabilitado, no hacer nada (campo bloqueado por escenario)
            if (radioChecked && radioChecked.disabled) {
                console.log('[toggleFechaEnvioMode] Radio deshabilitado, no se puede cambiar');
                return;
            }

            const modeAuto = radioChecked?.value === 'auto';
            const inputFecha = document.getElementById('gestionFechaEnvioEECC');
            const helpText = document.getElementById('fechaEnvioHelp');

            if (modeAuto) {
                // Modo autom√°tico
                inputFecha.setAttribute('readonly', true);
                inputFecha.style.cursor = 'not-allowed';
                inputFecha.style.opacity = '0.8';
                helpText.textContent = 'üÜï Fecha del env√≠o del EECC que iniciar√° este nuevo ciclo';

                // Establecer fecha de hoy (Lima)
                inputFecha.value = getFechaLimaFormatted();

                // Sincronizar con "Fecha de esta Gesti√≥n" si es nuevo ciclo
                const inputGestion = document.getElementById('gestionFechaGestion');
                if (inputGestion.hasAttribute('readonly') && inputGestion.style.opacity === '0.6') {
                    // Es nuevo ciclo, sincronizar
                    inputGestion.value = inputFecha.value;
                }
            } else {
                // Modo manual
                inputFecha.removeAttribute('readonly');
                inputFecha.style.cursor = 'text';
                inputFecha.style.opacity = '1';
                helpText.textContent = '‚úçÔ∏è Ingresa manualmente la fecha y hora del env√≠o EECC';
                inputFecha.focus();
            }
        }

        /**
         * Alterna entre modo autom√°tico y manual para Fecha de Gesti√≥n
         */
        function toggleFechaGestionMode() {
            const radioChecked = document.querySelector('input[name="fechaGestionMode"]:checked');

            // Si el radio est√° deshabilitado, no hacer nada (campo bloqueado por escenario)
            if (radioChecked && radioChecked.disabled) {
                console.log('[toggleFechaGestionMode] Radio deshabilitado, no se puede cambiar');
                return;
            }

            const modeAuto = radioChecked?.value === 'auto';
            const inputFecha = document.getElementById('gestionFechaGestion');
            const helpText = document.getElementById('fechaGestionHelp');

            if (modeAuto) {
                // Modo autom√°tico: usar fecha y hora actual (horario Lima)
                inputFecha.setAttribute('readonly', true);
                inputFecha.style.cursor = 'not-allowed';
                inputFecha.style.opacity = '0.8';
                helpText.textContent = 'üìÖ Fecha y hora de esta gesti√≥n de seguimiento';

                // Establecer fecha y hora actual en horario de Lima (GMT-5)
                inputFecha.value = getFechaLimaFormatted();
            } else {
                // Modo manual
                inputFecha.removeAttribute('readonly');
                inputFecha.style.cursor = 'text';
                inputFecha.style.opacity = '1';
                helpText.textContent = '‚úçÔ∏è Ingresa manualmente la fecha y hora de esta gesti√≥n';
                inputFecha.focus();
            }
        }

        /**
         * Listener para sincronizar fechas en modo nuevo ciclo
         * Cuando se edita "Fecha Env√≠o EECC" manualmente en nuevo ciclo,
         * "Fecha de esta Gesti√≥n" debe actualizarse tambi√©n
         */
        document.addEventListener('DOMContentLoaded', function () {
            const inputEnvio = document.getElementById('gestionFechaEnvioEECC');
            if (inputEnvio) {
                inputEnvio.addEventListener('input', function () {
                    const inputGestion = document.getElementById('gestionFechaGestion');

                    // Solo sincronizar si "Fecha de esta Gesti√≥n" est√° bloqueada (nuevo ciclo)
                    if (inputGestion.hasAttribute('readonly') && inputGestion.style.opacity === '0.6') {
                        console.log('[Sincronizaci√≥n] Actualizando Fecha de esta Gesti√≥n:', this.value);
                        inputGestion.value = this.value;
                    }
                });
            }

            // Establecer fecha m√≠nima para compromiso de pago (hoy)
            const inputCompromiso = document.getElementById('gestionFechaCompromiso');
            if (inputCompromiso) {
                const hoy = new Date();
                const year = hoy.getFullYear();
                const month = String(hoy.getMonth() + 1).padStart(2, '0');
                const day = String(hoy.getDate()).padStart(2, '0');
                const fechaMinima = `${year}-${month}-${day}`;
                inputCompromiso.setAttribute('min', fechaMinima);
                console.log('[DOMContentLoaded] Fecha m√≠nima para compromiso establecida:', fechaMinima);
            }
        });

        /**
         * Carga la fecha de env√≠o EECC autom√°ticamente desde el √∫ltimo ciclo
         */
        function cargarFechaEnvioAutomatica(asegurado) {
            console.log('[cargarFechaEnvioAutomatica] Cargando para asegurado:', asegurado);

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[cargarFechaEnvioAutomatica] Respuesta recibida:', result);

                    const inputFecha = document.getElementById('gestionFechaEnvioEECC');

                    if (result.ok && result.data) {
                        console.log('[cargarFechaEnvioAutomatica] Datos del ciclo:', result.data);
                        console.log('[cargarFechaEnvioAutomatica] fechaEnvioEECC:', result.data.fechaEnvioEECC);

                        if (result.data.fechaEnvioEECC) {
                            // Hay ciclo previo - convertir a formato datetime-local
                            const fecha = new Date(result.data.fechaEnvioEECC);
                            console.log('[cargarFechaEnvioAutomatica] Fecha parseada:', fecha);

                            if (isNaN(fecha.getTime())) {
                                console.error('[cargarFechaEnvioAutomatica] Fecha inv√°lida:', result.data.fechaEnvioEECC);
                                inputFecha.value = '';
                                inputFecha.placeholder = 'Error: fecha inv√°lida';
                                return;
                            }

                            // Formato YYYY-MM-DDTHH:mm para datetime-local
                            const year = fecha.getFullYear();
                            const month = String(fecha.getMonth() + 1).padStart(2, '0');
                            const day = String(fecha.getDate()).padStart(2, '0');
                            const hours = String(fecha.getHours()).padStart(2, '0');
                            const minutes = String(fecha.getMinutes()).padStart(2, '0');

                            const fechaFormateada = `${year}-${month}-${day}T${hours}:${minutes}`;
                            console.log('[cargarFechaEnvioAutomatica] Fecha formateada:', fechaFormateada);

                            inputFecha.value = fechaFormateada;
                            console.log('[cargarFechaEnvioAutomatica] ‚úÖ Fecha cargada exitosamente');
                        } else {
                            // Primera gesti√≥n de este cliente
                            console.log('[cargarFechaEnvioAutomatica] No hay fecha de env√≠o EECC (primera gesti√≥n)');
                            inputFecha.value = '';
                            inputFecha.placeholder = 'Primera gesti√≥n - ingresa fecha manualmente';
                        }
                    } else {
                        // No se encontr√≥ ni ciclo ni datos en BD
                        console.log('[cargarFechaEnvioAutomatica] No se encontr√≥ ciclo ni datos en BD');
                        inputFecha.value = '';
                        inputFecha.placeholder = 'Cliente no encontrado';
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('[cargarFechaEnvioAutomatica] ‚ùå Error:', error);
                    document.getElementById('gestionFechaEnvioEECC').value = '';
                    document.getElementById('gestionFechaEnvioEECC').placeholder = 'Error al cargar fecha';
                })
                .getUltimoCicloPorAsegurado(asegurado, TOKEN);
        }

        function onAseguradoChange() {
            const asegurado = document.getElementById('gestionAsegurado').value;

            if (!asegurado) {
                console.log('[onAseguradoChange] No hay asegurado seleccionado, reseteando...');
                document.getElementById('gestionResponsable').value = '';

                // Resetear campos de fecha a estado inicial
                resetearCamposFecha();
                return;
            }

            console.log('[onAseguradoChange] Verificando ciclo para:', asegurado);

            // Verificar si existe un ciclo previo para determinar el escenario
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[onAseguradoChange] Resultado verificaci√≥n:', result);

                    if (result.ok && result.data && result.data.fechaEnvioEECC) {
                        // ESCENARIO 2: +GESTI√ìN (ciclo existente)
                        console.log('[onAseguradoChange] üìã Escenario: +GESTI√ìN en ciclo existente');
                        configurarModoGestionAdicional(result.data);
                    } else {
                        // ESCENARIO 1: NUEVO CICLO
                        console.log('[onAseguradoChange] üÜï Escenario: NUEVO CICLO');
                        configurarModoNuevoCiclo();
                    }

                    // Responsable (usuario actual)
                    document.getElementById('gestionResponsable').value = CURRENT_USER || 'Usuario actual';
                })
                .withFailureHandler(function (error) {
                    console.error('[onAseguradoChange] Error al verificar ciclo:', error);
                    // En caso de error, asumir nuevo ciclo
                    configurarModoNuevoCiclo();
                })
                .getUltimoCicloPorAsegurado(asegurado, TOKEN);
        }

        /**
         * Configura el formulario para NUEVO CICLO
         * - Fecha Env√≠o EECC: Editable (inicio del ciclo)
         * - Fecha de esta Gesti√≥n: BLOQUEADA (misma que env√≠o)
         */
        function configurarModoNuevoCiclo() {
            console.log('[configurarModoNuevoCiclo] Configurando formulario para nuevo ciclo...');

            const inputEnvio = document.getElementById('gestionFechaEnvioEECC');
            const inputGestion = document.getElementById('gestionFechaGestion');
            const radioEnvioAuto = document.getElementById('fechaEnvioAuto');
            const radioEnvioManual = document.getElementById('fechaEnvioManual');
            const radioGestionHoy = document.getElementById('fechaGestionHoy');
            const radioGestionManual = document.getElementById('fechaGestionManual');
            const helpEnvio = document.getElementById('fechaEnvioHelp');
            const helpGestion = document.getElementById('fechaGestionHelp');

            // 1. Fecha Env√≠o EECC: Editable, por defecto = Hoy
            radioEnvioAuto.checked = true;
            radioEnvioAuto.disabled = false;
            radioEnvioManual.disabled = false;
            inputEnvio.value = getFechaLimaFormatted();
            inputEnvio.removeAttribute('readonly');
            inputEnvio.style.cursor = 'not-allowed';
            inputEnvio.style.opacity = '0.8';
            helpEnvio.textContent = 'üÜï Fecha del env√≠o del EECC que iniciar√° este nuevo ciclo';

            // 2. Fecha de esta Gesti√≥n: BLOQUEADA (igual a Fecha Env√≠o)
            radioGestionHoy.checked = true;
            radioGestionHoy.disabled = true;
            radioGestionManual.disabled = true;
            inputGestion.value = inputEnvio.value; // Copia la misma fecha
            inputGestion.setAttribute('readonly', true);
            inputGestion.style.cursor = 'not-allowed';
            inputGestion.style.opacity = '0.6';
            helpGestion.textContent = 'üîí En un nuevo ciclo, esta fecha es igual a la fecha de env√≠o del EECC';

            console.log('[configurarModoNuevoCiclo] ‚úÖ Configurado: Env√≠o editable, Gesti√≥n bloqueada');
        }

        /**
         * Configura el formulario para +GESTI√ìN (ciclo existente)
         * - Fecha Env√≠o EECC: BLOQUEADA (ya definida al inicio)
         * - Fecha de esta Gesti√≥n: Editable (nueva acci√≥n)
         */
        function configurarModoGestionAdicional(dataCiclo) {
            console.log('[configurarModoGestionAdicional] Configurando para gesti√≥n adicional...', dataCiclo);

            const inputEnvio = document.getElementById('gestionFechaEnvioEECC');
            const inputGestion = document.getElementById('gestionFechaGestion');
            const radioEnvioAuto = document.getElementById('fechaEnvioAuto');
            const radioEnvioManual = document.getElementById('fechaEnvioManual');
            const radioGestionHoy = document.getElementById('fechaGestionHoy');
            const radioGestionManual = document.getElementById('fechaGestionManual');
            const helpEnvio = document.getElementById('fechaEnvioHelp');
            const helpGestion = document.getElementById('fechaGestionHelp');

            // 1. Fecha Env√≠o EECC: BLOQUEADA (cargada del ciclo existente)
            radioEnvioAuto.checked = true;
            radioEnvioAuto.disabled = true;
            radioEnvioManual.disabled = true;

            // Cargar fecha del ciclo existente
            const fecha = new Date(dataCiclo.fechaEnvioEECC);
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            const hours = String(fecha.getHours()).padStart(2, '0');
            const minutes = String(fecha.getMinutes()).padStart(2, '0');
            const formatted = `${year}-${month}-${day}T${hours}:${minutes}`;

            inputEnvio.value = formatted;
            inputEnvio.setAttribute('readonly', true);
            inputEnvio.style.cursor = 'not-allowed';
            inputEnvio.style.opacity = '0.6';
            helpEnvio.textContent = 'üîí Fecha original del inicio de este ciclo (no se puede modificar)';

            // 2. Fecha de esta Gesti√≥n: Editable, por defecto = Hoy
            radioGestionHoy.checked = true;
            radioGestionHoy.disabled = false;
            radioGestionManual.disabled = false;
            inputGestion.value = getFechaLimaFormatted();
            inputGestion.removeAttribute('readonly');
            inputGestion.style.cursor = 'not-allowed';
            inputGestion.style.opacity = '0.8';
            helpGestion.textContent = 'üìÖ Fecha y hora de esta gesti√≥n de seguimiento';

            console.log('[configurarModoGestionAdicional] ‚úÖ Configurado: Env√≠o bloqueado, Gesti√≥n editable');
        }

        function onEstadoChange() {
            const estado = document.getElementById('gestionEstado').value;
            const requiredCompromiso = document.getElementById('requiredCompromiso');
            const requiredObs = document.getElementById('requiredObs');
            const groupFechaCompromiso = document.getElementById('grupoFechaCompromiso');
            const inputFechaCompromiso = document.getElementById('gestionFechaCompromiso');
            const inputObservaciones = document.getElementById('gestionObservaciones');
            const inputProximaAccion = document.getElementById('gestionProximaAccion');

            // FECHA_COMPROMISO obligatoria para COMPROMISO_PAGO y REPROGRAMADO
            if (estado === 'COMPROMISO_PAGO' || estado === 'REPROGRAMADO') {
                groupFechaCompromiso.classList.remove('hidden');
                requiredCompromiso.classList.remove('hidden');
                inputFechaCompromiso.required = true;
            } else {
                groupFechaCompromiso.classList.add('hidden');
                requiredCompromiso.classList.add('hidden');
                inputFechaCompromiso.required = false;
                inputFechaCompromiso.value = ''; // Limpiar si se oculta
            }

            // OBSERVACIONES obligatoria para derivaciones y NO_COBRABLE
            const estadosRequierenObs = ['DERIVADO_COMERCIAL', 'DERIVADO_RRHH', 'DERIVADO_RIESGOS_GENERALES', 'NO_COBRABLE'];
            if (estadosRequierenObs.includes(estado)) {
                requiredObs.classList.remove('hidden');
                inputObservaciones.required = true;
            } else {
                requiredObs.classList.add('hidden');
                inputObservaciones.required = false;
            }

            // SMART DEFAULTS (Ley de Hick/Jakob: Predecir la acci√≥n del usuario)
            if (inputProximaAccion && !inputProximaAccion.value) {
                switch (estado) {
                    case 'SIN_RESPUESTA':
                        inputProximaAccion.value = 'Reintentar contacto en 2 d√≠as';
                        break;
                    case 'EN_SEGUIMIENTO':
                        inputProximaAccion.value = 'Realizar seguimiento de gesti√≥n';
                        break;
                    case 'COMPROMISO_PAGO':
                        inputProximaAccion.value = 'Verificar cumplimiento del pago';
                        break;
                    case 'REPROGRAMADO':
                        inputProximaAccion.value = 'Confirmar nueva fecha de pago';
                        break;
                    case 'DERIVADO_COMERCIAL':
                        inputProximaAccion.value = 'Dar seguimiento con √°rea comercial';
                        break;
                    case 'CERRADO_PAGADO':
                        inputProximaAccion.value = 'Archivar gesti√≥n - Caso cerrado';
                        break;
                }
            }
        }

        /**
         * Resetea los campos de fecha a su estado inicial (sin bloqueos)
         */
        function resetearCamposFecha() {
            console.log('[resetearCamposFecha] Reseteando campos de fecha a estado inicial...');

            const inputEnvio = document.getElementById('gestionFechaEnvioEECC');
            const inputGestion = document.getElementById('gestionFechaGestion');
            const radioEnvioAuto = document.getElementById('fechaEnvioAuto');
            const radioEnvioManual = document.getElementById('fechaEnvioManual');
            const radioGestionHoy = document.getElementById('fechaGestionHoy');
            const radioGestionManual = document.getElementById('fechaGestionManual');
            const helpEnvio = document.getElementById('fechaEnvioHelp');
            const helpGestion = document.getElementById('fechaGestionHelp');

            // Habilitar todos los radio toggles
            radioEnvioAuto.disabled = false;
            radioEnvioManual.disabled = false;
            radioGestionHoy.disabled = false;
            radioGestionManual.disabled = false;

            // Resetear a modo autom√°tico
            radioEnvioAuto.checked = true;
            radioGestionHoy.checked = true;

            // Limpiar valores
            inputEnvio.value = '';
            inputGestion.value = '';

            // Quitar atributos readonly
            inputEnvio.removeAttribute('readonly');
            inputGestion.removeAttribute('readonly');

            // Resetear estilos a estado inicial
            inputEnvio.style.cursor = '';
            inputEnvio.style.opacity = '';
            inputGestion.style.cursor = '';
            inputGestion.style.opacity = '';

            // Resetear textos de ayuda
            helpEnvio.textContent = 'Fecha del env√≠o del EECC que inici√≥ este ciclo de cobranza';
            helpGestion.textContent = 'Por defecto se usa la fecha y hora actual';

            console.log('[resetearCamposFecha] ‚úÖ Campos reseteados correctamente');
        }

        function limpiarFormGestion() {
            document.getElementById('formGestion').reset();
            document.getElementById('gestionResponsable').value = '';
            document.getElementById('gestionStatus').innerHTML = '';
            document.getElementById('requiredCompromiso').classList.add('hidden');
            document.getElementById('requiredObs').classList.add('hidden');

            // Limpiar autocomplete de asegurado
            limpiarAutocomplete();

            // Resetear campos de fecha a estado inicial (sin bloqueos)
            resetearCamposFecha();
        }

        function showGestionStatus(type, message) {
            const status = document.getElementById('gestionStatus');
            const className = type === 'success' ? 'status-success' :
                type === 'error' ? 'status-error' :
                    'status-info';
            status.innerHTML = `<div class="status ${className}">${message}</div>`;
        }

        /**
         * Muestra una notificaci√≥n flotante de √©xito
         */
        function mostrarNotificacionExito(titulo, mensaje) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                min-width: 320px;
                max-width: 400px;
                animation: slideInRight 0.4s ease-out;
                font-family: var(--tp-font-family);
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem;">‚úÖ</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">${titulo}</div>
                        <div style="font-size: 0.875rem; opacity: 0.95;">${mensaje}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: transparent; border: none; color: white; font-size: 1.25rem; cursor: pointer; padding: 0; line-height: 1;">
                        √ó
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s ease-in';
                setTimeout(() => notification.remove(), 400);
            }, 5000);
        }

        /**
         * Muestra una notificaci√≥n flotante de error
         */
        function mostrarNotificacionError(titulo, mensaje) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
                z-index: 10000;
                min-width: 320px;
                max-width: 400px;
                animation: slideInRight 0.4s ease-out;
                font-family: var(--tp-font-family);
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem;">‚ùå</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">${titulo}</div>
                        <div style="font-size: 0.875rem; opacity: 0.95;">${mensaje}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: transparent; border: none; color: white; font-size: 1.25rem; cursor: pointer; padding: 0; line-height: 1;">
                        √ó
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remover despu√©s de 6 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s ease-in';
                setTimeout(() => notification.remove(), 400);
            }, 6000);
        }

        // ========== TIMELINE DEL CICLO ==========

        function verTimelineCiclo(idCiclo, asegurado) {
            console.log('[verTimelineCiclo] Abriendo timeline para asegurado:', asegurado);

            // Actualizar t√≠tulo
            document.getElementById('timelineSubtitle').textContent = `Cliente: ${asegurado}`;

            // Mostrar modal
            document.getElementById('timelineModal').classList.add('active');

            // Cargar TODAS las gestiones del asegurado (de todos sus ciclos)
            cargarTimelineAsegurado(asegurado);
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').classList.remove('active');
        }

        function cargarTimelineAsegurado(asegurado) {
            const container = document.getElementById('timelineContent');
            const ahora = Date.now();

            // ‚ö° OPTIMIZACI√ìN: Verificar si ya tenemos el timeline en cach√©
            if (TIMELINE_CACHE[asegurado]) {
                const cache = TIMELINE_CACHE[asegurado];
                const tiempoTranscurrido = ahora - cache.timestamp;

                if (tiempoTranscurrido < TIMELINE_CACHE_DURATION) {
                    console.log('[cargarTimelineAsegurado] ‚ö° Usando cach√© (', Math.round(tiempoTranscurrido / 1000), 's de antig√ºedad)');
                    renderTimeline(cache.data);

                    // Badge de cach√©
                    const badge = document.createElement('div');
                    badge.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 9999;';
                    badge.innerHTML = '‚ö° Timeline cargado desde cach√©';
                    document.body.appendChild(badge);
                    setTimeout(() => badge.remove(), 2000);

                    return;
                }
            }

            // Mostrar loader solo si no hay cach√©
            container.innerHTML = '<div class="loader" style="text-align: center; padding: 3rem;"><div class="loader-spinner"></div><p>Cargando timeline...</p></div>';

            console.log('[cargarTimelineAsegurado] üì° Cargando desde servidor para:', asegurado);

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('[cargarTimelineAsegurado] ‚úÖ Respuesta recibida:', result);

                    if (result && result.ok && result.data && result.data.length > 0) {
                        console.log('[cargarTimelineAsegurado] ‚úÖ ' + result.data.length + ' gestiones encontradas');

                        // Guardar en cach√©
                        TIMELINE_CACHE[asegurado] = {
                            data: result.data,
                            timestamp: Date.now()
                        };
                        console.log('[cargarTimelineAsegurado] üíæ Timeline guardado en cach√©');

                        renderTimeline(result.data);
                    } else {
                        console.log('[cargarTimelineAsegurado] ‚ö†Ô∏è Sin gestiones');
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--tp-text-secondary);">No se encontraron gestiones para este cliente</div>';
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('[cargarTimelineAsegurado] ‚ùå Error:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #D32F2F;">Error al cargar timeline: ' + error.message + '</div>';
                })
                .bitacoraGetGestionesPorAsegurado(asegurado, TOKEN);
        }

        function renderTimeline(gestiones) {
            const container = document.getElementById('timelineContent');

            if (!gestiones || gestiones.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--tp-text-secondary);">No hay gestiones registradas en este ciclo</div>';
                return;
            }

            // Ordenar por fecha de registro (ascendente = del m√°s antiguo al m√°s reciente)
            gestiones.sort((a, b) => new Date(a.fechaRegistro) - new Date(b.fechaRegistro));

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            // HTML del timeline
            let timelineHTML = '<div style="position: relative; padding-left: 2.5rem;">';

            // L√≠nea vertical del timeline
            timelineHTML += '<div style="position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: var(--tp-border-light);"></div>';

            gestiones.forEach((gestion, index) => {
                const fechaGestion = new Date(gestion.fechaRegistro);
                fechaGestion.setHours(0, 0, 0, 0);

                // Calcular d√≠as desde inicio del ciclo
                const fechaInicio = new Date(gestiones[0].fechaEnvioEECC);
                fechaInicio.setHours(0, 0, 0, 0);
                const diasDesdeInicio = Math.floor((fechaGestion - fechaInicio) / (1000 * 60 * 60 * 24));

                // Calcular d√≠as desde gesti√≥n anterior
                let diasDesdeAnterior = 0;
                if (index > 0) {
                    const fechaAnterior = new Date(gestiones[index - 1].fechaRegistro);
                    fechaAnterior.setHours(0, 0, 0, 0);
                    diasDesdeAnterior = Math.floor((fechaGestion - fechaAnterior) / (1000 * 60 * 60 * 24));
                }

                // √çcono seg√∫n tipo de gesti√≥n
                const iconos = {
                    'ENVIO_EECC': 'üìß',
                    'LLAMADA': 'üìû',
                    'WHATSAPP': 'üí¨',
                    'EMAIL': 'üìß',
                    'REUNION': 'üë•',
                    'NOTA': 'üìù',
                    'OTRO': 'üìå'
                };
                const icono = iconos[gestion.tipoGestion] || 'üìå';

                // Badge del estado
                const badge = getEstadoBadge(gestion.estadoGestion);

                timelineHTML += `
                    <div style="position: relative; margin-bottom: 2rem; padding-left: 1.5rem;">
                        <!-- Punto del timeline -->
                        <div style="position: absolute; left: -0.35rem; top: 0.25rem; width: 1rem; height: 1rem; border-radius: 50%; background: var(--tp-primary); border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                        
                        <!-- Contenido de la gesti√≥n -->
                        <div style="background: white; border: 1px solid var(--tp-border-light); border-radius: var(--tp-radius-lg); padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--tp-text-primary);">
                                        ${icono} ${gestion.tipoGestion.replace(/_/g, ' ')}
                                    </h4>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--tp-text-secondary);">
                                        ${formatDateTime(gestion.fechaRegistro)} ¬∑ ${diasDesdeInicio} d√≠as desde inicio
                                        ${index > 0 ? ` ¬∑ ${diasDesdeAnterior} d√≠as desde anterior` : ''}
                                    </p>
                                </div>
                                ${badge}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.875rem;">
                                <div>
                                    <strong style="color: var(--tp-text-secondary);">Responsable:</strong>
                                    <span style="color: var(--tp-text-primary);">${gestion.responsable || '-'}</span>
                                </div>
                                <div>
                                    <strong style="color: var(--tp-text-secondary);">Canal:</strong>
                                    <span style="color: var(--tp-text-primary);">${gestion.canalContacto || '-'}</span>
                                </div>
                                ${gestion.fechaCompromiso ? `
                                <div>
                                    <strong style="color: var(--tp-text-secondary);">Compromiso:</strong>
                                    <span style="color: var(--tp-text-primary);">${formatDate(gestion.fechaCompromiso)}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            ${gestion.proximaAccion ? `
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--tp-border-light);">
                                <strong style="font-size: 0.875rem; color: var(--tp-text-secondary);">Pr√≥xima acci√≥n:</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--tp-text-primary);">${gestion.proximaAccion}</p>
                            </div>
                            ` : ''}
                            
                            ${gestion.observaciones ? `
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--tp-border-light);">
                                <strong style="font-size: 0.875rem; color: var(--tp-text-secondary);">Observaciones:</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--tp-text-primary);">${gestion.observaciones}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            // Punto final: HOY
            const fechaUltimaGestion = new Date(gestiones[gestiones.length - 1].fechaRegistro);
            fechaUltimaGestion.setHours(0, 0, 0, 0);
            const diasHastaHoy = Math.floor((hoy - fechaUltimaGestion) / (1000 * 60 * 60 * 24));

            const fechaInicio = new Date(gestiones[0].fechaEnvioEECC);
            fechaInicio.setHours(0, 0, 0, 0);
            const totalDiasCiclo = Math.floor((hoy - fechaInicio) / (1000 * 60 * 60 * 24));

            timelineHTML += `
                <div style="position: relative; padding-left: 1.5rem;">
                    <div style="position: absolute; left: -0.35rem; top: 0.25rem; width: 1rem; height: 1rem; border-radius: 50%; background: var(--tp-success); border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: var(--tp-radius-lg); padding: 1rem; color: white;">
                        <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            üìç HOY
                        </h4>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; opacity: 0.9;">
                            ${formatDateTime(new Date())} ¬∑ ${diasHastaHoy} d√≠as desde √∫ltima gesti√≥n ¬∑ ${totalDiasCiclo} d√≠as total del ciclo
                        </p>
                    </div>
                </div>
            `;

            timelineHTML += '</div>';

            container.innerHTML = timelineHTML;
        }

        // ========== HELPERS ==========

        function getEstadoBadge(estado) {
            const badges = {
                'SIN_RESPUESTA': '<span class="badge" style="background-color: #FFF3E0; color: #E65100;">Sin respuesta</span>',
                'EN_SEGUIMIENTO': '<span class="badge" style="background-color: #E3F2FD; color: #1976D2;">En seguimiento</span>',
                'COMPROMISO_PAGO': '<span class="badge" style="background-color: #E3F2FD; color: #1565C0;">Compromiso pago</span>',
                'REPROGRAMADO': '<span class="badge" style="background-color: #FFF3E0; color: #F57C00;">Reprogramado</span>',
                'DERIVADO_COMERCIAL': '<span class="badge" style="background-color: #F3E5F5; color: #6A1B9A;">Derivado Comercial</span>',
                'DERIVADO_RRHH': '<span class="badge" style="background-color: #F3E5F5; color: #6A1B9A;">Derivado RRHH</span>',
                'DERIVADO_RIESGOS_GENERALES': '<span class="badge" style="background-color: #F3E5F5; color: #6A1B9A;">Derivado Riesgos</span>',
                'CERRADO_PAGADO': '<span class="badge" style="background-color: #C8E6C9; color: #1B5E20;">Cerrado/Pagado</span>',
                'NO_COBRABLE': '<span class="badge" style="background-color: #FFEBEE; color: #C62828;">No cobrable</span>'
            };
            return badges[estado] || `<span class="badge">${estado}</span>`;
        }

        function getDiasBadge(dias) {
            let color, bgColor;
            if (dias <= 7) {
                color = '#1B5E20';
                bgColor = '#C8E6C9';
            } else if (dias <= 30) {
                color = '#1565C0';
                bgColor = '#E3F2FD';
            } else if (dias <= 60) {
                color = '#F57C00';
                bgColor = '#FFF3E0';
            } else {
                color = '#C62828';
                bgColor = '#FFEBEE';
            }
            return `<span class="badge badge-dias" style="background-color: ${bgColor}; color: ${color};">${dias} d√≠as</span>`;
        }

        function formatDate(dateValue) {
            if (!dateValue) return '-';
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return '-';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateTime(dateValue) {
            if (!dateValue) return '-';
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return '-';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #C62828;">${message}</td></tr>`;
        }

        // ========== EVENT LISTENERS ==========

        document.getElementById('bitacoraModal').addEventListener('click', function (e) {
            if (e.target === this) closeBitacoraModal();
        });
        // Funci√≥n para descargar ZIP
        function downloadZip(grupoName, fileUrls) {
            const btn = document.getElementById('btnDownloadZip');
            const status = document.getElementById('zipStatus');

            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Creando ZIP...';
            if (status) status.textContent = 'Esto puede tomar unos segundos...';

            // Limpiar nombre del grupo para nombre de archivo
            const safeName = grupoName.replace(/[^a-zA-Z0-9]/g, '_');
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const zipName = `EECC_${safeName}_${dateStr}.zip`;

            google.script.run
                .withSuccessHandler(result => {
                    btn.disabled = false;
                    btn.innerHTML = 'üì¶ Descargar Todo (ZIP)';
                    if (status) status.textContent = '';

                    if (result && result.ok) {
                        window.open(result.url, '_blank');
                        showToast('ZIP creado exitosamente', 'success');
                    } else {
                        alert('Error al crear ZIP: ' + (result?.error || 'Desconocido'));
                    }
                })
                .withFailureHandler(error => {
                    btn.disabled = false;
                    btn.innerHTML = 'üì¶ Descargar Todo (ZIP)';
                    if (status) status.textContent = 'Error de conexi√≥n';
                    alert('Error fatal: ' + error.message);
                })
                .createZip_API(fileUrls, zipName, TOKEN);
        }
        /**
         * Normaliza un texto para b√∫squeda (elimina acentos y convierte a min√∫sculas)
         */
        function normalizeText(text) {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
    </script>
</body>

</html>