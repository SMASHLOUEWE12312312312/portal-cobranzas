<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      margin: 0;
    }
    
    h3 {
      margin: 0 0 16px;
      color: #212121;
      font-size: 18px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #424242;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #616161;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: #D32F2F;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #B71C1C;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    
    .status-success {
      background: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #C8E6C9;
    }
    
    .status-error {
      background: #FFEBEE;
      color: #C62828;
      border: 1px solid #FFCDD2;
    }
    
    .status-info {
      background: #E3F2FD;
      color: #1976D2;
      border: 1px solid #BBDEFB;
    }
  </style>
</head>
<body>
  <h3>Generar EECC</h3>
  
  <div class="form-group">
    <label for="asegurado">Asegurado</label>
    <select id="asegurado">
      <option value="">Cargando...</option>
    </select>
  </div>
  
  <div class="form-group">
    <label>Tipo de archivo</label>
    <div class="radio-group">
      <label class="radio-label">
        <input type="radio" name="tipo" value="both" checked>
        PDF + XLSX
      </label>
      <label class="radio-label">
        <input type="radio" name="tipo" value="pdf">
        Solo PDF
      </label>
      <label class="radio-label">
        <input type="radio" name="tipo" value="xlsx">
        Solo XLSX
      </label>
    </div>
  </div>
  
  <button id="btn" onclick="run()">Generar</button>
  
  <div id="msg"></div>
  
  <script>
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    
    function getTipoFlags() {
      const tipo = document.querySelector('input[name=tipo]:checked').value;
      return {
        exportPdf: (tipo === 'both' || tipo === 'pdf'),
        exportXlsx: (tipo === 'both' || tipo === 'xlsx')
      };
    }
    
    // Cargar asegurados al inicio
    google.script.run
      .withSuccessHandler(list => {
        const sel = document.getElementById('asegurado');
        if (!list || list.length === 0) {
          sel.innerHTML = '<option value="">No hay asegurados</option>';
          return;
        }
        sel.innerHTML = list.map(a => `<option value="${a}">${a}</option>`).join('');
      })
      .withFailureHandler(err => {
        msg.className = 'status status-error';
        msg.textContent = 'Error al cargar asegurados: ' + err.message;
      })
      .getAsegurados();
    
    function run() {
      const sel = document.getElementById('asegurado');
      const asegurado = sel.value;
      
      if (!asegurado) {
        alert('Selecciona un asegurado');
        return;
      }
      
      const { exportPdf, exportXlsx } = getTipoFlags();
      const label = exportPdf && exportXlsx ? 'PDF + XLSX' : (exportPdf ? 'PDF' : 'XLSX');
      
      msg.className = 'status status-info';
      msg.textContent = `Generando ${label} para ${asegurado}...\n\nEsto puede tomar unos minutos.`;
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(txt => {
          msg.className = 'status status-success';
          msg.textContent = txt || 'Generación completada ✅';
          btn.disabled = false;
        })
        .withFailureHandler(err => {
          msg.className = 'status status-error';
          msg.textContent = 'Error: ' + err.message;
          btn.disabled = false;
        })
        .generateForAsegurado(asegurado, { exportPdf, exportXlsx });
    }
  </script>
</body>
</html>
